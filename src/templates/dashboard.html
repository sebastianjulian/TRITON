<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mission Control TRITON</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <style>
    :root {
      /* Dark Ocean (Default) */
      --bg-primary: #0a1520;
      --bg-secondary: #1a2a3a;
      --bg-tertiary: #0f1f2f;
      --bg-card: #1f3545;
      --bg-header: #14242f;
      --color-primary: #00aaff;
      --color-secondary: #0088cc;
      --color-accent: #0066aa;
      --color-text-primary: #ffffff;
      --color-text-secondary: #e0f0ff;
      --color-text-muted: #b0c5dd;
      --color-border: #2a4050;
      --color-border-accent: #00aaff;
      --glow-primary: 0 0 20px rgba(0, 170, 255, 0.3);
      --glow-accent: 0 0 15px rgba(0, 102, 170, 0.2);
      --gradient-bg: linear-gradient(135deg, #0a1520 0%, #1a2a3a 100%);
      --gradient-card: linear-gradient(145deg, #1f3545 0%, #2a4050 100%);
    }
    
    
    [data-theme="night"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --bg-card: #1e293b;
      --bg-header: #0f172a;
      --color-primary: #f59e0b;
      --color-secondary: #d97706;
      --color-accent: #f59e0b;
      --color-text-primary: #f8fafc;
      --color-text-secondary: #e2e8f0;
      --color-text-muted: #94a3b8;
      --color-border: #475569;
      --color-border-accent: #f59e0b;
      --glow-primary: 0 0 20px rgba(245, 158, 11, 0.3);
      --glow-accent: 0 0 15px rgba(217, 119, 6, 0.2);
      --gradient-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --gradient-card: linear-gradient(145deg, #1e293b 0%, #334155 100%);
    }
    
    [data-theme="light-ocean"] {
      --bg-primary: #c2e7f7;
      --bg-secondary: #92d4ef;
      --bg-tertiary: #68c1e7;
      --bg-card: #a8dcf4;
      --bg-header: #7ac6eb;
      --color-primary: #0ea5e9;
      --color-secondary: #0284c7;
      --color-accent: #0369a1;
      --color-text-primary: #032436;
      --color-text-secondary: #05314a;
      --color-text-muted: #094358;
      --color-border: #5fb0db;
      --color-border-accent: #0ea5e9;
      --glow-primary: 0 0 20px rgba(14, 165, 233, 0.4);
      --glow-accent: 0 0 16px rgba(3, 105, 161, 0.3);
      --gradient-bg: linear-gradient(135deg, #c2e7f7 0%, #92d4ef 35%, #68c1e7 70%, #4fb6e3 100%);
      --gradient-card: linear-gradient(145deg, #a8dcf4 0%, #7ac6eb 40%, #5fb0db 80%, #4ba3d1 100%);
    }

    [data-theme="nature"] {
      /* Nature - Earthy greens and browns (High Contrast) */
      --bg-primary: #0d1a0d;
      --bg-secondary: #1a2e1a;
      --bg-tertiary: #142414;
      --bg-card: #1f3a1f;
      --bg-header: #142414;
      --color-primary: #5eff8a;
      --color-secondary: #2edd62;
      --color-accent: #98ffb8;
      --color-chart: #3cb371;
      --color-text-primary: #ffffff;
      --color-text-secondary: #d0ffd8;
      --color-text-muted: #7abf8a;
      --color-border: #2d5a2d;
      --color-border-accent: #5eff8a;
      --glow-primary: 0 0 25px rgba(94, 255, 138, 0.4);
      --glow-accent: 0 0 18px rgba(46, 221, 98, 0.3);
      --gradient-bg: linear-gradient(135deg, #0d1a0d 0%, #1a2e1a 50%, #0d1a0d 100%);
      --gradient-card: linear-gradient(145deg, #1f3a1f 0%, #2d5a2d 100%);
    }

    [data-theme="retro"] {
      /* Retro - 80s Synthwave/Neon (High Contrast) */
      --bg-primary: #0d0518;
      --bg-secondary: #1a0a2e;
      --bg-tertiary: #140a24;
      --bg-card: #2a1048;
      --bg-header: #140a24;
      --color-primary: #ff33ff;
      --color-secondary: #33ffff;
      --color-accent: #ff85d5;
      --color-chart: #cc66cc;
      --color-text-primary: #ffffff;
      --color-text-secondary: #ffe6fc;
      --color-text-muted: #d4a8e0;
      --color-border: #5a2088;
      --color-border-accent: #ff33ff;
      --glow-primary: 0 0 30px rgba(255, 51, 255, 0.6);
      --glow-accent: 0 0 25px rgba(51, 255, 255, 0.5);
      --gradient-bg: linear-gradient(135deg, #0d0518 0%, #1a0a2e 50%, #0d0518 100%);
      --gradient-card: linear-gradient(145deg, #2a1048 0%, #3d1868 50%, #2a1048 100%);
    }

    [data-theme="futuristic"] {
      /* Futuristic - Cyberpunk/Tech (High Contrast) */
      --bg-primary: #050508;
      --bg-secondary: #0a0a10;
      --bg-tertiary: #08080c;
      --bg-card: #0f0f18;
      --bg-header: #08080c;
      --color-primary: #00ffff;
      --color-secondary: #9945ff;
      --color-accent: #ff3377;
      --color-chart: #00b8b8;
      --color-text-primary: #ffffff;
      --color-text-secondary: #c0f8ff;
      --color-text-muted: #5599aa;
      --color-border: #1a1a2e;
      --color-border-accent: #00ffff;
      --glow-primary: 0 0 35px rgba(0, 255, 255, 0.5);
      --glow-accent: 0 0 25px rgba(153, 69, 255, 0.4);
      --gradient-bg: linear-gradient(135deg, #050508 0%, #0a0a10 50%, #050508 100%);
      --gradient-card: linear-gradient(145deg, #0f0f18 0%, #14142a 50%, #0f0f18 100%);
    }

    * {
      transition: color 0.4s ease, background-color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease, background 0.4s ease;
    }

    /* Theme transition animations */
    :root {
      transition: all 0.4s ease;
    }
    
    body, header, section, .chart-box {
      transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--gradient-bg);
      color: var(--color-text-primary);
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 25% 25%, var(--color-primary)10, transparent 50%),
                  radial-gradient(circle at 75% 75%, var(--color-accent)08, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .header-nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(20, 36, 47, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--color-border);
      padding: 10px 0;
      z-index: 10000;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .header-nav.scrolled {
      background: rgba(20, 36, 47, 0.98);
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.5);
    }

    /* Theme-specific navigation backgrounds */
    [data-theme="night"] .header-nav {
      background: rgba(15, 23, 42, 0.95);
    }

    [data-theme="night"] .header-nav.scrolled {
      background: rgba(15, 23, 42, 0.98);
    }

    [data-theme="light-ocean"] .header-nav {
      background: rgba(122, 198, 235, 0.95);
    }

    [data-theme="light-ocean"] .header-nav.scrolled {
      background: rgba(122, 198, 235, 0.98);
    }

    .main-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: nowrap;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 80px 0 20px;
      position: relative;
    }

    .main-nav a {
      color: var(--color-text-secondary);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9em;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid transparent;
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    .main-nav a:hover {
      color: var(--color-primary);
      background: var(--bg-card);
      border-color: var(--color-primary);
      box-shadow: var(--glow-primary);
      transform: translateY(-2px);
    }

    header {
      background: var(--bg-header);
      padding: 70px 20px 20px 20px;
      text-align: center;
      border-bottom: 2px solid var(--color-border-accent);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
    }
    
    header::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--color-primary), transparent);
      box-shadow: var(--glow-primary);
    }

    header h1 {
      margin: 0;
      font-size: 1.8em;
      color: var(--color-text-primary);
      text-shadow: var(--glow-primary);
    }

    section {
      padding: 20px 40px;
    }

    h2 {
      color: var(--color-text-primary);
      margin-top: 40px;
      font-size: 1.4em;
      border-left: 4px solid var(--color-primary);
      padding-left: 12px;
      text-shadow: var(--glow-accent);
      position: relative;
    }
    
    h2::before {
      content: '';
      position: absolute;
      left: -4px;
      top: 0;
      width: 4px;
      height: 100%;
      background: var(--color-primary);
      box-shadow: var(--glow-primary);
    }

    .grid-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 20px;
    }

    .chart-box {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--color-border);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .chart-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at top left, var(--color-primary)05, transparent 50%);
      pointer-events: none;
    }
    
    .chart-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5), var(--glow-primary);
      border-color: var(--color-primary);
    }

    .chart-box h3 {
      margin: 0 0 15px;
      text-align: center;
      font-size: 1.1em;
      color: var(--color-text-primary);
      font-weight: 600;
      text-shadow: var(--glow-accent);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .chart-header h3 {
      margin: 0;
      flex: 1;
      text-align: center;
    }

    .reset-zoom-btn {
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 0.75em;
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.7;
      font-weight: 500;
    }

    .reset-zoom-btn:hover {
      background: var(--color-primary);
      color: var(--bg-primary);
      opacity: 1;
      box-shadow: var(--glow-primary);
      border-color: var(--color-primary);
    }

    .zoom-controls {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .zoom-btn, .pan-btn {
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      width: 26px;
      height: 26px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.7;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .zoom-btn:hover, .pan-btn:hover {
      background: var(--color-primary);
      color: var(--bg-primary);
      opacity: 1;
      box-shadow: var(--glow-primary);
      border-color: var(--color-primary);
    }

    .chart-controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 2px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      padding: 3px;
      border: 1px solid var(--color-border);
    }

    .control-label {
      font-size: 0.65em;
      color: var(--color-text-muted);
      padding: 0 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .chart-controls-hint {
      font-size: 0.7em;
      color: var(--color-text-muted);
      text-align: center;
      margin-top: 8px;
      opacity: 0.7;
    }

    canvas {
      width: 100% !important;
      aspect-ratio: 1.6;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid var(--color-border);
      padding: 10px 15px;
      text-align: center;
      color: var(--color-text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }

    th {
      background: var(--gradient-card);
      color: var(--color-text-primary);
      font-weight: 600;
      text-shadow: var(--glow-accent);
    }

    .download-controls {
      margin-top: 40px;
    }

    .download-controls button,
    .download-controls select {
      margin: 10px 10px 0 0;
      padding: 8px 12px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
    }

    .download-controls button {
      background: var(--color-primary);
      color: var(--bg-primary);
      cursor: pointer;
      box-shadow: var(--glow-primary);
      border: 1px solid var(--color-primary);
      transition: all 0.3s ease;
      font-weight: 600;
    }
    
    .download-controls button:hover {
      background: var(--color-accent);
      box-shadow: var(--glow-accent);
      transform: translateY(-1px);
    }

    /* Recording Button Styles */
    .record-btn {
      background: linear-gradient(145deg, #16a34a, #15803d) !important;
      border: 1px solid #16a34a !important;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }

    .record-btn.recording {
      background: linear-gradient(145deg, #dc2626, #b91c1c) !important;
      border-color: #dc2626 !important;
      animation: pulse-recording 1.5s ease-in-out infinite;
    }

    @keyframes pulse-recording {
      0%, 100% { box-shadow: 0 0 10px rgba(220, 38, 38, 0.5); }
      50% { box-shadow: 0 0 25px rgba(220, 38, 38, 0.8); }
    }

    .record-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #fff;
    }

    .record-btn.recording .record-indicator {
      background: #fff;
      animation: blink-recording 1s ease-in-out infinite;
    }

    @keyframes blink-recording {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .recording-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 15px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      border: 1px solid var(--color-border);
      font-size: 0.9em;
    }

    .recording-status.active {
      border-color: #16a34a;
      background: rgba(22, 163, 74, 0.1);
    }

    /* Recordings List Styles */
    .recordings-section {
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--color-border);
    }

    .recordings-section h4 {
      margin: 0 0 15px 0;
      color: var(--color-text-primary);
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .recordings-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 250px;
      overflow-y: auto;
    }

    .recording-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-card);
      border-radius: 6px;
      border: 1px solid var(--color-border);
      transition: all 0.2s ease;
    }

    .recording-item:hover {
      border-color: var(--color-primary);
      background: var(--bg-secondary);
    }

    .recording-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .recording-name {
      font-weight: 500;
      color: var(--color-text-primary);
      font-size: 0.9em;
    }

    .recording-meta {
      font-size: 0.75em;
      color: var(--color-text-muted);
    }

    .recording-actions {
      display: flex;
      gap: 6px;
    }

    .recording-actions button {
      padding: 5px 10px !important;
      font-size: 0.8em !important;
      margin: 0 !important;
    }

    .recording-actions .delete-btn {
      background: #dc2626 !important;
      border-color: #dc2626 !important;
    }

    .no-recordings {
      text-align: center;
      color: var(--color-text-muted);
      padding: 20px;
      font-style: italic;
    }

    /* Recording Nav Link Indicator */
    .recording-nav-link {
      position: relative;
    }

    .recording-nav-link.is-recording::before {
      content: '';
      position: absolute;
      top: 50%;
      left: -12px;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      animation: nav-recording-pulse 1s ease-in-out infinite;
    }

    @keyframes nav-recording-pulse {
      0%, 100% { opacity: 1; box-shadow: 0 0 4px #ef4444; }
      50% { opacity: 0.5; box-shadow: 0 0 8px #ef4444; }
    }

    .recording-nav-link.is-recording {
      color: #ef4444 !important;
      border-color: #ef4444 !important;
    }

    .download-controls select {
      background: var(--bg-card);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .back-btn {
      background: var(--color-primary);
      color: var(--bg-primary);
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.3s ease;
      box-shadow: var(--glow-primary);
      border: 1px solid var(--color-primary);
    }

    .back-btn:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
      box-shadow: var(--glow-accent);
    }

    /* ==================== Motor Control Styles ==================== */
    .motor-control-section {
      padding: 20px 40px;
      margin-top: 20px;
    }

    .motor-nav-link {
      background: rgba(255, 100, 100, 0.15) !important;
      border: 1px solid #ff6b6b !important;
    }

    .motor-nav-link:hover {
      background: rgba(255, 100, 100, 0.3) !important;
      box-shadow: 0 0 15px rgba(255, 100, 100, 0.4) !important;
    }

    /* Motor Header with E-Stop and Status */
    .motor-header {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .emergency-stop-btn {
      background: #dc2626;
      color: white;
      font-size: 1.3em;
      font-weight: 800;
      padding: 24px 48px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.15s ease;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .emergency-stop-btn:hover {
      background: #ef4444;
      box-shadow: 0 6px 24px rgba(239, 68, 68, 0.5);
      transform: translateY(-2px);
    }

    .emergency-stop-btn:active {
      transform: scale(0.98) translateY(0);
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
    }

    .motor-status-bar {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 12px 20px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--color-border);
    }

    .motor-status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .motor-status-label {
      font-size: 0.8em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .motor-status-value {
      font-size: 0.95em;
      font-weight: 600;
      color: var(--color-text-primary);
      font-family: 'JetBrains Mono', monospace;
    }

    .motor-status-value.status-running {
      color: #4ade80;
    }

    .motor-status-value.status-stopped {
      color: var(--color-text-secondary);
    }

    .motor-status-value.status-emergency {
      color: #ef4444;
    }

    .motor-status-value.status-disconnected {
      color: #6b7280;
    }

    /* Main Motor Control Panel */
    .motor-main-panel {
      background: var(--gradient-card);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid var(--color-border);
    }

    /* Throttle Display */
    .throttle-display {
      text-align: center;
      margin-bottom: 20px;
    }

    .throttle-value-large {
      font-size: 3.5em;
      font-weight: 700;
      color: var(--color-primary);
      font-family: 'JetBrains Mono', monospace;
      line-height: 1;
    }

    .throttle-value-large .percent {
      font-size: 0.5em;
      color: var(--color-text-muted);
    }

    /* Throttle Slider */
    .throttle-slider-container {
      margin-bottom: 24px;
    }

    .throttle-slider {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--bg-tertiary);
      border-radius: 4px;
      outline: none;
      cursor: pointer;
    }

    .throttle-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease;
    }

    .throttle-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .throttle-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background: var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* Preset Buttons */
    .preset-buttons-row {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .preset-btn {
      flex: 1;
      padding: 14px 10px;
      font-size: 0.95em;
      font-weight: 600;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
    }

    .preset-btn:hover {
      background: var(--color-primary);
      color: var(--bg-primary);
      border-color: var(--color-primary);
    }

    .preset-btn.active {
      background: var(--color-primary);
      color: var(--bg-primary);
      border-color: var(--color-primary);
    }

    /* Action Buttons Row */
    .motor-actions-row {
      display: flex;
      gap: 10px;
    }

    .motor-action-btn {
      flex: 1;
      padding: 14px 20px;
      font-size: 0.95em;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .motor-action-btn.apply-btn {
      background: var(--color-primary);
      color: var(--bg-primary);
    }

    .motor-action-btn.apply-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .motor-action-btn.ramp-btn {
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
    }

    .motor-action-btn.ramp-btn:hover {
      background: var(--bg-secondary);
    }

    .motor-action-btn.ramp-btn.running {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }

    /* Motor section toggle chip */
    .section-toggle-chip[data-section="motor-control"] {
      background: linear-gradient(145deg, #dc2626, #b91c1c);
      border-color: #dc2626;
      color: #ffffff;
    }

    .section-toggle-chip[data-section="motor-control"]:hover {
      background: linear-gradient(145deg, #ef4444, #dc2626);
      box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
    }

    .section-toggle-chip[data-section="motor-control"].active {
      background: linear-gradient(145deg, #dc2626, #b91c1c);
      border-color: #ef4444;
      color: #ffffff;
      box-shadow: 0 0 10px rgba(220, 38, 38, 0.4);
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      .motor-header {
        flex-direction: column;
        align-items: stretch;
      }
      .motor-status-bar {
        flex-wrap: wrap;
        justify-content: center;
      }
      .preset-buttons-row {
        flex-wrap: wrap;
      }
      .preset-btn {
        min-width: calc(50% - 5px);
      }
    }

    /* Time Range Filter Styles */
    .time-filter-section {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .time-filter-section h3 {
      margin: 0 0 15px 0;
      color: var(--color-text-primary);
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .time-filter-section h3::before {
      content: '';
      width: 4px;
      height: 20px;
      background: var(--color-primary);
      border-radius: 2px;
      box-shadow: var(--glow-primary);
    }

    .time-filter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .time-preset-btn {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .time-preset-btn:hover {
      background: var(--bg-card);
      border-color: var(--color-primary);
      color: var(--color-text-primary);
      box-shadow: var(--glow-accent);
    }

    .time-preset-btn.active {
      background: var(--color-primary);
      color: var(--bg-primary);
      border-color: var(--color-primary);
      box-shadow: var(--glow-primary);
      font-weight: 600;
    }

    .time-filter-divider {
      width: 1px;
      height: 30px;
      background: var(--color-border);
      margin: 0 5px;
    }

    .custom-range-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--color-border);
    }

    .custom-range-container.active {
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
    }

    .custom-range-label {
      font-size: 0.8em;
      color: var(--color-text-muted);
      font-weight: 500;
    }

    .custom-range-input {
      width: 90px;
      padding: 6px 10px;
      background: var(--bg-secondary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85em;
      text-align: center;
    }

    .custom-range-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
    }

    .custom-range-input::placeholder {
      color: var(--color-text-muted);
      opacity: 0.6;
    }

    .apply-custom-btn {
      padding: 6px 12px;
      background: var(--color-secondary);
      color: var(--bg-primary);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .apply-custom-btn:hover {
      background: var(--color-primary);
      box-shadow: var(--glow-primary);
    }

    .time-filter-info {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--color-border);
      font-size: 0.85em;
      color: var(--color-text-muted);
    }

    .time-filter-info span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .time-filter-info .info-value {
      color: var(--color-text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    .export-filtered-btn {
      margin-left: auto;
      padding: 8px 16px;
      background: var(--color-accent);
      color: var(--color-text-primary);
      border: 1px solid var(--color-primary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .export-filtered-btn:hover {
      background: var(--color-primary);
      color: var(--bg-primary);
      box-shadow: var(--glow-primary);
    }

    .export-filtered-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .time-filter-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .time-filter-divider {
        width: 100%;
        height: 1px;
        margin: 5px 0;
      }

      .custom-range-container {
        flex-wrap: wrap;
        justify-content: center;
      }

      .time-filter-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .export-filtered-btn {
        margin-left: 0;
        width: 100%;
        justify-content: center;
      }
    }
    
    /* Theme Selector Styles */
    .theme-selector {
      position: fixed;
      top: 8px;
      right: 20px;
      z-index: 10001;
      background: var(--gradient-card);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      box-shadow: var(--glow-primary), 0 4px 15px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      width: 140px;
    }
    
    .theme-selector:hover {
      box-shadow: var(--glow-accent), 0 6px 20px rgba(0, 0, 0, 0.5);
    }
    
    .theme-dropdown {
      position: relative;
    }
    
    .theme-dropdown-btn {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-card);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .theme-dropdown-btn:hover {
      border-color: var(--color-primary);
      box-shadow: var(--glow-primary);
    }
    
    .theme-dropdown-arrow {
      font-size: 0.7em;
      transition: transform 0.3s ease;
      color: var(--color-primary);
    }
    
    .theme-dropdown.open .theme-dropdown-arrow {
      transform: rotate(180deg);
    }
    
    .theme-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--gradient-card);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      margin-top: 4px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }
    
    .theme-dropdown.open .theme-options {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .theme-button {
      width: 100%;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: #ffffff !important;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85em;
      font-weight: 500;
      text-align: left;
      border-radius: 6px;
      margin: 2px 0;
    }
    
    .theme-button:first-child {
      border-radius: 8px 8px 6px 6px;
    }
    
    .theme-button:last-child {
      border-radius: 6px 6px 8px 8px;
    }
    
    .theme-button:hover {
      background: var(--bg-tertiary);
      color: #ffffff !important;
    }
    
    .theme-button.active {
      background: var(--color-primary);
      color: #000000;
      font-weight: 600;
    }
    
    
    @media (max-width: 768px) {
      .theme-selector {
        top: 8px;
        right: 10px;
        width: 120px;
      }

      .theme-dropdown-btn {
        padding: 8px 10px;
        font-size: 0.8em;
      }

      .theme-options {
        min-width: 120px;
      }
    }

    /* Layout Preset Selector Styles */
    .layout-selector {
      display: none !important; /* DISABLED - see Disabled_Features.md */
      margin-left: 10px;
      position: relative;
    }

    .layout-dropdown {
      position: relative;
    }

    .layout-dropdown-btn {
      padding: 8px 12px;
      background: var(--bg-card);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .layout-dropdown-btn:hover {
      border-color: var(--color-primary);
      box-shadow: var(--glow-primary);
    }

    .layout-dropdown-arrow {
      font-size: 0.7em;
      transition: transform 0.3s ease;
      color: var(--color-primary);
    }

    .layout-dropdown.open .layout-dropdown-arrow {
      transform: rotate(180deg);
    }

    .layout-options {
      position: absolute;
      top: 100%;
      right: 0;
      min-width: 220px;
      background: var(--gradient-card);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      margin-top: 4px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 10002;
      max-height: 400px;
      overflow-y: auto;
    }

    .layout-dropdown.open .layout-options {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .layout-options-section {
      padding: 8px;
      border-bottom: 1px solid var(--color-border);
    }

    .layout-options-section:last-child {
      border-bottom: none;
    }

    .layout-options-title {
      font-size: 0.7em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      margin-bottom: 4px;
    }

    .layout-button {
      width: 100%;
      padding: 10px 12px;
      border: none;
      background: transparent;
      color: #ffffff !important;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85em;
      font-weight: 500;
      text-align: left;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .layout-button:hover {
      background: var(--bg-tertiary);
    }

    .layout-button.active {
      background: var(--color-primary);
      color: #000000 !important;
      font-weight: 600;
    }

    .layout-icon {
      font-size: 1.1em;
      width: 24px;
      text-align: center;
    }

    .layout-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .layout-name {
      font-weight: 500;
    }

    .layout-desc {
      font-size: 0.75em;
      color: var(--color-text-muted);
      opacity: 0.8;
    }

    .layout-button.active .layout-desc {
      color: #000000;
      opacity: 0.7;
    }

    .layout-button-delete {
      margin-left: auto;
      padding: 4px 8px;
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444 !important;
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 4px;
      font-size: 0.75em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .layout-button-delete:hover {
      background: #ef4444;
      color: #ffffff !important;
    }

    .custom-layout-section {
      padding: 8px;
      border-top: 1px solid var(--color-border);
    }

    .custom-layout-input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .custom-layout-input {
      flex: 1;
      padding: 8px 10px;
      background: var(--bg-secondary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: 0.85em;
    }

    .custom-layout-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
    }

    .custom-layout-input::placeholder {
      color: var(--color-text-muted);
    }

    .custom-layout-save-btn {
      padding: 8px 12px;
      background: var(--color-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .custom-layout-save-btn:hover {
      background: var(--color-accent);
      box-shadow: var(--glow-primary);
    }

    /* Section Toggle Styles */
    .section-toggles {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      padding: 8px;
    }

    .section-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.8em;
    }

    .section-toggle:hover {
      background: var(--bg-secondary);
    }

    .section-toggle input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--color-primary);
      cursor: pointer;
    }

    .section-toggle-label {
      color: var(--color-text-secondary);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .section-toggle.checked .section-toggle-label {
      color: var(--color-text-primary);
    }

    .grid-columns-selector {
      padding: 8px;
      border-top: 1px solid var(--color-border);
    }

    .grid-columns-label {
      font-size: 0.7em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .grid-columns-options {
      display: flex;
      gap: 4px;
    }

    .grid-col-btn {
      flex: 1;
      padding: 6px 8px;
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .grid-col-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--color-primary);
    }

    .grid-col-btn.active {
      background: var(--color-primary);
      color: var(--bg-primary);
      border-color: var(--color-primary);
    }

    /* Section Toggle Bar - Always visible below header */
    .section-toggle-bar {
      position: fixed;
      top: 0; /* At the very top */
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--color-border);
      padding: 8px 20px;
      z-index: 9000; /* Lower than header (10000) so header appears above */
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .toggle-bar-label {
      font-size: 0.75em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 4px;
      font-weight: 600;
    }

    .toggle-bar-divider {
      width: 1px;
      height: 24px;
      background: var(--color-border);
      margin: 0 8px;
    }

    .section-toggle-chip {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.75em;
      font-weight: 500;
      color: var(--color-text-muted);
      transition: all 0.2s ease;
      user-select: none;
    }

    .section-toggle-chip:hover {
      border-color: var(--color-primary);
      color: var(--color-text-secondary);
    }

    .section-toggle-chip.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: var(--bg-primary);
      font-weight: 600;
    }

    .section-toggle-chip input {
      display: none;
    }

    .toggle-all-btn {
      padding: 4px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.75em;
      font-weight: 500;
      color: var(--color-text-muted);
      transition: all 0.2s ease;
    }

    .toggle-all-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-text-secondary);
      background: var(--bg-card);
    }

    .grid-col-chips {
      display: flex;
      gap: 4px;
    }

    .grid-col-chip {
      padding: 4px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      cursor: pointer;
      font-size: 0.75em;
      font-weight: 500;
      color: var(--color-text-muted);
      transition: all 0.2s ease;
    }

    .grid-col-chip:hover {
      border-color: var(--color-primary);
      color: var(--color-text-secondary);
    }

    .grid-col-chip.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: var(--bg-primary);
      font-weight: 600;
    }

    /* Adjust header margin for toggle bar */
    header {
      margin-top: 44px;
    }

    /* Compact Section Styles */
    .layout-dense section,
    .layout-ultra-dense section {
      padding: 12px 20px;
    }

    .layout-ultra-dense section {
      padding: 8px 16px;
    }

    /* Compact Mission Control */
    .layout-dense #mission-control,
    .layout-ultra-dense #mission-control {
      padding: 10px 20px;
    }

    .layout-dense #mission-control h2,
    .layout-ultra-dense #mission-control h2 {
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .layout-dense #mission-control > div,
    .layout-ultra-dense #mission-control > div {
      gap: 10px;
    }

    .layout-dense .time-filter-section,
    .layout-ultra-dense .time-filter-section {
      padding: 12px;
      margin-top: 10px;
    }

    .layout-ultra-dense .time-filter-section {
      padding: 8px;
    }

    .layout-dense .time-filter-section h3,
    .layout-ultra-dense .time-filter-section h3 {
      font-size: 0.95em;
      margin-bottom: 8px;
    }

    .layout-dense .time-filter-controls,
    .layout-ultra-dense .time-filter-controls {
      gap: 6px;
    }

    .layout-dense .time-preset-btn,
    .layout-ultra-dense .time-preset-btn {
      padding: 5px 10px;
      font-size: 0.8em;
    }

    .layout-dense .time-filter-info,
    .layout-ultra-dense .time-filter-info {
      margin-top: 8px;
      padding-top: 8px;
      font-size: 0.8em;
      gap: 10px;
    }

    /* Compact Statistics Section */
    .layout-dense #statistics,
    .layout-ultra-dense #statistics {
      padding: 10px 20px;
    }

    .layout-dense .stats-meta-section,
    .layout-ultra-dense .stats-meta-section {
      padding: 12px;
      margin-top: 10px;
    }

    .layout-ultra-dense .stats-meta-section {
      padding: 8px;
    }

    .layout-dense .stats-meta-grid,
    .layout-ultra-dense .stats-meta-grid {
      gap: 8px;
    }

    .layout-dense .stats-meta-card,
    .layout-ultra-dense .stats-meta-card {
      padding: 8px;
      gap: 4px;
    }

    .layout-dense .stats-meta-label,
    .layout-ultra-dense .stats-meta-label {
      font-size: 0.65em;
    }

    .layout-dense .stats-meta-value,
    .layout-ultra-dense .stats-meta-value {
      font-size: 1.1em;
    }

    .layout-dense .stats-table-container,
    .layout-ultra-dense .stats-table-container {
      margin-top: 10px;
    }

    .layout-dense .extended-stats-table th,
    .layout-dense .extended-stats-table td,
    .layout-ultra-dense .extended-stats-table th,
    .layout-ultra-dense .extended-stats-table td {
      padding: 6px 5px;
      font-size: 0.75em;
    }

    /* Compact Correlation Section */
    .layout-dense #correlation,
    .layout-ultra-dense #correlation {
      padding: 10px 20px;
    }

    .layout-dense .correlation-controls,
    .layout-ultra-dense .correlation-controls {
      gap: 10px;
      padding: 10px;
    }

    /* Compact Compare/Replay Sections */
    .layout-dense #mission-compare,
    .layout-dense #mission-replay,
    .layout-ultra-dense #mission-compare,
    .layout-ultra-dense #mission-replay {
      padding: 10px 20px;
    }

    .layout-dense .comparison-controls,
    .layout-ultra-dense .comparison-controls {
      padding: 12px;
      gap: 10px;
    }

    .layout-dense .playback-section,
    .layout-ultra-dense .playback-section {
      padding: 12px;
    }

    /* Compact Configuration Section */
    .layout-dense #configuration,
    .layout-ultra-dense #configuration {
      padding: 10px 20px;
    }

    .layout-dense .config-section,
    .layout-ultra-dense .config-section {
      padding: 12px;
      margin-top: 10px;
    }

    .layout-dense .config-grid,
    .layout-ultra-dense .config-grid {
      gap: 12px;
    }

    .layout-dense .config-group,
    .layout-ultra-dense .config-group {
      padding: 10px;
    }

    .layout-dense .config-group h4,
    .layout-ultra-dense .config-group h4 {
      font-size: 0.85em;
      margin-bottom: 8px;
    }

    .layout-dense .config-row,
    .layout-ultra-dense .config-row {
      gap: 8px;
    }

    .layout-dense .config-label,
    .layout-ultra-dense .config-label {
      font-size: 0.8em;
    }

    .layout-dense .config-input,
    .layout-ultra-dense .config-input {
      padding: 6px 8px;
      font-size: 0.85em;
    }

    /* Compact Downloads Section */
    .layout-dense #downloads,
    .layout-ultra-dense #downloads {
      padding: 10px 20px;
    }

    .layout-dense .download-controls button,
    .layout-ultra-dense .download-controls button {
      padding: 6px 10px;
      font-size: 0.9em;
      margin: 5px 5px 0 0;
    }

    /* Responsive toggle bar */
    @media (max-width: 1200px) {
      .section-toggle-bar {
        padding: 6px 12px;
        gap: 6px;
      }

      .section-toggle-chip {
        padding: 3px 8px;
        font-size: 0.7em;
      }

      .grid-col-chips {
        margin-left: 0;
        margin-top: 4px;
        width: 100%;
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      .section-toggle-bar {
        top: 48px;
        padding: 6px 10px;
      }

      .toggle-bar-label {
        display: none;
      }

      .toggle-bar-divider {
        display: none;
      }
    }

    /* Section visibility transitions */
    section.hidden-section {
      display: none !important;
    }

    /* Dynamic grid classes */
    .grid-1col {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      margin-top: 20px;
    }

    .grid-3col {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-top: 20px;
    }

    .grid-4col {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    /* Compact chart styles for dense layouts */
    .grid-3col .chart-box,
    .grid-4col .chart-box {
      padding: 12px;
    }

    .grid-3col .chart-box h3,
    .grid-4col .chart-box h3 {
      font-size: 0.9em;
      margin-bottom: 8px;
    }

    .grid-4col .chart-box h3 {
      font-size: 0.8em;
      margin-bottom: 6px;
    }

    .grid-3col .chart-controls,
    .grid-4col .chart-controls {
      gap: 4px;
      margin-top: 6px;
    }

    .grid-4col .chart-controls {
      display: none; /* Hide controls in 4-col to save space */
    }

    .grid-3col .control-group,
    .grid-4col .control-group {
      padding: 2px;
    }

    .grid-3col .zoom-btn,
    .grid-3col .pan-btn {
      width: 22px;
      height: 22px;
      font-size: 0.75em;
    }

    .grid-3col canvas,
    .grid-4col canvas {
      aspect-ratio: 1.4;
    }

    .grid-4col canvas {
      aspect-ratio: 1.2;
    }

    /* Compact section spacing for dense layouts */
    .layout-dense section,
    .layout-ultra-dense section {
      padding: 12px 20px;
    }

    .layout-ultra-dense section {
      padding: 8px 16px;
    }

    .layout-dense h2,
    .layout-ultra-dense h2 {
      margin-top: 20px;
      font-size: 1.2em;
    }

    .layout-ultra-dense h2 {
      margin-top: 12px;
      font-size: 1.1em;
    }

    @media (max-width: 1400px) {
      .grid-4col {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 1100px) {
      .grid-4col {
        grid-template-columns: repeat(2, 1fr);
      }
      .grid-3col {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .layout-selector {
        margin-left: 5px;
      }

      .layout-dropdown-btn {
        padding: 6px 10px;
        font-size: 0.8em;
      }

      .layout-options {
        min-width: 200px;
        right: -50px;
      }

      .grid-3col,
      .grid-4col {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .layout-selector {
        display: none;
      }
    }

    /* Analysis Row: Correlation + Compare side by side, Statistics beneath */
    .analysis-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
      align-items: stretch; /* Stretch sections to equal height */
    }

    .analysis-row > section {
      margin-top: 0 !important;
      display: flex;
      flex-direction: column;
    }

    /* Controls stay at top */
    .analysis-row > section .correlation-controls,
    .analysis-row > section .comparison-controls {
      flex-shrink: 0;
    }

    /* Push chart boxes to bottom with auto margin */
    .analysis-row > section .correlation-chart-box,
    .analysis-row > section .comparison-chart-box {
      height: 450px;
      margin-top: auto;
    }

    .analysis-row > section .correlation-chart-box canvas,
    .analysis-row > section .comparison-chart-box canvas {
      height: 350px;
    }

    .analysis-stats-row {
      grid-column: 1 / -1;
    }

    @media (max-width: 1200px) {
      .analysis-row {
        grid-template-columns: 1fr;
      }

      .analysis-row > section .correlation-chart-box,
      .analysis-row > section .comparison-chart-box {
        margin-top: 20px;
      }
    }

    /* Super Compact Mission Replay */
    #mission-replay.super-compact {
      padding: 8px 16px !important;
    }

    #mission-replay.super-compact h2 {
      font-size: 1em;
      margin: 5px 0;
    }

    #mission-replay.super-compact .chart-controls-hint {
      display: none;
    }

    #mission-replay.super-compact .playback-mode-indicator {
      position: static;
      display: inline-flex;
      margin-bottom: 8px;
      padding: 3px 8px;
      font-size: 0.75em;
    }

    #mission-replay.super-compact .playback-section {
      padding: 10px;
    }

    #mission-replay.super-compact .playback-controls-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    #mission-replay.super-compact .playback-mission-selector {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    #mission-replay.super-compact .playback-mission-selector label {
      font-size: 0.8em;
    }

    #mission-replay.super-compact .playback-mission-selector select {
      padding: 4px 6px;
      font-size: 0.8em;
      max-width: 180px;
    }

    #mission-replay.super-compact .playback-info {
      font-size: 0.75em;
      margin-top: 4px;
    }

    #mission-replay.super-compact .playback-transport {
      gap: 4px;
    }

    #mission-replay.super-compact .playback-btn {
      width: 32px;
      height: 32px;
      font-size: 0.9em;
    }

    #mission-replay.super-compact .playback-seek-container {
      flex: 1;
      min-width: 150px;
      gap: 6px;
    }

    #mission-replay.super-compact .playback-time {
      font-size: 0.75em;
    }

    #mission-replay.super-compact .playback-options {
      gap: 8px;
    }

    #mission-replay.super-compact .playback-speed-selector {
      gap: 3px;
    }

    #mission-replay.super-compact .playback-speed-selector label {
      font-size: 0.75em;
    }

    #mission-replay.super-compact .speed-btn {
      padding: 3px 6px;
      font-size: 0.7em;
    }

    #mission-replay.super-compact .playback-loop-toggle {
      padding: 4px 8px;
      font-size: 0.75em;
    }

    #mission-replay.super-compact .playback-status {
      font-size: 0.75em;
      margin-top: 4px;
    }

    /* Super Compact Statistics Section */
    #statistics.super-compact {
      padding: 8px 16px !important;
    }

    #statistics.super-compact h2 {
      font-size: 1em;
      margin: 5px 0 8px 0;
    }

    #statistics.super-compact .stats-meta-section {
      padding: 8px;
      margin-top: 5px;
    }

    #statistics.super-compact .stats-meta-section h2 {
      font-size: 0.9em;
      margin-bottom: 6px;
    }

    #statistics.super-compact .stats-meta-grid {
      gap: 6px;
    }

    #statistics.super-compact .stats-meta-card {
      padding: 6px;
      gap: 2px;
    }

    #statistics.super-compact .stats-meta-label {
      font-size: 0.6em;
    }

    #statistics.super-compact .stats-meta-value {
      font-size: 0.95em;
    }

    #statistics.super-compact .stats-table-container {
      margin-top: 8px;
    }

    #statistics.super-compact .extended-stats-table th,
    #statistics.super-compact .extended-stats-table td {
      padding: 4px 3px;
      font-size: 0.7em;
    }

    /* Super Compact Configuration Section */
    #configuration.super-compact {
      padding: 8px 16px !important;
    }

    #configuration.super-compact h2 {
      font-size: 1em;
      margin: 5px 0;
    }

    #configuration.super-compact .chart-controls-hint {
      display: none;
    }

    #configuration.super-compact .config-section {
      padding: 10px;
      margin-top: 8px;
    }

    #configuration.super-compact .config-section h3 {
      font-size: 0.9em;
      margin-bottom: 8px;
    }

    #configuration.super-compact .config-grid {
      gap: 8px;
    }

    #configuration.super-compact .config-group {
      padding: 8px;
    }

    #configuration.super-compact .config-group h4 {
      font-size: 0.8em;
      margin-bottom: 6px;
    }

    #configuration.super-compact .config-row {
      gap: 6px;
      margin-bottom: 6px;
    }

    #configuration.super-compact .config-label {
      font-size: 0.75em;
      min-width: 100px;
    }

    #configuration.super-compact .config-input {
      padding: 4px 6px;
      font-size: 0.8em;
    }

    #configuration.super-compact .config-actions {
      gap: 6px;
      margin-top: 8px;
    }

    #configuration.super-compact .config-btn {
      padding: 5px 10px;
      font-size: 0.8em;
    }

    #configuration.super-compact .profile-section {
      padding: 10px;
      margin-top: 8px;
    }

    #configuration.super-compact .profile-section h3 {
      font-size: 0.9em;
      margin-bottom: 8px;
    }

    #configuration.super-compact .profile-controls {
      gap: 6px;
    }

    #configuration.super-compact .profile-select,
    #configuration.super-compact .profile-input {
      padding: 4px 6px;
      font-size: 0.8em;
    }

    #configuration.super-compact .profile-btn {
      padding: 4px 8px;
      font-size: 0.8em;
    }

    /* Super Compact Downloads Section */
    #downloads.super-compact {
      padding: 8px 16px !important;
    }

    #downloads.super-compact h2 {
      font-size: 1em;
      margin: 5px 0;
    }

    #downloads.super-compact .chart-controls-hint {
      display: none;
    }

    #downloads.super-compact .download-section {
      padding: 10px;
      margin-top: 8px;
    }

    #downloads.super-compact .download-section h3 {
      font-size: 0.9em;
      margin-bottom: 8px;
    }

    #downloads.super-compact .export-options {
      gap: 8px;
      padding: 8px;
    }

    #downloads.super-compact .export-checkbox-label {
      font-size: 0.8em;
      gap: 4px;
    }

    #downloads.super-compact .download-controls {
      gap: 6px;
      margin-top: 8px;
    }

    #downloads.super-compact .download-controls button {
      padding: 5px 10px;
      font-size: 0.8em;
      margin: 3px 3px 0 0;
    }

    /* Extended Statistics Styles */
    .stats-meta-section {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .stats-meta-section h2 {
      margin-top: 0;
      margin-bottom: 15px;
    }

    .stats-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .stats-meta-card {
      background: var(--bg-tertiary);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .stats-meta-card:hover {
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
      transform: translateY(-2px);
    }

    .stats-meta-label {
      font-size: 0.75em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    .stats-meta-value {
      font-size: 1.3em;
      color: var(--color-primary);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      text-shadow: var(--glow-accent);
    }

    .stats-table-container {
      overflow-x: auto;
      margin-top: 15px;
      border-radius: 12px;
      border: 1px solid var(--color-border);
      background: var(--gradient-card);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .extended-stats-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      min-width: 900px;
    }

    .extended-stats-table th,
    .extended-stats-table td {
      border: 1px solid var(--color-border);
      padding: 12px 10px;
      text-align: center;
      font-size: 0.85em;
    }

    .extended-stats-table th {
      background: var(--bg-header);
      color: var(--color-text-primary);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75em;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .extended-stats-table td {
      font-family: 'JetBrains Mono', monospace;
    }

    .extended-stats-table td:first-child {
      text-align: left;
      font-weight: 500;
      color: var(--color-text-primary);
      background: var(--bg-tertiary);
      white-space: nowrap;
    }

    .extended-stats-table tbody tr:hover {
      background: rgba(0, 170, 255, 0.05);
    }

    .extended-stats-table tbody tr:hover td:first-child {
      background: rgba(0, 170, 255, 0.1);
    }

    .stat-positive {
      color: #22c55e;
    }

    .stat-negative {
      color: #ef4444;
    }

    .stat-neutral {
      color: var(--color-text-secondary);
    }

    @media (max-width: 768px) {
      .stats-meta-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .stats-meta-card {
        padding: 12px;
      }

      .stats-meta-value {
        font-size: 1.1em;
      }

      .extended-stats-table th,
      .extended-stats-table td {
        padding: 8px 6px;
        font-size: 0.8em;
      }
    }

    /* Multi-Metric Correlation Styles */
    .correlation-controls {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .correlation-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: flex-end;
    }

    .selector-group {
      flex: 1;
      min-width: 200px;
    }

    .selector-label {
      display: block;
      font-size: 0.85em;
      color: var(--color-text-muted);
      margin-bottom: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .multi-select-container {
      position: relative;
    }

    .multi-select-btn {
      width: 100%;
      padding: 12px 15px;
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .multi-select-btn:hover {
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
    }

    .multi-select-btn .dropdown-arrow {
      font-size: 0.7em;
      color: var(--color-primary);
      transition: transform 0.3s ease;
    }

    .multi-select-container.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .multi-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      margin-top: 4px;
      max-height: 250px;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 100;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    .multi-select-container.open .multi-select-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .multi-select-option {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--color-border);
    }

    .multi-select-option:last-child {
      border-bottom: none;
    }

    .multi-select-option:hover {
      background: var(--bg-tertiary);
    }

    .multi-select-option.selected {
      background: rgba(0, 170, 255, 0.1);
    }

    .multi-select-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--color-border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .multi-select-option.selected .multi-select-checkbox {
      background: var(--color-primary);
      border-color: var(--color-primary);
    }

    .multi-select-checkbox::after {
      content: '';
      color: var(--bg-primary);
      font-size: 0.8em;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .multi-select-option.selected .multi-select-checkbox::after {
      opacity: 1;
    }

    .multi-select-option-label {
      flex: 1;
      font-size: 0.85em;
      color: var(--color-text-secondary);
    }

    .multi-select-option-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .correlation-update-btn {
      padding: 12px 24px;
      background: var(--color-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--glow-primary);
    }

    .correlation-update-btn:hover {
      background: var(--color-secondary);
      transform: translateY(-2px);
    }

    .correlation-clear-btn {
      padding: 12px 20px;
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .correlation-clear-btn:hover {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }

    .correlation-chart-box {
      min-height: 400px;
    }

    .correlation-chart-box canvas {
      height: 350px;
      width: 100%;
    }

    .correlation-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--color-border);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8em;
      color: var(--color-text-secondary);
      padding: 5px 10px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      border: 1px solid var(--color-border);
    }

    .legend-line {
      width: 25px;
      height: 3px;
      border-radius: 2px;
    }

    .legend-line.dashed {
      background: repeating-linear-gradient(
        90deg,
        currentColor 0px,
        currentColor 5px,
        transparent 5px,
        transparent 10px
      );
      height: 3px;
    }

    .legend-axis-label {
      font-size: 0.7em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      padding: 2px 6px;
      background: var(--bg-secondary);
      border-radius: 3px;
    }

    @media (max-width: 768px) {
      .correlation-selector {
        flex-direction: column;
      }

      .selector-group {
        width: 100%;
      }

      .correlation-update-btn,
      .correlation-clear-btn {
        width: 100%;
      }

      .correlation-chart-box canvas {
        height: 280px;
      }
    }

    /* 3D Orientation Visualization Styles */
    #orientation-3d {
      background: var(--gradient-card);
      border-radius: 12px;
      padding: 20px;
    }

    .orientation-container {
      display: grid;
      grid-template-columns: 1fr 200px;
      gap: 20px;
      min-height: 350px;
    }

    .orientation-canvas-wrapper {
      position: relative;
      background: var(--bg-tertiary);
      border-radius: 10px;
      border: 1px solid var(--color-border);
      overflow: hidden;
      min-height: 300px;
    }

    .orientation-canvas-wrapper canvas {
      display: block;
      width: 100% !important;
      height: 100% !important;
    }

    .orientation-controls-panel {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .orientation-readings {
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid var(--color-border);
    }

    .orientation-readings h4 {
      margin: 0 0 12px 0;
      font-size: 0.9em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .orientation-value {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border);
    }

    .orientation-value:last-child {
      border-bottom: none;
    }

    .orientation-label {
      font-size: 0.85em;
      color: var(--color-text-secondary);
    }

    .orientation-number {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1em;
      font-weight: 600;
      color: var(--color-primary);
      min-width: 80px;
      text-align: right;
    }

    .orientation-number.pitch { color: #ff6b6b; }
    .orientation-number.roll { color: #4ecdc4; }
    .orientation-number.yaw { color: #ffd93d; }

    .orientation-gyro-readings {
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid var(--color-border);
    }

    .orientation-gyro-readings h4 {
      margin: 0 0 12px 0;
      font-size: 0.9em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .gyro-value {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      font-size: 0.85em;
    }

    .gyro-label {
      color: var(--color-text-secondary);
    }

    .gyro-number {
      font-family: 'JetBrains Mono', monospace;
      color: var(--color-text-primary);
    }

    .orientation-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .orientation-btn {
      padding: 10px 15px;
      background: var(--bg-secondary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .orientation-btn:hover {
      background: var(--color-primary);
      border-color: var(--color-primary);
    }

    .orientation-btn.reset {
      background: var(--bg-card);
    }

    .orientation-btn.reset:hover {
      background: #ef4444;
      border-color: #ef4444;
    }

    .orientation-status {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.8em;
      color: var(--color-text-muted);
      text-align: center;
    }

    .orientation-status.active {
      background: rgba(0, 170, 255, 0.15);
      color: var(--color-primary);
      border: 1px solid rgba(0, 170, 255, 0.3);
    }

    @media (max-width: 900px) {
      .orientation-container {
        grid-template-columns: 1fr;
        grid-template-rows: 250px auto;
      }

      .orientation-controls-panel {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .orientation-actions {
        grid-column: 1 / -1;
        flex-direction: row;
      }

      .orientation-btn {
        flex: 1;
      }
    }

    @media (max-width: 600px) {
      .orientation-controls-panel {
        grid-template-columns: 1fr;
      }

      .orientation-actions {
        flex-direction: column;
      }
    }

    /* Chart Export Styles */
    .chart-export-controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .export-options-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .export-checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      background: var(--bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
      color: var(--color-text-secondary);
    }

    .export-checkbox-label:hover {
      border-color: var(--color-primary);
      background: var(--bg-card);
    }

    .export-checkbox-label input[type="checkbox"] {
      display: none;
    }

    .export-checkbox-custom {
      width: 20px;
      height: 20px;
      border: 2px solid var(--color-border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .export-checkbox-label input[type="checkbox"]:checked + .export-checkbox-custom {
      background: var(--color-primary);
      border-color: var(--color-primary);
    }

    .export-checkbox-custom::after {
      content: '';
      color: var(--bg-primary);
      font-size: 0.85em;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .export-checkbox-label input[type="checkbox"]:checked + .export-checkbox-custom::after {
      opacity: 1;
    }

    .export-format-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .export-format-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .export-format-select {
      padding: 10px 15px;
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      min-width: 180px;
      transition: all 0.3s ease;
    }

    .export-format-select:hover,
    .export-format-select:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: var(--glow-accent);
    }

    .export-actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 5px;
    }

    .export-chart-btn {
      padding: 12px 24px;
      background: var(--color-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--glow-primary);
    }

    .export-chart-btn:hover {
      background: var(--color-secondary);
      transform: translateY(-2px);
    }

    .export-chart-btn.secondary {
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      box-shadow: none;
    }

    .export-chart-btn.secondary:hover {
      background: var(--bg-card);
      border-color: var(--color-primary);
      color: var(--color-text-primary);
    }

    .export-chart-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .export-status {
      font-size: 0.85em;
      color: var(--color-text-muted);
      min-height: 20px;
    }

    .export-status.success {
      color: #22c55e;
    }

    .export-status.error {
      color: #ef4444;
    }

    /* Export Format Cards */
    .export-format-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .export-format-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .export-format-card:hover {
      border-color: var(--color-primary);
      background: var(--bg-card);
      transform: translateY(-3px);
      box-shadow: var(--glow-primary);
    }

    .export-format-icon {
      font-size: 1.8em;
      font-weight: bold;
      color: var(--color-primary);
      margin-bottom: 10px;
      font-family: monospace;
    }

    .export-format-name {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--color-text-primary);
      margin-bottom: 5px;
    }

    .export-format-desc {
      font-size: 0.8em;
      color: var(--color-text-muted);
      line-height: 1.3;
    }

    .export-time-range-row {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .export-range-preview {
      font-size: 0.85em;
      color: var(--color-text-muted);
      background: var(--bg-tertiary);
      padding: 5px 12px;
      border-radius: 6px;
      border: 1px solid var(--color-border);
    }

    @media (max-width: 600px) {
      .export-format-grid {
        grid-template-columns: 1fr;
      }

      .export-format-card {
        padding: 15px;
      }
    }

    .export-status.progress {
      color: var(--color-primary);
    }

    @media (max-width: 768px) {
      .export-options-grid {
        flex-direction: column;
      }

      .export-checkbox-label {
        width: 100%;
      }

      .export-format-row {
        flex-direction: column;
      }

      .export-format-select {
        width: 100%;
      }

      .export-actions-row {
        flex-direction: column;
      }

      .export-chart-btn {
        width: 100%;
      }
    }

    /* Mission Comparison Styles */
    .comparison-controls {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .comparison-selectors {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .mission-selector-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mission-select {
      padding: 12px 15px;
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mission-select:hover,
    .mission-select:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: var(--glow-accent);
    }

    .mission-select option {
      background: var(--bg-card);
      color: var(--color-text-primary);
    }

    .mission-info {
      font-size: 0.8em;
      color: var(--color-text-muted);
      min-height: 1.2em;
    }

    .mission-info.loaded {
      color: var(--color-primary);
    }

    .comparison-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .comparison-btn {
      padding: 12px 24px;
      background: var(--color-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--glow-primary);
    }

    .comparison-btn:hover {
      background: var(--color-secondary);
      transform: translateY(-2px);
    }

    .comparison-btn.secondary {
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      box-shadow: none;
    }

    .comparison-btn.secondary:hover {
      background: var(--bg-card);
      border-color: var(--color-primary);
      color: var(--color-text-primary);
    }

    .comparison-checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: var(--bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
      color: var(--color-text-secondary);
    }

    .comparison-checkbox-label:hover {
      border-color: var(--color-primary);
    }

    .comparison-checkbox-label input[type="checkbox"] {
      display: none;
    }

    .comparison-status {
      font-size: 0.85em;
      color: var(--color-text-muted);
      min-height: 20px;
      margin-bottom: 15px;
    }

    .comparison-status.loading {
      color: var(--color-primary);
    }

    .comparison-status.error {
      color: #ef4444;
    }

    .comparison-status.success {
      color: #22c55e;
    }

    .comparison-chart-box {
      min-height: 400px;
    }

    .comparison-chart-box canvas {
      height: 350px;
      width: 100%;
    }

    /* Mission Replay/Playback Styles */
    .playback-section {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .playback-mode-indicator {
      position: fixed;
      top: 60px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      z-index: 10001;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .playback-mode-indicator.live {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .playback-mode-indicator.playback {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .playback-mode-indicator .mode-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .playback-controls-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .playback-mission-selector {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .playback-mission-selector label {
      font-weight: 500;
      color: var(--color-text-secondary);
    }

    .playback-mission-selector select {
      flex: 1;
      min-width: 250px;
      max-width: 400px;
      padding: 12px 15px;
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .playback-mission-selector select:hover,
    .playback-mission-selector select:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: var(--glow-accent);
    }

    .playback-mission-selector select option {
      background: var(--bg-card);
      color: var(--color-text-primary);
    }

    .playback-transport {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .playback-btn {
      width: 48px;
      height: 48px;
      border: none;
      border-radius: 50%;
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      font-size: 1.2em;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--color-border);
    }

    .playback-btn:hover {
      background: var(--color-primary);
      color: var(--bg-primary);
      transform: scale(1.1);
      box-shadow: var(--glow-primary);
    }

    .playback-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .playback-btn:disabled:hover {
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      box-shadow: none;
    }

    .playback-btn.play-btn {
      width: 56px;
      height: 56px;
      font-size: 1.4em;
      background: var(--color-primary);
      color: var(--bg-primary);
    }

    .playback-btn.play-btn:hover {
      background: var(--color-secondary);
    }

    .playback-btn.active {
      background: var(--color-primary);
      color: var(--bg-primary);
    }

    .playback-seek-container {
      display: flex;
      align-items: center;
      gap: 15px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .playback-time {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9em;
      color: var(--color-text-secondary);
      min-width: 70px;
      text-align: center;
    }

    .playback-seek {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      outline: none;
      cursor: pointer;
      border: 1px solid var(--color-border);
    }

    .playback-seek::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .playback-seek::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: var(--glow-primary);
    }

    .playback-seek::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color-primary);
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }

    .playback-options {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .playback-speed-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .playback-speed-selector label {
      font-size: 0.9em;
      color: var(--color-text-muted);
    }

    .speed-btn {
      padding: 6px 12px;
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.2s ease;
    }

    .speed-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-text-primary);
    }

    .speed-btn.active {
      background: var(--color-primary);
      color: var(--bg-primary);
      border-color: var(--color-primary);
    }

    .playback-loop-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
      color: var(--color-text-secondary);
    }

    .playback-loop-toggle:hover {
      border-color: var(--color-primary);
    }

    .playback-loop-toggle.active {
      background: var(--color-primary);
      color: var(--bg-primary);
      border-color: var(--color-primary);
    }

    .playback-loop-toggle input {
      display: none;
    }

    .playback-status {
      text-align: center;
      font-size: 0.85em;
      color: var(--color-text-muted);
      min-height: 20px;
    }

    .playback-status.active {
      color: var(--color-primary);
    }

    .return-live-btn {
      padding: 12px 24px;
      background: #22c55e;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
    }

    .return-live-btn:hover {
      background: #16a34a;
      transform: translateY(-2px);
    }

    .playback-info {
      font-size: 0.8em;
      color: var(--color-text-muted);
      margin-top: 5px;
    }

    .playback-info.loaded {
      color: var(--color-primary);
    }

    .comparison-stats-section {
      margin-top: 30px;
    }

    .comparison-stats-section h3 {
      margin-bottom: 15px;
    }

    .comparison-stats-table td.positive {
      color: #22c55e;
    }

    .comparison-stats-table td.negative {
      color: #ef4444;
    }

    .comparison-stats-table td.neutral {
      color: var(--color-text-muted);
    }

    @media (max-width: 768px) {
      .comparison-selectors {
        grid-template-columns: 1fr;
      }

      .comparison-actions {
        flex-direction: column;
      }

      .comparison-btn,
      .comparison-checkbox-label {
        width: 100%;
        justify-content: center;
      }

      .comparison-chart-box canvas {
        height: 280px;
      }
    }

    /* Configuration UI Styles */
    .config-section {
      background: var(--gradient-card);
      padding: 25px;
      border-radius: 16px;
      margin: 20px 0;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .config-section h3 {
      margin: 0 0 20px 0;
      color: var(--color-text-primary);
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .config-section h3::before {
      content: '';
      width: 4px;
      height: 20px;
      background: var(--color-primary);
      border-radius: 2px;
      box-shadow: var(--glow-primary);
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .config-group {
      background: var(--bg-tertiary);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--color-border);
    }

    .config-group h4 {
      margin: 0 0 15px 0;
      color: var(--color-primary);
      font-size: 0.95em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .config-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--color-border);
    }

    .config-row:last-child {
      border-bottom: none;
    }

    .config-label {
      font-size: 0.9em;
      color: var(--color-text-secondary);
      font-weight: 500;
    }

    .config-input {
      width: 120px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 0.9em;
      font-family: 'JetBrains Mono', monospace;
      text-align: right;
      transition: all 0.3s ease;
    }

    .config-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
    }

    .config-input:hover {
      border-color: var(--color-primary);
    }

    .config-unit {
      font-size: 0.8em;
      color: var(--color-text-muted);
      margin-left: 8px;
      min-width: 50px;
    }

    .config-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--color-border);
    }

    .config-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .config-btn.primary {
      background: var(--color-primary);
      color: var(--bg-primary);
      border-color: var(--color-primary);
    }

    .config-btn.primary:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
      box-shadow: var(--glow-primary);
    }

    .config-btn.secondary {
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border-color: var(--color-border);
    }

    .config-btn.secondary:hover {
      border-color: var(--color-primary);
      color: var(--color-text-primary);
    }

    .config-btn.danger {
      background: transparent;
      color: #ef4444;
      border-color: #ef4444;
    }

    .config-btn.danger:hover {
      background: #ef4444;
      color: white;
    }

    .config-status {
      font-size: 0.85em;
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }

    .config-status.success {
      display: block;
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .config-status.error {
      display: block;
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Profile Management Styles */
    .profile-section {
      margin-top: 20px;
    }

    .profile-controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .profile-select {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      background: var(--bg-secondary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .profile-select:focus {
      outline: none;
      border-color: var(--color-primary);
    }

    .profile-select option {
      background: var(--bg-secondary);
      color: var(--color-text-primary);
    }

    .profile-name-input {
      width: 200px;
      padding: 10px 14px;
      background: var(--bg-secondary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }

    .profile-name-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
    }

    .profile-name-input::placeholder {
      color: var(--color-text-muted);
    }

    @media (max-width: 768px) {
      .config-grid {
        grid-template-columns: 1fr;
      }

      .config-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .config-input {
        width: 100%;
        text-align: left;
      }

      .config-actions {
        flex-direction: column;
      }

      .config-btn {
        width: 100%;
        text-align: center;
      }

      .profile-controls {
        flex-direction: column;
      }

      .profile-select,
      .profile-name-input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-nav">
      <nav class="main-nav">
        <a href="/"> Back to Homepage</a>
        <a href="#motor-control" class="motor-nav-link">Motor Control</a>
        <a href="#mission-control">Mission Control</a>
        <a href="#mission-control" class="recording-nav-link" id="recordingNavLink">Recording</a>
        <a href="#bme280">BME280 Data</a>
        <a href="#mpu6050">MPU6050 Data</a>
        <a href="#correlation">Correlation</a>
        <a href="#mission-compare">Compare</a>
        <a href="#mission-replay">Replay</a>
        <a href="#statistics">Statistics</a>
        <a href="#configuration">Config</a>
        <a href="#downloads">Downloads</a>
        <!-- Theme Selector -->
        <div class="theme-selector">
          <div class="theme-dropdown">
            <button class="theme-dropdown-btn">
              <span class="theme-current">Dark Ocean</span>
              <span class="theme-dropdown-arrow"></span>
            </button>
            <div class="theme-options">
              <div class="theme-button active" data-theme="dark-ocean">Dark Ocean</div>
              <div class="theme-button" data-theme="night">Night</div>
              <div class="theme-button" data-theme="light-ocean">Light Ocean</div>
              <div class="theme-button" data-theme="nature">Nature</div>
              <div class="theme-button" data-theme="retro">Retro</div>
              <div class="theme-button" data-theme="futuristic">Futuristic</div>
            </div>
          </div>
        </div>
        <!-- Layout Preset Selector -->
        <div class="layout-selector">
          <div class="layout-dropdown">
            <button class="layout-dropdown-btn">
              <span class="layout-current">Full Dashboard</span>
              <span class="layout-dropdown-arrow"></span>
            </button>
            <div class="layout-options">
              <div class="layout-options-section">
                <div class="layout-options-title">Dense Layouts (less scrolling)</div>
                <div class="layout-button" data-layout="dense-3col">
                  <span class="layout-icon">&#9638;</span>
                  <span class="layout-info">
                    <span class="layout-name">Dense (3 columns)</span>
                    <span class="layout-desc">3 charts per row</span>
                  </span>
                </div>
                <div class="layout-button" data-layout="ultra-dense-4col">
                  <span class="layout-icon">&#9641;</span>
                  <span class="layout-info">
                    <span class="layout-name">Ultra Dense (4 columns)</span>
                    <span class="layout-desc">4 charts per row</span>
                  </span>
                </div>
                <div class="layout-button" data-layout="all-sensors-3col">
                  <span class="layout-icon">&#128200;</span>
                  <span class="layout-info">
                    <span class="layout-name">All Sensors (3 col)</span>
                    <span class="layout-desc">All 11 charts compact</span>
                  </span>
                </div>
              </div>
              <div class="layout-options-section">
                <div class="layout-options-title">Standard Layouts</div>
                <div class="layout-button active" data-layout="full-dashboard">
                  <span class="layout-icon">&#128421;</span>
                  <span class="layout-info">
                    <span class="layout-name">Full Dashboard</span>
                    <span class="layout-desc">All sections, 2 columns</span>
                  </span>
                </div>
                <div class="layout-button" data-layout="mission-overview">
                  <span class="layout-icon">&#128640;</span>
                  <span class="layout-info">
                    <span class="layout-name">Mission Overview</span>
                    <span class="layout-desc">Essential monitoring</span>
                  </span>
                </div>
                <div class="layout-button" data-layout="environmental-focus">
                  <span class="layout-icon">&#127754;</span>
                  <span class="layout-info">
                    <span class="layout-name">Environmental Focus</span>
                    <span class="layout-desc">BME280 deep dive</span>
                  </span>
                </div>
                <div class="layout-button" data-layout="navigation-focus">
                  <span class="layout-icon">&#129517;</span>
                  <span class="layout-info">
                    <span class="layout-name">Navigation Focus</span>
                    <span class="layout-desc">MPU6050 inertial data</span>
                  </span>
                </div>
                <div class="layout-button" data-layout="analysis-mode">
                  <span class="layout-icon">&#128202;</span>
                  <span class="layout-info">
                    <span class="layout-name">Analysis Mode</span>
                    <span class="layout-desc">Post-mission review</span>
                  </span>
                </div>
                <div class="layout-button" data-layout="compact">
                  <span class="layout-icon">&#128241;</span>
                  <span class="layout-info">
                    <span class="layout-name">Compact</span>
                    <span class="layout-desc">Minimal monitoring</span>
                  </span>
                </div>
                <div class="layout-button" data-layout="wide-charts">
                  <span class="layout-icon">&#128250;</span>
                  <span class="layout-info">
                    <span class="layout-name">Wide Charts</span>
                    <span class="layout-desc">Full-width charts</span>
                  </span>
                </div>
              </div>
              <div class="layout-options-section">
                <div class="layout-options-title">Toggle Sections</div>
                <div class="section-toggles" id="sectionToggles">
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="mission-control" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">Mission Control</span>
                  </label>
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="bme280" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">BME280</span>
                  </label>
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="mpu6050" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">MPU6050</span>
                  </label>
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="correlation" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">Correlation</span>
                  </label>
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="mission-compare" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">Compare</span>
                  </label>
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="mission-replay" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">Replay</span>
                  </label>
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="statistics" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">Statistics</span>
                  </label>
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="configuration" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">Config</span>
                  </label>
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="orientation-3d" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">3D Orient</span>
                  </label>
                  <label class="section-toggle checked">
                    <input type="checkbox" data-section="downloads" checked onchange="layoutManager.toggleSection(this)">
                    <span class="section-toggle-label">Downloads</span>
                  </label>
                </div>
              </div>
              <div class="grid-columns-selector">
                <div class="grid-columns-label">Chart Columns</div>
                <div class="grid-columns-options">
                  <button class="grid-col-btn" data-cols="1" onclick="layoutManager.setGridColumns(1)">1</button>
                  <button class="grid-col-btn active" data-cols="2" onclick="layoutManager.setGridColumns(2)">2</button>
                  <button class="grid-col-btn" data-cols="3" onclick="layoutManager.setGridColumns(3)">3</button>
                  <button class="grid-col-btn" data-cols="4" onclick="layoutManager.setGridColumns(4)">4</button>
                </div>
              </div>
              <div class="layout-options-section" id="customLayoutsSection" style="display: none;">
                <div class="layout-options-title">Custom Layouts</div>
                <div id="customLayoutsList"></div>
              </div>
              <div class="custom-layout-section">
                <div class="custom-layout-input-row">
                  <input type="text" class="custom-layout-input" id="customLayoutName" placeholder="Save current as...">
                  <button class="custom-layout-save-btn" onclick="layoutManager.saveCustomLayout()">Save</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </div>
    <h1 style="margin: 60px 0 0 0;">Mission Control TRITON</h1>
  </header>

  <!-- Section Toggle Bar -->
  <div class="section-toggle-bar" id="sectionToggleBar">
    <span class="toggle-bar-label">Sections:</span>
    <button class="toggle-all-btn" onclick="layoutManager.selectAllSections()">All</button>
    <button class="toggle-all-btn" onclick="layoutManager.deselectAllSections()">None</button>
    <div class="toggle-bar-divider"></div>
    <label class="section-toggle-chip active" data-section="motor-control">
      <input type="checkbox" checked>
      Motor
    </label>
    <label class="section-toggle-chip active" data-section="mission-control">
      <input type="checkbox" checked>
      Control
    </label>
    <label class="section-toggle-chip active" data-section="bme280">
      <input type="checkbox" checked>
      BME280
    </label>
    <label class="section-toggle-chip active" data-section="mpu6050">
      <input type="checkbox" checked>
      MPU6050
    </label>
    <label class="section-toggle-chip active" data-section="correlation">
      <input type="checkbox" checked>
      Correlation
    </label>
    <label class="section-toggle-chip active" data-section="mission-compare">
      <input type="checkbox" checked>
      Compare
    </label>
    <label class="section-toggle-chip active" data-section="mission-replay">
      <input type="checkbox" checked>
      Replay
    </label>
    <label class="section-toggle-chip active" data-section="statistics">
      <input type="checkbox" checked>
      Stats
    </label>
    <label class="section-toggle-chip active" data-section="configuration">
      <input type="checkbox" checked>
      Config
    </label>
    <label class="section-toggle-chip active" data-section="orientation-3d">
      <input type="checkbox" checked>
      3D Orient
    </label>
    <label class="section-toggle-chip active" data-section="downloads">
      <input type="checkbox" checked>
      Downloads
    </label>
    <div class="toggle-bar-divider"></div>
    <span class="toggle-bar-label">Columns:</span>
    <div class="grid-col-chips">
      <span class="grid-col-chip" data-cols="1">1</span>
      <span class="grid-col-chip" data-cols="2">2</span>
      <span class="grid-col-chip" data-cols="3">3</span>
      <span class="grid-col-chip active" data-cols="4">4</span>
    </div>
  </div>

  <!-- Motor Control Section -->
  <section id="motor-control" class="motor-control-section">
    <h2>Motor Control</h2>

    <!-- Header: E-Stop + Status Bar -->
    <div class="motor-header">
      <button id="emergencyStopBtn" class="emergency-stop-btn" onclick="emergencyStop()">
        EMERGENCY STOP
      </button>
      <div class="motor-status-bar">
        <div class="motor-status-item">
          <span class="motor-status-label">Status</span>
          <span id="motorStatusText" class="motor-status-value">Disconnected</span>
        </div>
        <div class="motor-status-item">
          <span class="motor-status-label">Throttle</span>
          <span id="currentThrottle" class="motor-status-value">0%</span>
        </div>
        <div class="motor-status-item">
          <span class="motor-status-label">Connection</span>
          <span id="loraConnection" class="motor-status-value">Checking...</span>
        </div>
      </div>
    </div>

    <!-- Main Control Panel -->
    <div class="motor-main-panel">
      <!-- Large Throttle Display -->
      <div class="throttle-display">
        <span class="throttle-value-large"><span id="throttleValue">0</span><span class="percent">%</span></span>
      </div>

      <!-- Slider -->
      <div class="throttle-slider-container">
        <input type="range" id="throttleSlider" class="throttle-slider" min="0" max="100" value="0" oninput="updateThrottleDisplay(this.value)">
      </div>

      <!-- Preset Buttons -->
      <div class="preset-buttons-row">
        <button class="preset-btn" onclick="setMotorPreset(0)" data-preset="0">0%</button>
        <button class="preset-btn" onclick="setMotorPreset(25)" data-preset="25">25%</button>
        <button class="preset-btn" onclick="setMotorPreset(50)" data-preset="50">50%</button>
        <button class="preset-btn" onclick="setMotorPreset(75)" data-preset="75">75%</button>
      </div>

      <!-- Action Buttons -->
      <div class="motor-actions-row">
        <button class="motor-action-btn apply-btn" onclick="applyThrottle()">Apply Throttle</button>
        <button id="rampTestBtn" class="motor-action-btn ramp-btn" onclick="runRampTest()">Ramp Test</button>
      </div>
    </div>
  </section>

  <!-- Mission Control Section -->
  <section id="mission-control" class="download-controls">
    <h2>Mission Control</h2>
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <button id="startStopBtn" onclick="toggleDataGeneration()">Start Test Data</button>
      <select id="speedSelect" onchange="updateSpeed()" style="background-color: #1c1d22; color: #f0f0f0; border: 1px solid #333; padding: 8px 12px; border-radius: 6px;">
        <option value="0.5">0.5x Speed (4s)</option>
        <option value="1">1x Speed (2s)</option>
        <option value="2">2x Speed (1s)</option>
        <option value="5">5x Speed (0.4s)</option>
        <option value="10" selected>10x Speed (0.2s)</option>
      </select>
      <button id="clearBtn" onclick="clearTestData()" style="background-color: #ef4444;">Clear Data</button>

      <div style="border-left: 2px solid var(--color-border); height: 30px; margin: 0 10px;"></div>

      <button id="recordBtn" class="record-btn" onclick="toggleRecording()">
        <span class="record-indicator"></span>
        <span id="recordBtnText">Start Recording</span>
      </button>

      <div id="recordingStatus" class="recording-status" style="display: none;">
        <span id="recordingTime">00:00</span>
        <span id="recordingPoints">0 points</span>
      </div>
    </div>
    <div style="margin-top: 10px;">
      <span id="generateStatus" style="color: #38bdf8;"></span>
    </div>

    <!-- Recordings List -->
    <div class="recordings-section">
      <h4>Saved Recordings</h4>
      <div id="recordingsList" class="recordings-list">
        <div class="no-recordings">No recordings yet. Click "Start Recording" to begin.</div>
      </div>
      <button onclick="refreshRecordingsList()" style="margin-top: 10px; background: var(--bg-secondary);">Refresh List</button>
    </div>

    <!-- Time Range Filter -->
    <div class="time-filter-section">
      <h3>Time Range Filter</h3>
      <div class="time-filter-controls">
        <button class="time-preset-btn active" data-preset="all" onclick="setTimeFilter('all')">All Data</button>
        <button class="time-preset-btn" data-preset="30" onclick="setTimeFilter(30)">Last 30s</button>
        <button class="time-preset-btn" data-preset="60" onclick="setTimeFilter(60)">Last 1min</button>
        <button class="time-preset-btn" data-preset="300" onclick="setTimeFilter(300)">Last 5min</button>

        <div class="time-filter-divider"></div>

        <div class="custom-range-container" id="customRangeContainer">
          <span class="custom-range-label">Custom:</span>
          <input type="number" class="custom-range-input" id="customFromTime" placeholder="From (s)" min="0" step="0.1">
          <span class="custom-range-label">to</span>
          <input type="number" class="custom-range-input" id="customToTime" placeholder="To (s)" min="0" step="0.1">
          <button class="apply-custom-btn" onclick="applyCustomRange()">Apply</button>
        </div>
      </div>

      <div class="time-filter-info">
        <span>Total points: <span class="info-value" id="totalPointsCount">0</span></span>
        <span>Filtered points: <span class="info-value" id="filteredPointsCount">0</span></span>
        <span>Time range: <span class="info-value" id="currentTimeRange">All</span></span>
      </div>
    </div>
  </section>

  <!-- BME280 Section -->
  <section id="bme280">
    <h2>BME280 Sensor</h2>
    <p class="chart-controls-hint">Use controls below each chart to zoom and pan  Drag to select zoom area  Click legend to toggle</p>
    <div class="grid-2col">
      <div class="chart-box">
        <h3>Temperature [C]</h3>
        <canvas id="Temp_BME280 [C]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Temp_BME280 [C]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Temp_BME280 [C]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Temp_BME280 [C]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Temp_BME280 [C]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Temp_BME280 [C]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Temp_BME280 [C]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Temp_BME280 [C]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Humidity [%]</h3>
        <canvas id="Hum [%]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Hum [%]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Hum [%]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Hum [%]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Hum [%]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Hum [%]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Hum [%]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Hum [%]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Pressure [hPa]</h3>
        <canvas id="Press [hPa]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Press [hPa]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Press [hPa]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Press [hPa]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Press [hPa]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Press [hPa]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Press [hPa]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Press [hPa]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Altitude [m]</h3>
        <canvas id="Alt [m]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Alt [m]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Alt [m]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Alt [m]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Alt [m]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Alt [m]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Alt [m]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Alt [m]')">Reset</button>
        </div>
      </div>
    </div>
  </section>

  <!-- MPU6050 Section -->
  <section id="mpu6050">
    <h2>MPU6050 Sensor</h2>
    <p class="chart-controls-hint">Use controls below each chart to zoom and pan  Drag to select zoom area  Click legend to toggle</p>
    <div class="grid-2col">
      <div class="chart-box">
        <h3>Acc X [m/s]</h3>
        <canvas id="Acc x [m/s]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Acc x [m/s]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Acc x [m/s]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Acc x [m/s]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Acc x [m/s]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Acc x [m/s]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Acc x [m/s]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Acc x [m/s]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Gyro X [/s]</h3>
        <canvas id="Gyro x [/s]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Gyro x [/s]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Gyro x [/s]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Gyro x [/s]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Gyro x [/s]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Gyro x [/s]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Gyro x [/s]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Gyro x [/s]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Acc Y [m/s]</h3>
        <canvas id="Acc y [m/s]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Acc y [m/s]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Acc y [m/s]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Acc y [m/s]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Acc y [m/s]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Acc y [m/s]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Acc y [m/s]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Acc y [m/s]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Gyro Y [/s]</h3>
        <canvas id="Gyro y [/s]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Gyro y [/s]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Gyro y [/s]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Gyro y [/s]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Gyro y [/s]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Gyro y [/s]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Gyro y [/s]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Gyro y [/s]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Acc Z [m/s]</h3>
        <canvas id="Acc z [m/s]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Acc z [m/s]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Acc z [m/s]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Acc z [m/s]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Acc z [m/s]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Acc z [m/s]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Acc z [m/s]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Acc z [m/s]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Gyro Z [/s]</h3>
        <canvas id="Gyro z [/s]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Gyro z [/s]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Gyro z [/s]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Gyro z [/s]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Gyro z [/s]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Gyro z [/s]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Gyro z [/s]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Gyro z [/s]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Temperature [C]</h3>
        <canvas id="Temp_MPU [C]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Temp_MPU [C]', 'out')"></button>
            <button class="zoom-btn" onclick="zoomChart('Temp_MPU [C]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Temp_MPU [C]', 'left')"></button>
            <button class="pan-btn" onclick="panChart('Temp_MPU [C]', 'right')"></button>
            <button class="pan-btn" onclick="panChart('Temp_MPU [C]', 'up')"></button>
            <button class="pan-btn" onclick="panChart('Temp_MPU [C]', 'down')"></button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Temp_MPU [C]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3 style="opacity: 0.5;">Reset All Charts</h3>
        <div style="display: flex; justify-content: center; align-items: center; height: 100%; min-height: 150px;">
          <button onclick="resetAllZoom()" style="padding: 15px 30px; font-size: 1em; background: var(--color-primary); color: var(--bg-primary); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: var(--glow-primary); transition: all 0.3s ease;">
            Reset All Zoom
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Analysis Row: Correlation + Compare side by side -->
  <div class="analysis-row" id="analysisRow">

  <!-- Multi-Metric Correlation Section -->
  <section id="correlation">
    <h2>Multi-Metric Correlation</h2>
    <p class="chart-controls-hint">Compare multiple metrics on dual Y-axes  Left axis = solid lines  Right axis = dashed lines</p>

    <div class="correlation-controls">
      <div class="correlation-selector">
        <div class="selector-group">
          <label class="selector-label">Left Y-Axis (Solid Lines)</label>
          <div class="multi-select-container" id="leftAxisContainer">
            <button class="multi-select-btn" onclick="toggleMultiSelect('left')">
              <span class="selected-count" id="leftSelectedCount">Select metrics...</span>
              <span class="dropdown-arrow"></span>
            </button>
            <div class="multi-select-dropdown" id="leftAxisDropdown">
              <!-- Options populated by JavaScript -->
            </div>
          </div>
        </div>

        <div class="selector-group">
          <label class="selector-label">Right Y-Axis (Dashed Lines)</label>
          <div class="multi-select-container" id="rightAxisContainer">
            <button class="multi-select-btn" onclick="toggleMultiSelect('right')">
              <span class="selected-count" id="rightSelectedCount">Select metrics...</span>
              <span class="dropdown-arrow"></span>
            </button>
            <div class="multi-select-dropdown" id="rightAxisDropdown">
              <!-- Options populated by JavaScript -->
            </div>
          </div>
        </div>

        <button class="correlation-update-btn" onclick="updateCorrelationChart()">Update Chart</button>
        <button class="correlation-clear-btn" onclick="clearCorrelationSelections()">Clear All</button>
      </div>
    </div>

    <div class="chart-box correlation-chart-box">
      <div class="chart-header">
        <h3>Metric Correlation View</h3>
        <button class="reset-zoom-btn" onclick="resetCorrelationZoom()">Reset Zoom</button>
      </div>
      <canvas id="correlationChart"></canvas>
      <div class="chart-controls">
        <div class="control-group">
          <span class="control-label">Zoom</span>
          <button class="zoom-btn" onclick="zoomCorrelationChart('out')"></button>
          <button class="zoom-btn" onclick="zoomCorrelationChart('in')">+</button>
        </div>
        <div class="control-group">
          <span class="control-label">Pan</span>
          <button class="pan-btn" onclick="panCorrelationChart('left')"></button>
          <button class="pan-btn" onclick="panCorrelationChart('right')"></button>
        </div>
      </div>
      <div class="correlation-legend" id="correlationLegend">
        <!-- Legend populated by JavaScript -->
      </div>
    </div>
  </section>

  <!-- Mission Comparison Section -->
  <section id="mission-compare">
    <h2>Mission Comparison</h2>
    <p class="chart-controls-hint">Compare data from two different missions side-by-side</p>

    <div class="comparison-controls">
      <div class="comparison-selectors">
        <div class="mission-selector-group">
          <label class="selector-label">Mission 1 (Blue - Solid)</label>
          <select id="mission1Select" class="mission-select" onchange="onMissionSelect(1)">
            <option value="">Select a mission...</option>
          </select>
          <div class="mission-info" id="mission1Info"></div>
        </div>

        <div class="mission-selector-group">
          <label class="selector-label">Mission 2 (Orange - Dashed)</label>
          <select id="mission2Select" class="mission-select" onchange="onMissionSelect(2)">
            <option value="">Select a mission...</option>
          </select>
          <div class="mission-info" id="mission2Info"></div>
        </div>

        <div class="mission-selector-group">
          <label class="selector-label">Metric to Compare</label>
          <select id="compareMetricSelect" class="mission-select" onchange="updateComparisonChart()">
            <option value="Temp_BME280 [C]">Temperature BME280 [C]</option>
            <option value="Hum [%]">Humidity [%]</option>
            <option value="Press [hPa]">Pressure [hPa]</option>
            <option value="Alt [m]">Altitude [m]</option>
            <option value="Acc x [m/s]">Acceleration X [m/s]</option>
            <option value="Acc y [m/s]">Acceleration Y [m/s]</option>
            <option value="Acc z [m/s]">Acceleration Z [m/s]</option>
            <option value="Gyro x [/s]">Gyroscope X [/s]</option>
            <option value="Gyro y [/s]">Gyroscope Y [/s]</option>
            <option value="Gyro z [/s]">Gyroscope Z [/s]</option>
            <option value="Temp_MPU [C]">Temperature MPU [C]</option>
          </select>
        </div>
      </div>

      <div class="comparison-actions">
        <button class="comparison-btn" onclick="refreshMissionList()">Refresh Mission List</button>
        <button class="comparison-btn secondary" onclick="clearComparison()">Clear Comparison</button>
        <label class="comparison-checkbox-label">
          <input type="checkbox" id="includeCurrentData" onchange="updateComparisonChart()">
          <span class="export-checkbox-custom"></span>
          <span>Include Current Live Data (Green)</span>
        </label>
      </div>
    </div>

    <div class="comparison-status" id="comparisonStatus"></div>

    <!-- Comparison Chart -->
    <div class="chart-box comparison-chart-box">
      <div class="chart-header">
        <h3>Mission Comparison Chart</h3>
        <button class="reset-zoom-btn" onclick="resetComparisonZoom()">Reset Zoom</button>
      </div>
      <canvas id="comparisonChart"></canvas>
      <div class="chart-controls">
        <div class="control-group">
          <span class="control-label">Zoom</span>
          <button class="zoom-btn" onclick="zoomComparisonChart('out')"></button>
          <button class="zoom-btn" onclick="zoomComparisonChart('in')">+</button>
        </div>
        <div class="control-group">
          <span class="control-label">Pan</span>
          <button class="pan-btn" onclick="panComparisonChart('left')"></button>
          <button class="pan-btn" onclick="panComparisonChart('right')"></button>
        </div>
      </div>
    </div>

  </section>

  <!-- Comparison Statistics Table (spans full width beneath correlation + compare) -->
  <div class="comparison-stats-section analysis-stats-row">
    <h3>Statistics Comparison</h3>
    <div class="stats-table-container">
      <table class="extended-stats-table comparison-stats-table">
        <thead>
          <tr>
            <th>Statistic</th>
            <th>Mission 1</th>
            <th>Mission 2</th>
            <th>Difference</th>
            <th>Current</th>
          </tr>
        </thead>
        <tbody id="comparisonStatsBody">
          <tr><td colspan="5" style="text-align: center; color: var(--color-text-muted);">Select missions to compare</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  </div><!-- End analysis-row -->

  <!-- Mission Replay Section -->
  <section id="mission-replay">
    <h2>Mission Replay</h2>
    <p class="chart-controls-hint">Replay recorded mission data with playback controls</p>

    <!-- Mode Indicator (fixed position) -->
    <div class="playback-mode-indicator live" id="modeIndicator">
      <span class="mode-dot"></span>
      <span class="mode-text">LIVE</span>
    </div>

    <div class="playback-section">
      <div class="playback-controls-container">
        <!-- Mission Selector -->
        <div class="playback-mission-selector">
          <label>Select Mission:</label>
          <select id="playbackMissionSelect" onchange="playbackController.onMissionSelect()">
            <option value="">Choose a recorded mission...</option>
          </select>
          <button class="comparison-btn secondary" onclick="playbackController.refreshMissions()">Refresh</button>
          <button class="return-live-btn" id="returnLiveBtn" onclick="playbackController.returnToLive()" style="display: none;">
             Return to Live
          </button>
        </div>
        <div class="playback-info" id="playbackMissionInfo"></div>

        <!-- Transport Controls -->
        <div class="playback-transport">
          <button class="playback-btn" id="playbackStopBtn" onclick="playbackController.stop()" disabled title="Stop">
            
          </button>
          <button class="playback-btn" id="playbackPrevBtn" onclick="playbackController.stepBackward()" disabled title="Step Backward">
            
          </button>
          <button class="playback-btn play-btn" id="playbackPlayBtn" onclick="playbackController.togglePlay()" disabled title="Play/Pause">
            
          </button>
          <button class="playback-btn" id="playbackNextBtn" onclick="playbackController.stepForward()" disabled title="Step Forward">
            
          </button>
        </div>

        <!-- Seek Slider -->
        <div class="playback-seek-container">
          <span class="playback-time" id="playbackCurrentTime">0.00s</span>
          <input type="range" class="playback-seek" id="playbackSeek" min="0" max="100" value="0"
                 oninput="playbackController.onSeek(this.value)" disabled>
          <span class="playback-time" id="playbackTotalTime">0.00s</span>
        </div>

        <!-- Options: Speed and Loop -->
        <div class="playback-options">
          <div class="playback-speed-selector">
            <label>Speed:</label>
            <button class="speed-btn" data-speed="0.5" onclick="playbackController.setSpeed(0.5)">0.5x</button>
            <button class="speed-btn active" data-speed="1" onclick="playbackController.setSpeed(1)">1x</button>
            <button class="speed-btn" data-speed="2" onclick="playbackController.setSpeed(2)">2x</button>
            <button class="speed-btn" data-speed="5" onclick="playbackController.setSpeed(5)">5x</button>
            <button class="speed-btn" data-speed="10" onclick="playbackController.setSpeed(10)">10x</button>
          </div>

          <button class="playback-loop-toggle" id="playbackLoopToggle" onclick="playbackController.toggleLoop()">
            <span> Loop</span>
          </button>
        </div>

        <!-- Status -->
        <div class="playback-status" id="playbackStatus"></div>
      </div>
    </div>
  </section>

  <!-- Statistics Section -->
  <section id="statistics">
    <!-- Stats Meta Info -->
    <div class="stats-meta-section">
      <h2>Data Overview</h2>
      <div class="stats-meta-grid">
        <div class="stats-meta-card">
          <span class="stats-meta-label">Total Points</span>
          <span class="stats-meta-value" id="statsTotalPoints">0</span>
        </div>
        <div class="stats-meta-card">
          <span class="stats-meta-label">Filtered Points</span>
          <span class="stats-meta-value" id="statsFilteredPoints">0</span>
        </div>
        <div class="stats-meta-card">
          <span class="stats-meta-label">Sample Rate</span>
          <span class="stats-meta-value" id="statsSampleRate">-- Hz</span>
        </div>
        <div class="stats-meta-card">
          <span class="stats-meta-label">Time Span</span>
          <span class="stats-meta-value" id="statsTimeSpan">-- s</span>
        </div>
        <div class="stats-meta-card">
          <span class="stats-meta-label">Last Update</span>
          <span class="stats-meta-value" id="statsLastUpdate">--</span>
        </div>
      </div>
    </div>

    <h2>Statistics: BME280</h2>
    <div class="stats-table-container">
      <table class="extended-stats-table">
        <thead>
          <tr>
            <th>Metric</th>
            <th>Min</th>
            <th>Max</th>
            <th>Avg</th>
            <th>Median</th>
            <th>StdDev</th>
            <th>25%</th>
            <th>75%</th>
            <th>95%</th>
            <th>Rate/s</th>
          </tr>
        </thead>
        <tbody id="bmeSummary"></tbody>
      </table>
    </div>

    <h2 style="margin-top: 50px;">Statistics: MPU6050</h2>
    <div class="stats-table-container">
      <table class="extended-stats-table">
        <thead>
          <tr>
            <th>Metric</th>
            <th>Min</th>
            <th>Max</th>
            <th>Avg</th>
            <th>Median</th>
            <th>StdDev</th>
            <th>25%</th>
            <th>75%</th>
            <th>95%</th>
            <th>Rate/s</th>
          </tr>
        </thead>
        <tbody id="mpuSummary"></tbody>
      </table>
    </div>
  </section>


  <!-- Configuration Section -->
  <section id="configuration">
    <h2>System Configuration</h2>

    <div class="config-section">
      <h3>Sensor Calibration & Settings</h3>

      <div class="config-grid">
        <!-- Calibration Settings -->
        <div class="config-group">
          <h4>Calibration</h4>
          <div class="config-row">
            <span class="config-label">Sea Level Pressure</span>
            <div>
              <input type="number" class="config-input" id="configSeaLevelPressure" step="0.1" min="900" max="1100">
              <span class="config-unit">hPa</span>
            </div>
          </div>
        </div>

        <!-- Update Settings -->
        <div class="config-group">
          <h4>Update Settings</h4>
          <div class="config-row">
            <span class="config-label">Update Frequency</span>
            <div>
              <input type="number" class="config-input" id="configUpdateFrequency" step="0.1" min="0.1" max="10">
              <span class="config-unit">sec</span>
            </div>
          </div>
          <div class="config-row">
            <span class="config-label">History Length</span>
            <div>
              <input type="number" class="config-input" id="configHistoryLength" step="10" min="50" max="1000">
              <span class="config-unit">points</span>
            </div>
          </div>
        </div>
      </div>

      <div class="config-section" style="margin-top: 20px; padding: 20px;">
        <h3>Transmission Thresholds</h3>
        <p style="color: var(--color-text-muted); font-size: 0.85em; margin-bottom: 15px;">
          Minimum change required before transmitting new data (reduces network overhead)
        </p>

        <div class="config-grid">
          <!-- BME280 Thresholds -->
          <div class="config-group">
            <h4>BME280 Sensor</h4>
            <div class="config-row">
              <span class="config-label">Temperature</span>
              <div>
                <input type="number" class="config-input" id="configThresholdTempBme" step="0.05" min="0">
                <span class="config-unit">C</span>
              </div>
            </div>
            <div class="config-row">
              <span class="config-label">Humidity</span>
              <div>
                <input type="number" class="config-input" id="configThresholdHumidity" step="0.1" min="0">
                <span class="config-unit">%</span>
              </div>
            </div>
            <div class="config-row">
              <span class="config-label">Pressure</span>
              <div>
                <input type="number" class="config-input" id="configThresholdPressure" step="0.1" min="0">
                <span class="config-unit">hPa</span>
              </div>
            </div>
            <div class="config-row">
              <span class="config-label">Altitude</span>
              <div>
                <input type="number" class="config-input" id="configThresholdAltitude" step="0.1" min="0">
                <span class="config-unit">m</span>
              </div>
            </div>
          </div>

          <!-- MPU6050 Thresholds -->
          <div class="config-group">
            <h4>MPU6050 Sensor</h4>
            <div class="config-row">
              <span class="config-label">Acceleration (all axes)</span>
              <div>
                <input type="number" class="config-input" id="configThresholdAcceleration" step="0.05" min="0">
                <span class="config-unit">m/s</span>
              </div>
            </div>
            <div class="config-row">
              <span class="config-label">Gyroscope (all axes)</span>
              <div>
                <input type="number" class="config-input" id="configThresholdGyroscope" step="0.5" min="0">
                <span class="config-unit">/s</span>
              </div>
            </div>
            <div class="config-row">
              <span class="config-label">Temperature</span>
              <div>
                <input type="number" class="config-input" id="configThresholdTempMpu" step="0.05" min="0">
                <span class="config-unit">C</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Configuration Actions -->
      <div class="config-actions">
        <button class="config-btn secondary" onclick="loadConfiguration()">Reload</button>
        <button class="config-btn danger" onclick="resetConfiguration()">Reset to Defaults</button>
        <button class="config-btn primary" onclick="saveConfiguration()">Save Configuration</button>
      </div>

      <div class="config-status" id="configStatus"></div>
    </div>

    <!-- Profile Management -->
    <div class="config-section profile-section">
      <h3>Configuration Profiles</h3>
      <p style="color: var(--color-text-muted); font-size: 0.85em; margin-bottom: 15px;">
        Save and load configuration presets for different mission scenarios
      </p>

      <div class="profile-controls">
        <select class="profile-select" id="profileSelect">
          <option value="">-- Select a profile --</option>
        </select>
        <button class="config-btn secondary" onclick="loadProfile()">Load Profile</button>
        <button class="config-btn danger" onclick="deleteProfile()">Delete</button>
      </div>

      <div class="profile-controls" style="margin-top: 15px;">
        <input type="text" class="profile-name-input" id="newProfileName" placeholder="New profile name...">
        <button class="config-btn primary" onclick="saveProfile()">Save as New Profile</button>
      </div>

      <div class="config-status" id="profileStatus"></div>
    </div>
  </section>

  <!-- 3D Orientation Visualization Section -->
  <section id="orientation-3d">
    <h2>3D Orientation Visualization</h2>
    <p class="chart-controls-hint">Real-time submarine orientation from integrated gyroscope data (Pitch/Roll/Yaw)</p>

    <div class="orientation-container">
      <div class="orientation-canvas-wrapper" id="orientationCanvasWrapper">
        <!-- Three.js canvas will be inserted here -->
      </div>

      <div class="orientation-controls-panel">
        <div class="orientation-readings">
          <h4>Orientation Angles</h4>
          <div class="orientation-value">
            <span class="orientation-label">Pitch (X)</span>
            <span class="orientation-number pitch" id="pitchValue">0.0</span>
          </div>
          <div class="orientation-value">
            <span class="orientation-label">Roll (Y)</span>
            <span class="orientation-number roll" id="rollValue">0.0</span>
          </div>
          <div class="orientation-value">
            <span class="orientation-label">Yaw (Z)</span>
            <span class="orientation-number yaw" id="yawValue">0.0</span>
          </div>
        </div>

        <div class="orientation-gyro-readings">
          <h4>Gyroscope Rates</h4>
          <div class="gyro-value">
            <span class="gyro-label">Gyro X</span>
            <span class="gyro-number" id="gyroXValue">0.0 /s</span>
          </div>
          <div class="gyro-value">
            <span class="gyro-label">Gyro Y</span>
            <span class="gyro-number" id="gyroYValue">0.0 /s</span>
          </div>
          <div class="gyro-value">
            <span class="gyro-label">Gyro Z</span>
            <span class="gyro-number" id="gyroZValue">0.0 /s</span>
          </div>
        </div>

        <div class="orientation-actions">
          <button class="orientation-btn reset" onclick="orientationVis.resetOrientation()">
            Reset Orientation
          </button>
          <button class="orientation-btn" onclick="orientationVis.toggleAutoRotate()">
            Toggle Auto-Rotate
          </button>
        </div>

        <div class="orientation-status" id="orientationStatus">
          Waiting for sensor data...
        </div>
      </div>
    </div>
  </section>

  <!-- Download Section -->
  <section id="downloads" class="download-controls">
    <h2>Download Logs</h2>
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <button onclick="downloadLatest()">Download Latest Log</button>
      <select id="logSelect" onchange="downloadSelected()">
        <option value="">-- Select archived log --</option>
      </select>
      <button onclick="openLogsFolder()" style="background-color: #6366f1;">Open Logs Folder</button>
    </div>
    <div style="margin-top: 10px;">
      <span id="folderStatus" style="color: #38bdf8;"></span>
    </div>

    <!-- Export Filtered Data -->
    <div class="time-filter-section" style="margin-top: 30px;">
      <h3>Export Filtered Data</h3>
      <div class="time-filter-controls">
        <button class="time-preset-btn active" data-export-preset="all" onclick="setExportFilter('all')">All Data</button>
        <button class="time-preset-btn" data-export-preset="30" onclick="setExportFilter(30)">Last 30s</button>
        <button class="time-preset-btn" data-export-preset="60" onclick="setExportFilter(60)">Last 1min</button>
        <button class="time-preset-btn" data-export-preset="300" onclick="setExportFilter(300)">Last 5min</button>

        <div class="time-filter-divider"></div>

        <div class="custom-range-container" id="exportCustomRangeContainer">
          <span class="custom-range-label">Custom:</span>
          <input type="number" class="custom-range-input" id="exportFromTime" placeholder="From (s)" min="0" step="0.1">
          <span class="custom-range-label">to</span>
          <input type="number" class="custom-range-input" id="exportToTime" placeholder="To (s)" min="0" step="0.1">
          <button class="apply-custom-btn" onclick="applyExportCustomRange()">Apply</button>
        </div>
      </div>

      <div class="time-filter-info">
        <span>Points to export: <span class="info-value" id="exportPointsCount">0</span></span>
        <span>Export range: <span class="info-value" id="exportTimeRange">All</span></span>
        <button class="export-filtered-btn" onclick="exportFilteredData()" id="exportFilteredBtn">
          <span>Export Filtered CSV</span>
        </button>
      </div>
    </div>

    <!-- Export Charts Section -->
    <div class="time-filter-section" style="margin-top: 30px;">
      <h3>Export Charts as Images</h3>
      <div class="chart-export-controls">
        <div class="export-options-grid">
          <label class="export-checkbox-label">
            <input type="checkbox" id="exportBME280" checked>
            <span class="export-checkbox-custom"></span>
            <span>BME280 Charts (4)</span>
          </label>
          <label class="export-checkbox-label">
            <input type="checkbox" id="exportMPU6050" checked>
            <span class="export-checkbox-custom"></span>
            <span>MPU6050 Charts (7)</span>
          </label>
          <label class="export-checkbox-label">
            <input type="checkbox" id="exportCorrelation">
            <span class="export-checkbox-custom"></span>
            <span>Correlation Chart</span>
          </label>
          <label class="export-checkbox-label">
            <input type="checkbox" id="exportMissionComparison">
            <span class="export-checkbox-custom"></span>
            <span>Mission Comparison</span>
          </label>
        </div>

        <div class="export-format-row">
          <div class="export-format-group">
            <label class="selector-label">Format</label>
            <select id="chartExportFormat" class="export-format-select">
              <option value="png">PNG (High Quality)</option>
              <option value="jpeg">JPEG (Smaller Size)</option>
            </select>
          </div>

          <div class="export-format-group">
            <label class="selector-label">Download As</label>
            <select id="chartExportMode" class="export-format-select">
              <option value="zip">ZIP Archive</option>
              <option value="individual">Individual Files</option>
            </select>
          </div>
        </div>

        <div class="export-actions-row">
          <button class="export-chart-btn" onclick="exportSelectedCharts()">
            Export Selected Charts
          </button>
          <button class="export-chart-btn secondary" onclick="selectAllChartExports(true)">
            Select All
          </button>
          <button class="export-chart-btn secondary" onclick="selectAllChartExports(false)">
            Deselect All
          </button>
        </div>

        <div class="export-status" id="chartExportStatus"></div>
      </div>
    </div>

    <!-- Export Data Formats Section -->
    <div class="time-filter-section" style="margin-top: 30px;">
      <h3>Export Data Formats</h3>
      <p style="color: var(--color-text-muted); font-size: 0.85em; margin-bottom: 15px;">
        Export current session data in different formats. Use time range filter above to limit data.
      </p>
      <div class="chart-export-controls">
        <div class="export-format-grid">
          <div class="export-format-card" onclick="exportDataFormat('json')">
            <div class="export-format-icon">{ }</div>
            <div class="export-format-name">JSON</div>
            <div class="export-format-desc">Structured data with metadata and statistics</div>
          </div>
          <div class="export-format-card" onclick="exportDataFormat('excel')">
            <div class="export-format-icon">XLS</div>
            <div class="export-format-name">Excel</div>
            <div class="export-format-desc">Multi-sheet workbook (BME280, MPU6050, Stats)</div>
          </div>
          <div class="export-format-card" onclick="exportDataFormat('pdf')">
            <div class="export-format-icon">PDF</div>
            <div class="export-format-name">PDF Report</div>
            <div class="export-format-desc">Formatted report with statistics and data tables</div>
          </div>
        </div>

        <div class="export-time-range-row" style="margin-top: 15px;">
          <label class="export-checkbox-label">
            <input type="checkbox" id="useExportTimeRange">
            <span class="export-checkbox-custom"></span>
            <span>Use export time filter (above)</span>
          </label>
          <span class="export-range-preview" id="exportRangePreview">All data</span>
        </div>

        <div class="export-status" id="dataExportStatus"></div>
      </div>
    </div>
  </section>

  <!-- Chart and Data Script -->
  <script>
    const chartRefs = {};
    // Full history storage (all data from server)
    let fullHistory = {};
    // Current time filter settings (for display)
    let currentTimeFilter = {
      type: 'all',  // 'all', 'preset', 'custom'
      value: null,  // seconds for preset, or {from, to} for custom
    };
    // Export time filter settings (separate from display filter)
    let exportTimeFilter = {
      type: 'all',
      value: null,
    };

    const fields = {
      "Temp_BME280 [C]": "bme",
      "Hum [%]": "bme",
      "Press [hPa]": "bme",
      "Alt [m]": "bme",
      "Acc x [m/s]": "mpu",
      "Acc y [m/s]": "mpu",
      "Acc z [m/s]": "mpu",
      "Gyro x [/s]": "mpu",
      "Gyro y [/s]": "mpu",
      "Gyro z [/s]": "mpu",
      "Temp_MPU [C]": "mpu"
    };

    function createChart(id, label) {
      const ctx = document.getElementById(id).getContext("2d");
      // Get current theme colors
      const computedStyle = getComputedStyle(document.documentElement);
      const chartColor = computedStyle.getPropertyValue('--color-chart').trim() ||
                        computedStyle.getPropertyValue('--color-primary').trim();
      const backgroundColor = chartColor + '20'; // Add transparency

      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: label,
            data: [],
            borderColor: chartColor,
            backgroundColor: backgroundColor,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: chartColor,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2,
            tension: 0.3
          }]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              type: "linear",
              title: { display: true, text: "Elapsed [s]", color: computedStyle.getPropertyValue('--color-text-muted').trim() },
              ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
              grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
            },
            y: {
              title: { display: true, text: label, color: computedStyle.getPropertyValue('--color-text-muted').trim() },
              ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
              grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
            }
          },
          plugins: {
            legend: {
              labels: { color: computedStyle.getPropertyValue('--color-text-primary').trim() },
              onClick: (e, legendItem, legend) => {
                const index = legendItem.datasetIndex;
                const chart = legend.chart;
                const meta = chart.getDatasetMeta(index);
                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                chart.update();
              }
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(0, 0, 0, 0.85)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: chartColor,
              borderWidth: 1,
              cornerRadius: 8,
              padding: 12,
              displayColors: true,
              callbacks: {
                title: function(context) {
                  const value = context[0].label;
                  return `Time: ${parseFloat(value).toFixed(2)}s`;
                },
                label: function(context) {
                  const value = context.raw;
                  return ` ${context.dataset.label}: ${parseFloat(value).toFixed(3)}`;
                }
              }
            },
            zoom: {
              pan: {
                enabled: true,
                mode: 'xy',
                modifierKey: 'ctrl',
              },
              zoom: {
                wheel: {
                  enabled: false,
                },
                pinch: {
                  enabled: true,
                },
                drag: {
                  enabled: true,
                  backgroundColor: 'rgba(0, 170, 255, 0.15)',
                  borderColor: 'rgba(0, 170, 255, 0.8)',
                  borderWidth: 1,
                },
                mode: 'xy',
              },
              limits: {
                x: {min: 'original', max: 'original'},
                y: {min: 'original', max: 'original'},
              },
            }
          }
        }
      });
    }

    // Reset zoom for a specific chart
    function resetChartZoom(chartId) {
      if (chartRefs[chartId] && chartRefs[chartId].resetZoom) {
        chartRefs[chartId].resetZoom();
      }
    }

    // Reset zoom for all charts
    function resetAllZoom() {
      Object.values(chartRefs).forEach(chart => {
        if (chart && chart.resetZoom) {
          chart.resetZoom();
        }
      });
    }

    // Zoom in or out on a specific chart
    function zoomChart(chartId, direction) {
      const chart = chartRefs[chartId];
      if (!chart) return;

      const zoomFactor = direction === 'in' ? 1.2 : 0.8;
      chart.zoom(zoomFactor);
    }

    // Pan chart in a direction
    function panChart(chartId, direction) {
      const chart = chartRefs[chartId];
      if (!chart) return;

      const panAmount = 50; // pixels to pan
      let deltaX = 0, deltaY = 0;

      switch(direction) {
        case 'left':  deltaX = panAmount; break;
        case 'right': deltaX = -panAmount; break;
        case 'up':    deltaY = panAmount; break;
        case 'down':  deltaY = -panAmount; break;
      }

      chart.pan({x: deltaX, y: deltaY}, undefined, 'default');
    }

    // Hold-to-repeat functionality for zoom and pan buttons
    let holdInterval = null;
    let holdTimeout = null;
    const HOLD_DELAY = 300; // ms before repeat starts
    const HOLD_RATE = 80;   // ms between repeats

    function startHoldAction(action) {
      // Execute immediately
      action();
      // Start repeating after delay
      holdTimeout = setTimeout(() => {
        holdInterval = setInterval(action, HOLD_RATE);
      }, HOLD_DELAY);
    }

    function stopHoldAction() {
      if (holdTimeout) {
        clearTimeout(holdTimeout);
        holdTimeout = null;
      }
      if (holdInterval) {
        clearInterval(holdInterval);
        holdInterval = null;
      }
    }

    // Setup hold-to-repeat for all zoom and pan buttons
    document.addEventListener('DOMContentLoaded', function() {
      setupHoldButtons();
    });

    function setupHoldButtons() {
      // Get all zoom and pan buttons
      const buttons = document.querySelectorAll('.zoom-btn, .pan-btn');

      buttons.forEach(btn => {
        const onclick = btn.getAttribute('onclick');
        if (!onclick) return;

        // Parse the onclick to extract function and arguments
        const match = onclick.match(/(zoomChart|panChart)\('([^']+)',\s*'([^']+)'\)/);
        if (!match) return;

        const [, funcName, chartId, direction] = match;
        const actionFn = funcName === 'zoomChart' ? zoomChart : panChart;

        // Remove onclick attribute since we're handling it differently
        btn.removeAttribute('onclick');

        // Add mousedown/mouseup/mouseleave for hold behavior
        btn.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startHoldAction(() => actionFn(chartId, direction));
        });

        btn.addEventListener('mouseup', stopHoldAction);
        btn.addEventListener('mouseleave', stopHoldAction);

        // Touch support
        btn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          startHoldAction(() => actionFn(chartId, direction));
        });
        btn.addEventListener('touchend', stopHoldAction);
        btn.addEventListener('touchcancel', stopHoldAction);
      });
    }

    function computeStats(values) {
      if (!values.length) return ["-", "-", "-"];
      let min = values[0], max = values[0], sum = 0;
      for (let v of values) {
        min = Math.min(min, v);
        max = Math.max(max, v);
        sum += v;
      }
      return [min.toFixed(2), max.toFixed(2), (sum / values.length).toFixed(2)];
    }

    // Extended statistics computation
    function computeExtendedStats(values, elapsedTimes) {
      if (!values || !values.length) {
        return {
          min: "-",
          max: "-",
          avg: "-",
          median: "-",
          stdDev: "-",
          p25: "-",
          p75: "-",
          p95: "-",
          ratePerSec: "-"
        };
      }

      const n = values.length;

      // Basic stats
      let min = values[0], max = values[0], sum = 0;
      for (let v of values) {
        min = Math.min(min, v);
        max = Math.max(max, v);
        sum += v;
      }
      const avg = sum / n;

      // Sort values for percentile calculations
      const sorted = [...values].sort((a, b) => a - b);

      // Median (50th percentile)
      const median = getPercentile(sorted, 0.5);

      // Standard deviation
      let sumSquaredDiff = 0;
      for (let v of values) {
        sumSquaredDiff += Math.pow(v - avg, 2);
      }
      const stdDev = Math.sqrt(sumSquaredDiff / n);

      // Percentiles
      const p25 = getPercentile(sorted, 0.25);
      const p75 = getPercentile(sorted, 0.75);
      const p95 = getPercentile(sorted, 0.95);

      // Rate of change (linear regression slope of last 5 points)
      let ratePerSec = 0;
      if (elapsedTimes && elapsedTimes.length >= 2) {
        const windowSize = Math.min(5, values.length);
        const recentValues = values.slice(-windowSize);
        const recentTimes = elapsedTimes.slice(-windowSize);
        ratePerSec = calculateLinearRegressionSlope(recentTimes, recentValues);
      }

      return {
        min: min.toFixed(2),
        max: max.toFixed(2),
        avg: avg.toFixed(2),
        median: median.toFixed(2),
        stdDev: stdDev.toFixed(3),
        p25: p25.toFixed(2),
        p75: p75.toFixed(2),
        p95: p95.toFixed(2),
        ratePerSec: ratePerSec.toFixed(3)
      };
    }

    // Get percentile using linear interpolation
    function getPercentile(sortedArray, percentile) {
      if (sortedArray.length === 0) return 0;
      if (sortedArray.length === 1) return sortedArray[0];

      const index = percentile * (sortedArray.length - 1);
      const lower = Math.floor(index);
      const upper = Math.ceil(index);
      const weight = index - lower;

      if (upper >= sortedArray.length) return sortedArray[sortedArray.length - 1];
      if (lower === upper) return sortedArray[lower];

      return sortedArray[lower] * (1 - weight) + sortedArray[upper] * weight;
    }

    // Calculate linear regression slope
    function calculateLinearRegressionSlope(xValues, yValues) {
      const n = xValues.length;
      if (n < 2) return 0;

      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      for (let i = 0; i < n; i++) {
        sumX += xValues[i];
        sumY += yValues[i];
        sumXY += xValues[i] * yValues[i];
        sumX2 += xValues[i] * xValues[i];
      }

      const denominator = n * sumX2 - sumX * sumX;
      if (denominator === 0) return 0;

      return (n * sumXY - sumX * sumY) / denominator;
    }

    // Format rate with color indication
    function formatRateWithColor(rate) {
      const numRate = parseFloat(rate);
      if (isNaN(numRate) || rate === "-") return `<span class="stat-neutral">-</span>`;

      if (numRate > 0.01) {
        return `<span class="stat-positive">+${rate}</span>`;
      } else if (numRate < -0.01) {
        return `<span class="stat-negative">${rate}</span>`;
      }
      return `<span class="stat-neutral">${rate}</span>`;
    }

    // Update stats meta information
    let lastUpdateTime = null;
    function updateStatsMeta(totalPoints, filteredPoints, elapsedTimes) {
      document.getElementById('statsTotalPoints').textContent = totalPoints;
      document.getElementById('statsFilteredPoints').textContent = filteredPoints;

      // Calculate sample rate
      if (elapsedTimes && elapsedTimes.length >= 2) {
        const timeSpan = elapsedTimes[elapsedTimes.length - 1] - elapsedTimes[0];
        const sampleRate = timeSpan > 0 ? ((elapsedTimes.length - 1) / timeSpan).toFixed(2) : 0;
        document.getElementById('statsSampleRate').textContent = `${sampleRate} Hz`;
        document.getElementById('statsTimeSpan').textContent = `${timeSpan.toFixed(1)} s`;
      } else {
        document.getElementById('statsSampleRate').textContent = '-- Hz';
        document.getElementById('statsTimeSpan').textContent = '-- s';
      }

      // Update last update time
      lastUpdateTime = new Date();
      document.getElementById('statsLastUpdate').textContent = lastUpdateTime.toLocaleTimeString();
    }

    // ==========================================
    // Multi-Metric Correlation Chart
    // ==========================================

    // Color palette for correlation chart
    const correlationColors = [
      '#00aaff', // cyan
      '#ff6b6b', // red
      '#4ecdc4', // teal
      '#ffe66d', // yellow
      '#95e1d3', // mint
      '#f38181', // coral
      '#aa96da', // purple
      '#fcbad3', // pink
      '#a8d8ea', // light blue
      '#ff9a8b', // peach
      '#88d8b0', // green
    ];

    // Correlation state
    let correlationChart = null;
    let leftAxisSelections = [];
    let rightAxisSelections = [];

    // Initialize correlation dropdowns
    function initCorrelationDropdowns() {
      const leftDropdown = document.getElementById('leftAxisDropdown');
      const rightDropdown = document.getElementById('rightAxisDropdown');

      const metricList = Object.keys(fields);

      // Populate left dropdown
      leftDropdown.innerHTML = metricList.map((metric, idx) => `
        <div class="multi-select-option" data-metric="${metric}" onclick="toggleMetricSelection('left', '${metric}')">
          <div class="multi-select-checkbox"></div>
          <span class="multi-select-option-label">${metric}</span>
          <div class="multi-select-option-color" style="background: ${correlationColors[idx % correlationColors.length]}"></div>
        </div>
      `).join('');

      // Populate right dropdown
      rightDropdown.innerHTML = metricList.map((metric, idx) => `
        <div class="multi-select-option" data-metric="${metric}" onclick="toggleMetricSelection('right', '${metric}')">
          <div class="multi-select-checkbox"></div>
          <span class="multi-select-option-label">${metric}</span>
          <div class="multi-select-option-color" style="background: ${correlationColors[idx % correlationColors.length]}"></div>
        </div>
      `).join('');
    }

    // Toggle multi-select dropdown
    function toggleMultiSelect(side) {
      const container = document.getElementById(`${side}AxisContainer`);
      const otherSide = side === 'left' ? 'right' : 'left';
      const otherContainer = document.getElementById(`${otherSide}AxisContainer`);

      // Close the other dropdown
      otherContainer.classList.remove('open');

      // Toggle this dropdown
      container.classList.toggle('open');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.multi-select-container')) {
        document.querySelectorAll('.multi-select-container').forEach(c => c.classList.remove('open'));
      }
    });

    // Toggle metric selection
    function toggleMetricSelection(side, metric) {
      const selections = side === 'left' ? leftAxisSelections : rightAxisSelections;
      const otherSelections = side === 'left' ? rightAxisSelections : leftAxisSelections;

      // Remove from other side if selected there
      const otherIdx = otherSelections.indexOf(metric);
      if (otherIdx > -1) {
        otherSelections.splice(otherIdx, 1);
        updateDropdownUI(side === 'left' ? 'right' : 'left');
      }

      // Toggle in current side
      const idx = selections.indexOf(metric);
      if (idx > -1) {
        selections.splice(idx, 1);
      } else {
        selections.push(metric);
      }

      updateDropdownUI(side);
      updateSelectionCount(side);
    }

    // Update dropdown UI to reflect selections
    function updateDropdownUI(side) {
      const dropdown = document.getElementById(`${side}AxisDropdown`);
      const selections = side === 'left' ? leftAxisSelections : rightAxisSelections;

      dropdown.querySelectorAll('.multi-select-option').forEach(option => {
        const metric = option.dataset.metric;
        if (selections.includes(metric)) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      });
    }

    // Update selection count display
    function updateSelectionCount(side) {
      const countSpan = document.getElementById(`${side}SelectedCount`);
      const selections = side === 'left' ? leftAxisSelections : rightAxisSelections;

      if (selections.length === 0) {
        countSpan.textContent = 'Select metrics...';
      } else if (selections.length === 1) {
        countSpan.textContent = selections[0];
      } else {
        countSpan.textContent = `${selections.length} metrics selected`;
      }
    }

    // Clear all selections
    function clearCorrelationSelections() {
      leftAxisSelections = [];
      rightAxisSelections = [];
      updateDropdownUI('left');
      updateDropdownUI('right');
      updateSelectionCount('left');
      updateSelectionCount('right');

      // Clear chart
      if (correlationChart) {
        correlationChart.data.datasets = [];
        correlationChart.update();
      }

      // Clear legend
      document.getElementById('correlationLegend').innerHTML = '';
    }

    // Create or update correlation chart
    function updateCorrelationChart() {
      const filteredHistory = filterDataByTimeRange(fullHistory, currentTimeFilter);
      const elapsed = filteredHistory["Elapsed [s]"] || [];

      if (elapsed.length === 0) {
        alert('No data available. Please generate some test data first.');
        return;
      }

      if (leftAxisSelections.length === 0 && rightAxisSelections.length === 0) {
        alert('Please select at least one metric for either axis.');
        return;
      }

      const datasets = [];
      const legendItems = [];

      // Get theme colors
      const computedStyle = getComputedStyle(document.documentElement);

      // Add left axis datasets (solid lines)
      leftAxisSelections.forEach((metric, idx) => {
        const colorIdx = Object.keys(fields).indexOf(metric);
        const color = correlationColors[colorIdx % correlationColors.length];
        const values = filteredHistory[metric] || [];

        datasets.push({
          label: metric,
          data: values,
          borderColor: color,
          backgroundColor: color + '20',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          tension: 0.3,
          yAxisID: 'yLeft',
          borderDash: [], // Solid line
        });

        legendItems.push({
          metric,
          color,
          axis: 'left',
          dashed: false
        });
      });

      // Add right axis datasets (dashed lines)
      rightAxisSelections.forEach((metric, idx) => {
        const colorIdx = Object.keys(fields).indexOf(metric);
        const color = correlationColors[colorIdx % correlationColors.length];
        const values = filteredHistory[metric] || [];

        datasets.push({
          label: metric + ' (R)',
          data: values,
          borderColor: color,
          backgroundColor: color + '20',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          tension: 0.3,
          yAxisID: 'yRight',
          borderDash: [8, 4], // Dashed line
        });

        legendItems.push({
          metric,
          color,
          axis: 'right',
          dashed: true
        });
      });

      // Determine Y-axis titles
      const leftTitle = leftAxisSelections.length === 1 ? leftAxisSelections[0] : 'Left Axis';
      const rightTitle = rightAxisSelections.length === 1 ? rightAxisSelections[0] : 'Right Axis';

      // Create or update chart
      if (correlationChart) {
        correlationChart.data.labels = elapsed;
        correlationChart.data.datasets = datasets;
        correlationChart.options.scales.yLeft.display = leftAxisSelections.length > 0;
        correlationChart.options.scales.yRight.display = rightAxisSelections.length > 0;
        correlationChart.options.scales.yLeft.title.text = leftTitle;
        correlationChart.options.scales.yRight.title.text = rightTitle;
        correlationChart.update();
      } else {
        const ctx = document.getElementById('correlationChart').getContext('2d');
        correlationChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: elapsed,
            datasets: datasets
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                type: 'linear',
                title: {
                  display: true,
                  text: 'Elapsed [s]',
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
              },
              yLeft: {
                type: 'linear',
                position: 'left',
                display: leftAxisSelections.length > 0,
                title: {
                  display: true,
                  text: leftTitle,
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
              },
              yRight: {
                type: 'linear',
                position: 'right',
                display: rightAxisSelections.length > 0,
                title: {
                  display: true,
                  text: rightTitle,
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: {
                  drawOnChartArea: false,
                  color: computedStyle.getPropertyValue('--color-border').trim()
                }
              }
            },
            plugins: {
              legend: {
                display: false // Use custom legend
              },
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: computedStyle.getPropertyValue('--color-primary').trim(),
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                displayColors: true,
                callbacks: {
                  title: function(context) {
                    return `Time: ${parseFloat(context[0].label).toFixed(2)}s`;
                  },
                  label: function(context) {
                    return ` ${context.dataset.label}: ${parseFloat(context.raw).toFixed(3)}`;
                  }
                }
              },
              zoom: {
                pan: {
                  enabled: true,
                  mode: 'x',
                  modifierKey: 'ctrl',
                },
                zoom: {
                  wheel: { enabled: false },
                  pinch: { enabled: true },
                  drag: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 170, 255, 0.15)',
                    borderColor: 'rgba(0, 170, 255, 0.8)',
                    borderWidth: 1,
                  },
                  mode: 'x',
                }
              }
            }
          }
        });
      }

      // Update custom legend
      updateCorrelationLegend(legendItems);
    }

    // Update custom legend
    function updateCorrelationLegend(items) {
      const legendContainer = document.getElementById('correlationLegend');

      if (items.length === 0) {
        legendContainer.innerHTML = '<span style="color: var(--color-text-muted); font-size: 0.85em;">Select metrics and click "Update Chart" to view correlation</span>';
        return;
      }

      legendContainer.innerHTML = items.map(item => `
        <div class="legend-item">
          <div class="legend-line ${item.dashed ? 'dashed' : ''}" style="background: ${item.dashed ? 'none' : item.color}; color: ${item.color};"></div>
          <span>${item.metric}</span>
          <span class="legend-axis-label">${item.axis === 'left' ? 'L' : 'R'}</span>
        </div>
      `).join('');
    }

    // Correlation chart zoom controls
    function resetCorrelationZoom() {
      if (correlationChart && correlationChart.resetZoom) {
        correlationChart.resetZoom();
      }
    }

    function zoomCorrelationChart(direction) {
      if (!correlationChart) return;
      const zoomFactor = direction === 'in' ? 1.2 : 0.8;
      correlationChart.zoom(zoomFactor);
    }

    function panCorrelationChart(direction) {
      if (!correlationChart) return;
      const panAmount = 50;
      let deltaX = 0;
      if (direction === 'left') deltaX = panAmount;
      else if (direction === 'right') deltaX = -panAmount;
      correlationChart.pan({x: deltaX, y: 0}, undefined, 'default');
    }

    // ==========================================
    // Chart Export Functions
    // ==========================================

    // Get list of charts to export based on selections
    function getChartsToExport() {
      const charts = [];
      const exportBME280 = document.getElementById('exportBME280').checked;
      const exportMPU6050 = document.getElementById('exportMPU6050').checked;
      const exportCorrelation = document.getElementById('exportCorrelation').checked;

      // BME280 charts
      if (exportBME280) {
        const bmeCharts = ['Temp_BME280 [C]', 'Hum [%]', 'Press [hPa]', 'Alt [m]'];
        bmeCharts.forEach(id => {
          if (chartRefs[id]) {
            charts.push({ id, name: id.replace(/[\[\]\/]/g, '').replace(/\s+/g, '_'), chart: chartRefs[id] });
          }
        });
      }

      // MPU6050 charts
      if (exportMPU6050) {
        const mpuCharts = ['Acc x [m/s]', 'Acc y [m/s]', 'Acc z [m/s]', 'Gyro x [/s]', 'Gyro y [/s]', 'Gyro z [/s]', 'Temp_MPU [C]'];
        mpuCharts.forEach(id => {
          if (chartRefs[id]) {
            charts.push({ id, name: id.replace(/[\[\]\/]/g, '').replace(/\s+/g, '_'), chart: chartRefs[id] });
          }
        });
      }

      // Correlation chart
      if (exportCorrelation && correlationChart) {
        charts.push({ id: 'correlationChart', name: 'Correlation_Chart', chart: correlationChart });
      }

      // Mission Comparison chart
      const exportMissionComparison = document.getElementById('exportMissionComparison').checked;
      if (exportMissionComparison && comparisonChart) {
        charts.push({ id: 'comparisonChart', name: 'Mission_Comparison', chart: comparisonChart });
      }

      return charts;
    }

    // Convert chart to image data URL
    function chartToImage(chart, format) {
      const canvas = chart.canvas;
      const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png';
      const quality = format === 'jpeg' ? 0.92 : undefined;

      // Create a temporary canvas with white background for JPEG
      if (format === 'jpeg') {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');

        // Fill with theme background color
        const computedStyle = getComputedStyle(document.documentElement);
        tempCtx.fillStyle = computedStyle.getPropertyValue('--bg-card').trim() || '#1f3545';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

        // Draw chart on top
        tempCtx.drawImage(canvas, 0, 0);
        return tempCanvas.toDataURL(mimeType, quality);
      }

      return canvas.toDataURL(mimeType, quality);
    }

    // Download single file
    function downloadFile(dataUrl, filename) {
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Convert data URL to blob
    function dataURLtoBlob(dataURL) {
      const parts = dataURL.split(',');
      const mime = parts[0].match(/:(.*?);/)[1];
      const bstr = atob(parts[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }

    // Select/deselect all chart export checkboxes
    function selectAllChartExports(select) {
      document.getElementById('exportBME280').checked = select;
      document.getElementById('exportMPU6050').checked = select;
      document.getElementById('exportCorrelation').checked = select;
      document.getElementById('exportMissionComparison').checked = select;
    }

    // Update export status message
    function setExportStatus(message, type = '') {
      const statusEl = document.getElementById('chartExportStatus');
      statusEl.textContent = message;
      statusEl.className = 'export-status ' + type;
    }

    // Main export function
    async function exportSelectedCharts() {
      const charts = getChartsToExport();

      if (charts.length === 0) {
        setExportStatus('Please select at least one chart category to export.', 'error');
        return;
      }

      const format = document.getElementById('chartExportFormat').value;
      const mode = document.getElementById('chartExportMode').value;
      const extension = format === 'jpeg' ? 'jpg' : 'png';
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');

      setExportStatus(`Exporting ${charts.length} chart(s)...`, 'progress');

      try {
        if (mode === 'zip') {
          // Export as ZIP
          const zip = new JSZip();
          const imgFolder = zip.folder("charts");

          for (const { name, chart } of charts) {
            const imageData = chartToImage(chart, format);
            // Extract base64 data (remove the data:image/xxx;base64, prefix)
            const base64Data = imageData.split(',')[1];
            imgFolder.file(`${name}.${extension}`, base64Data, { base64: true });
          }

          const zipBlob = await zip.generateAsync({
            type: 'blob',
            compression: 'DEFLATE',
            compressionOptions: { level: 6 }
          });

          // Create download link
          const zipUrl = URL.createObjectURL(zipBlob);
          const link = document.createElement('a');
          link.href = zipUrl;
          link.download = `TRITON_Charts_${timestamp}.zip`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // Cleanup after a delay
          setTimeout(() => URL.revokeObjectURL(zipUrl), 1000);

          setExportStatus(`Successfully exported ${charts.length} chart(s) as ZIP!`, 'success');
        } else {
          // Export individual files
          let exported = 0;
          for (const { name, chart } of charts) {
            const imageData = chartToImage(chart, format);
            downloadFile(imageData, `TRITON_${name}_${timestamp}.${extension}`);
            exported++;

            // Small delay between downloads to prevent browser blocking
            if (exported < charts.length) {
              await new Promise(resolve => setTimeout(resolve, 200));
            }
          }

          setExportStatus(`Successfully exported ${charts.length} chart(s)!`, 'success');
        }
      } catch (error) {
        console.error('Export error:', error);
        setExportStatus(`Export failed: ${error.message}`, 'error');
      }

      // Clear status after 5 seconds
      setTimeout(() => setExportStatus(''), 5000);
    }

    // ==========================================
    // Mission Comparison Functions
    // ==========================================

    let comparisonChart = null;
    let mission1Data = null;
    let mission2Data = null;
    let missionList = [];

    // Load mission list from server
    async function refreshMissionList() {
      const status = document.getElementById('comparisonStatus');
      status.textContent = 'Loading mission list...';
      status.className = 'comparison-status loading';

      try {
        const response = await fetch('/api/missions/list');
        if (!response.ok) throw new Error('Failed to fetch mission list');

        missionList = await response.json();

        // Populate both dropdowns
        const select1 = document.getElementById('mission1Select');
        const select2 = document.getElementById('mission2Select');

        // Clear existing options (except first)
        select1.innerHTML = '<option value="">Select a mission...</option>';
        select2.innerHTML = '<option value="">Select a mission...</option>';

        missionList.forEach(mission => {
          const optionText = `${mission.filename} (${mission.modified})`;
          const optionValue = `${mission.path}/${mission.filename}`;

          select1.innerHTML += `<option value="${optionValue}">${optionText}</option>`;
          select2.innerHTML += `<option value="${optionValue}">${optionText}</option>`;
        });

        status.textContent = `Found ${missionList.length} mission(s)`;
        status.className = 'comparison-status success';
        setTimeout(() => { status.textContent = ''; status.className = 'comparison-status'; }, 3000);

      } catch (error) {
        console.error('Error loading missions:', error);
        status.textContent = `Error: ${error.message}`;
        status.className = 'comparison-status error';
      }
    }

    // Load a specific mission
    async function loadMission(missionNum, filepath) {
      const infoEl = document.getElementById(`mission${missionNum}Info`);
      const status = document.getElementById('comparisonStatus');

      console.log('loadMission called - missionNum:', missionNum, 'filepath:', filepath);

      if (!filepath) {
        if (missionNum == 1) mission1Data = null;
        else mission2Data = null;
        infoEl.textContent = '';
        infoEl.className = 'mission-info';
        updateComparisonChart();
        return;
      }

      infoEl.textContent = 'Loading...';
      status.textContent = `Loading mission ${missionNum}...`;
      status.className = 'comparison-status loading';

      try {
        const response = await fetch(`/api/missions/load/${filepath}`);
        if (!response.ok) throw new Error('Failed to load mission');

        const data = await response.json();

        console.log('Mission data loaded - missionNum:', missionNum, 'rowCount:', data.rowCount);

        if (missionNum == 1) mission1Data = data;
        else mission2Data = data;

        console.log('After assignment - mission1Data:', mission1Data ? 'set' : 'null', 'mission2Data:', mission2Data ? 'set' : 'null');

        infoEl.textContent = `${data.rowCount} data points`;
        infoEl.className = 'mission-info loaded';
        status.textContent = `Mission ${missionNum} loaded successfully`;
        status.className = 'comparison-status success';
        setTimeout(() => { status.textContent = ''; status.className = 'comparison-status'; }, 2000);

        updateComparisonChart();

      } catch (error) {
        console.error('Error loading mission:', error);
        infoEl.textContent = 'Error loading';
        infoEl.className = 'mission-info';
        status.textContent = `Error: ${error.message}`;
        status.className = 'comparison-status error';
      }
    }

    // Handle mission selection
    function onMissionSelect(missionNum) {
      const select = document.getElementById(`mission${missionNum}Select`);
      loadMission(missionNum, select.value);
    }

    // Clear comparison
    function clearComparison() {
      mission1Data = null;
      mission2Data = null;

      document.getElementById('mission1Select').value = '';
      document.getElementById('mission2Select').value = '';
      document.getElementById('mission1Info').textContent = '';
      document.getElementById('mission2Info').textContent = '';
      document.getElementById('mission1Info').className = 'mission-info';
      document.getElementById('mission2Info').className = 'mission-info';
      document.getElementById('includeCurrentData').checked = false;

      updateComparisonChart();
      updateComparisonStats();
    }

    // Helper function to find metric data with flexible key matching
    function getMissionMetric(data, metricKey) {
      if (!data) return [];
      // Direct match
      if (data[metricKey]) return data[metricKey];
      // Try to find matching key (handles encoding differences)
      const normalizedKey = metricKey.toLowerCase().replace(/[^a-z0-9]/g, '');
      for (const key of Object.keys(data)) {
        const normalizedDataKey = key.toLowerCase().replace(/[^a-z0-9]/g, '');
        if (normalizedDataKey === normalizedKey) {
          return data[key];
        }
      }
      return [];
    }

    // Update comparison chart
    function updateComparisonChart() {
      const metric = document.getElementById('compareMetricSelect').value;
      const includeCurrent = document.getElementById('includeCurrentData').checked;

      const datasets = [];
      const computedStyle = getComputedStyle(document.documentElement);

      console.log('updateComparisonChart called');
      console.log('metric:', metric);
      console.log('mission1Data:', mission1Data ? mission1Data.filename : 'null');
      console.log('mission2Data:', mission2Data ? mission2Data.filename : 'null');

      // Mission 1 data (blue, solid)
      if (mission1Data && mission1Data.data) {
        const elapsed = getMissionMetric(mission1Data.data, 'Elapsed [s]') || getMissionMetric(mission1Data.data, 'MET [s]') || [];
        const values = getMissionMetric(mission1Data.data, metric);
        console.log('Mission 1 - elapsed length:', elapsed.length, 'values length:', values.length);

        if (elapsed.length > 0 && values.length > 0) {
          datasets.push({
            label: `Mission 1: ${mission1Data.filename}`,
            data: values.map((v, i) => ({ x: elapsed[i], y: v })),
            borderColor: '#3b82f6',
            backgroundColor: '#3b82f620',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 5,
            tension: 0.3,
            borderDash: [],
          });
        }
      }

      // Mission 2 data (orange, dashed)
      if (mission2Data && mission2Data.data) {
        const elapsed = getMissionMetric(mission2Data.data, 'Elapsed [s]') || getMissionMetric(mission2Data.data, 'MET [s]') || [];
        const values = getMissionMetric(mission2Data.data, metric);
        console.log('Mission 2 - elapsed length:', elapsed.length, 'values length:', values.length);

        if (elapsed.length > 0 && values.length > 0) {
          datasets.push({
            label: `Mission 2: ${mission2Data.filename}`,
            data: values.map((v, i) => ({ x: elapsed[i], y: v })),
            borderColor: '#f97316',
            backgroundColor: '#f9731620',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 5,
            tension: 0.3,
            borderDash: [8, 4],
          });
        }
      }

      console.log('Total datasets:', datasets.length);

      // Current live data (green, dotted)
      if (includeCurrent && fullHistory && fullHistory['Elapsed [s]']) {
        const elapsed = fullHistory['Elapsed [s]'] || [];
        const values = fullHistory[metric] || [];

        if (elapsed.length > 0 && values.length > 0) {
          datasets.push({
            label: 'Current (Live)',
            data: values.map((v, i) => ({ x: elapsed[i], y: v })),
            borderColor: '#22c55e',
            backgroundColor: '#22c55e20',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 5,
            tension: 0.3,
            borderDash: [3, 3],
          });
        }
      }

      // Create or update chart
      if (comparisonChart) {
        comparisonChart.data.datasets = datasets;
        comparisonChart.options.scales.y.title.text = metric;
        comparisonChart.update();
      } else {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        comparisonChart = new Chart(ctx, {
          type: 'line',
          data: { datasets },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                type: 'linear',
                title: {
                  display: true,
                  text: 'Elapsed [s]',
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
              },
              y: {
                type: 'linear',
                title: {
                  display: true,
                  text: metric,
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
              }
            },
            plugins: {
              legend: {
                labels: { color: computedStyle.getPropertyValue('--color-text-primary').trim() }
              },
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: computedStyle.getPropertyValue('--color-primary').trim(),
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                displayColors: true,
                callbacks: {
                  title: function(context) {
                    return `Time: ${parseFloat(context[0].parsed.x).toFixed(2)}s`;
                  },
                  label: function(context) {
                    return ` ${context.dataset.label}: ${parseFloat(context.parsed.y).toFixed(3)}`;
                  }
                }
              },
              zoom: {
                pan: {
                  enabled: true,
                  mode: 'x',
                  modifierKey: 'ctrl',
                },
                zoom: {
                  wheel: { enabled: false },
                  pinch: { enabled: true },
                  drag: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 170, 255, 0.15)',
                    borderColor: 'rgba(0, 170, 255, 0.8)',
                    borderWidth: 1,
                  },
                  mode: 'x',
                }
              }
            }
          }
        });
      }

      // Update statistics table
      updateComparisonStats();
    }

    // Update comparison statistics table
    function updateComparisonStats() {
      const metric = document.getElementById('compareMetricSelect').value;
      const includeCurrent = document.getElementById('includeCurrentData').checked;
      const tbody = document.getElementById('comparisonStatsBody');

      // Calculate stats for each mission
      const stats1 = mission1Data ? calculateMissionStats(mission1Data.data, metric) : null;
      const stats2 = mission2Data ? calculateMissionStats(mission2Data.data, metric) : null;
      const statsCurrent = (includeCurrent && fullHistory) ? calculateMissionStats(fullHistory, metric) : null;

      if (!stats1 && !stats2 && !statsCurrent) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--color-text-muted);">Select missions to compare</td></tr>';
        return;
      }

      const statNames = ['Min', 'Max', 'Average', 'Median', 'Std Dev', 'Data Points'];
      const statKeys = ['min', 'max', 'avg', 'median', 'stdDev', 'count'];

      let html = '';
      statKeys.forEach((key, i) => {
        const v1 = stats1 ? stats1[key] : '-';
        const v2 = stats2 ? stats2[key] : '-';
        const vCurrent = statsCurrent ? statsCurrent[key] : '-';

        // Calculate difference
        let diff = '-';
        let diffClass = 'neutral';
        if (stats1 && stats2 && key !== 'count') {
          const d = stats1[key] - stats2[key];
          diff = d > 0 ? `+${d.toFixed(3)}` : d.toFixed(3);
          diffClass = d > 0 ? 'positive' : (d < 0 ? 'negative' : 'neutral');
        }

        html += `<tr>
          <td>${statNames[i]}</td>
          <td>${typeof v1 === 'number' ? v1.toFixed(3) : v1}</td>
          <td>${typeof v2 === 'number' ? v2.toFixed(3) : v2}</td>
          <td class="${diffClass}">${diff}</td>
          <td>${typeof vCurrent === 'number' ? vCurrent.toFixed(3) : vCurrent}</td>
        </tr>`;
      });

      tbody.innerHTML = html;
    }

    // Calculate statistics for a mission
    function calculateMissionStats(data, metric) {
      const values = getMissionMetric(data, metric);
      if (!values || values.length === 0) return null;

      const numericValues = values.filter(v => typeof v === 'number' && !isNaN(v));
      if (numericValues.length === 0) return null;

      const n = numericValues.length;
      const sorted = [...numericValues].sort((a, b) => a - b);

      const min = sorted[0];
      const max = sorted[n - 1];
      const sum = numericValues.reduce((a, b) => a + b, 0);
      const avg = sum / n;

      const median = n % 2 === 0
        ? (sorted[n / 2 - 1] + sorted[n / 2]) / 2
        : sorted[Math.floor(n / 2)];

      const variance = numericValues.reduce((acc, v) => acc + Math.pow(v - avg, 2), 0) / n;
      const stdDev = Math.sqrt(variance);

      return { min, max, avg, median, stdDev, count: n };
    }

    // Comparison chart controls
    function resetComparisonZoom() {
      if (comparisonChart && comparisonChart.resetZoom) {
        comparisonChart.resetZoom();
      }
    }

    function zoomComparisonChart(direction) {
      if (!comparisonChart) return;
      const zoomFactor = direction === 'in' ? 1.2 : 0.8;
      comparisonChart.zoom(zoomFactor);
    }

    function panComparisonChart(direction) {
      if (!comparisonChart) return;
      const panAmount = 50;
      let deltaX = 0;
      if (direction === 'left') deltaX = panAmount;
      else if (direction === 'right') deltaX = -panAmount;
      comparisonChart.pan({x: deltaX, y: 0}, undefined, 'default');
    }

    // ==========================================
    // Mission Replay/Playback Controller
    // ==========================================

    class PlaybackController {
      constructor() {
        this.missionData = null;
        this.isPlaying = false;
        this.isPaused = false;
        this.currentIndex = 0;
        this.speed = 1;
        this.loop = false;
        this.playbackInterval = null;
        this.baseInterval = 1000; // 1 second base interval between data points
        this.isPlaybackMode = false;

        // Cache DOM elements
        this.elements = {
          missionSelect: document.getElementById('playbackMissionSelect'),
          missionInfo: document.getElementById('playbackMissionInfo'),
          playBtn: document.getElementById('playbackPlayBtn'),
          stopBtn: document.getElementById('playbackStopBtn'),
          prevBtn: document.getElementById('playbackPrevBtn'),
          nextBtn: document.getElementById('playbackNextBtn'),
          seekSlider: document.getElementById('playbackSeek'),
          currentTime: document.getElementById('playbackCurrentTime'),
          totalTime: document.getElementById('playbackTotalTime'),
          loopToggle: document.getElementById('playbackLoopToggle'),
          status: document.getElementById('playbackStatus'),
          modeIndicator: document.getElementById('modeIndicator'),
          returnLiveBtn: document.getElementById('returnLiveBtn')
        };

        // Initialize
        this.refreshMissions();
      }

      async refreshMissions() {
        this.setStatus('Loading missions...', true);

        try {
          const response = await fetch('/api/missions/list');
          if (!response.ok) throw new Error('Failed to fetch mission list');

          const missions = await response.json();

          // Populate dropdown
          const select = this.elements.missionSelect;
          select.innerHTML = '<option value="">Choose a recorded mission...</option>';

          missions.forEach(mission => {
            const optionText = `${mission.filename} (${mission.modified})`;
            const optionValue = `${mission.path}/${mission.filename}`;
            select.innerHTML += `<option value="${optionValue}">${optionText}</option>`;
          });

          this.setStatus(`Found ${missions.length} mission(s)`);
          setTimeout(() => this.setStatus(''), 2000);

        } catch (error) {
          console.error('Error loading missions:', error);
          this.setStatus(`Error: ${error.message}`);
        }
      }

      async onMissionSelect() {
        const filepath = this.elements.missionSelect.value;

        if (!filepath) {
          this.missionData = null;
          this.elements.missionInfo.textContent = '';
          this.elements.missionInfo.className = 'playback-info';
          this.disableControls();
          return;
        }

        this.setStatus('Loading mission...', true);
        this.elements.missionInfo.textContent = 'Loading...';

        try {
          const response = await fetch(`/api/missions/load/${filepath}`);
          if (!response.ok) throw new Error('Failed to load mission');

          this.missionData = await response.json();

          const elapsed = this.getMissionElapsed();
          const totalTime = elapsed.length > 0 ? elapsed[elapsed.length - 1] : 0;

          this.elements.missionInfo.textContent = `${this.missionData.rowCount} data points | Duration: ${totalTime.toFixed(1)}s`;
          this.elements.missionInfo.className = 'playback-info loaded';

          // Setup seek slider
          this.elements.seekSlider.max = elapsed.length - 1;
          this.elements.seekSlider.value = 0;
          this.elements.totalTime.textContent = `${totalTime.toFixed(2)}s`;
          this.elements.currentTime.textContent = '0.00s';

          // Enable controls
          this.enableControls();
          this.currentIndex = 0;

          this.setStatus(`Mission loaded: ${this.missionData.filename}`);
          setTimeout(() => this.setStatus('Ready to play'), 2000);

        } catch (error) {
          console.error('Error loading mission:', error);
          this.elements.missionInfo.textContent = 'Error loading';
          this.elements.missionInfo.className = 'playback-info';
          this.setStatus(`Error: ${error.message}`);
          this.disableControls();
        }
      }

      getMissionElapsed() {
        if (!this.missionData || !this.missionData.data) return [];
        return getMissionMetric(this.missionData.data, 'Elapsed [s]') ||
               getMissionMetric(this.missionData.data, 'MET [s]') || [];
      }

      enableControls() {
        this.elements.playBtn.disabled = false;
        this.elements.stopBtn.disabled = false;
        this.elements.prevBtn.disabled = false;
        this.elements.nextBtn.disabled = false;
        this.elements.seekSlider.disabled = false;
      }

      disableControls() {
        this.elements.playBtn.disabled = true;
        this.elements.stopBtn.disabled = true;
        this.elements.prevBtn.disabled = true;
        this.elements.nextBtn.disabled = true;
        this.elements.seekSlider.disabled = true;
      }

      togglePlay() {
        if (!this.missionData) return;

        if (this.isPlaying) {
          this.pause();
        } else {
          this.play();
        }
      }

      play() {
        if (!this.missionData) return;

        // Enter playback mode
        this.enterPlaybackMode();

        this.isPlaying = true;
        this.isPaused = false;
        this.elements.playBtn.textContent = '';
        this.elements.playBtn.title = 'Pause';

        const elapsed = this.getMissionElapsed();

        // If at end, restart
        if (this.currentIndex >= elapsed.length - 1) {
          this.currentIndex = 0;
        }

        this.setStatus('Playing...', true);

        // Start playback interval
        const interval = this.baseInterval / this.speed;
        this.playbackInterval = setInterval(() => {
          this.advanceFrame();
        }, interval);

        // Show current frame immediately
        this.updateDisplay();
      }

      pause() {
        this.isPlaying = false;
        this.isPaused = true;
        this.elements.playBtn.textContent = '';
        this.elements.playBtn.title = 'Play';

        if (this.playbackInterval) {
          clearInterval(this.playbackInterval);
          this.playbackInterval = null;
        }

        this.setStatus('Paused');
      }

      stop() {
        this.isPlaying = false;
        this.isPaused = false;
        this.currentIndex = 0;
        this.elements.playBtn.textContent = '';
        this.elements.playBtn.title = 'Play';

        if (this.playbackInterval) {
          clearInterval(this.playbackInterval);
          this.playbackInterval = null;
        }

        this.updateSeekPosition();
        this.setStatus('Stopped');

        // Update display with first frame
        this.updateDisplay();
      }

      advanceFrame() {
        const elapsed = this.getMissionElapsed();

        if (this.currentIndex < elapsed.length - 1) {
          this.currentIndex++;
          this.updateSeekPosition();
          this.updateDisplay();
        } else {
          // End of playback
          if (this.loop) {
            this.currentIndex = 0;
            this.updateSeekPosition();
            this.updateDisplay();
            this.setStatus('Looping...', true);
          } else {
            this.pause();
            this.setStatus('Playback complete');
          }
        }
      }

      stepForward() {
        if (!this.missionData) return;

        const elapsed = this.getMissionElapsed();
        if (this.currentIndex < elapsed.length - 1) {
          this.currentIndex++;
          this.updateSeekPosition();

          // Enter playback mode if not already
          if (!this.isPlaybackMode) {
            this.enterPlaybackMode();
          }

          this.updateDisplay();
        }
      }

      stepBackward() {
        if (!this.missionData) return;

        if (this.currentIndex > 0) {
          this.currentIndex--;
          this.updateSeekPosition();

          // Enter playback mode if not already
          if (!this.isPlaybackMode) {
            this.enterPlaybackMode();
          }

          this.updateDisplay();
        }
      }

      onSeek(value) {
        if (!this.missionData) return;

        this.currentIndex = parseInt(value);

        // Enter playback mode if not already
        if (!this.isPlaybackMode) {
          this.enterPlaybackMode();
        }

        this.updateSeekPosition();
        this.updateDisplay();
      }

      updateSeekPosition() {
        const elapsed = this.getMissionElapsed();
        this.elements.seekSlider.value = this.currentIndex;

        if (elapsed.length > 0 && this.currentIndex < elapsed.length) {
          this.elements.currentTime.textContent = `${elapsed[this.currentIndex].toFixed(2)}s`;
        }
      }

      setSpeed(speed) {
        this.speed = speed;

        // Update button states
        document.querySelectorAll('.speed-btn').forEach(btn => {
          btn.classList.remove('active');
          if (parseFloat(btn.dataset.speed) === speed) {
            btn.classList.add('active');
          }
        });

        // If playing, restart interval with new speed
        if (this.isPlaying) {
          if (this.playbackInterval) {
            clearInterval(this.playbackInterval);
          }
          const interval = this.baseInterval / this.speed;
          this.playbackInterval = setInterval(() => {
            this.advanceFrame();
          }, interval);
        }

        this.setStatus(`Speed: ${speed}x`);
        setTimeout(() => {
          if (this.isPlaying) this.setStatus('Playing...', true);
          else if (this.isPaused) this.setStatus('Paused');
          else this.setStatus('');
        }, 1000);
      }

      toggleLoop() {
        this.loop = !this.loop;
        this.elements.loopToggle.classList.toggle('active', this.loop);

        this.setStatus(this.loop ? 'Loop enabled' : 'Loop disabled');
        setTimeout(() => {
          if (this.isPlaying) this.setStatus('Playing...', true);
          else if (this.isPaused) this.setStatus('Paused');
          else this.setStatus('');
        }, 1000);
      }

      enterPlaybackMode() {
        if (this.isPlaybackMode) return;

        this.isPlaybackMode = true;

        // Update mode indicator
        this.elements.modeIndicator.className = 'playback-mode-indicator playback';
        this.elements.modeIndicator.querySelector('.mode-text').textContent = 'PLAYBACK';

        // Show return to live button
        this.elements.returnLiveBtn.style.display = 'inline-block';

        // Stop live data fetching
        if (window.liveDataInterval) {
          clearInterval(window.liveDataInterval);
          window.liveDataInterval = null;
        }
      }

      returnToLive() {
        // Stop playback
        if (this.playbackInterval) {
          clearInterval(this.playbackInterval);
          this.playbackInterval = null;
        }

        this.isPlaying = false;
        this.isPaused = false;
        this.isPlaybackMode = false;
        this.currentIndex = 0;
        this.elements.playBtn.textContent = '';
        this.elements.playBtn.title = 'Play';

        // Update mode indicator
        this.elements.modeIndicator.className = 'playback-mode-indicator live';
        this.elements.modeIndicator.querySelector('.mode-text').textContent = 'LIVE';

        // Hide return to live button
        this.elements.returnLiveBtn.style.display = 'none';

        // Reset mission selection
        this.elements.missionSelect.value = '';
        this.missionData = null;
        this.elements.missionInfo.textContent = '';
        this.elements.missionInfo.className = 'playback-info';
        this.disableControls();

        // Restart live data fetching
        window.liveDataInterval = setInterval(fetchData, 1000);
        fetchData(); // Fetch immediately

        this.setStatus('Returned to live mode');
        setTimeout(() => this.setStatus(''), 2000);
      }

      updateDisplay() {
        if (!this.missionData || !this.missionData.data) return;

        const elapsed = this.getMissionElapsed();
        if (this.currentIndex >= elapsed.length) return;

        // Build history object with data up to current index, using normalized keys
        const playbackHistory = {
          'Elapsed [s]': elapsed.slice(0, this.currentIndex + 1)
        };

        // Map each field using getMissionMetric for flexible key matching
        for (const fieldKey of Object.keys(fields)) {
          const fullData = getMissionMetric(this.missionData.data, fieldKey);
          if (fullData && fullData.length > 0) {
            playbackHistory[fieldKey] = fullData.slice(0, this.currentIndex + 1);
          }
        }

        // Update charts with playback data
        const filteredHistory = filterDataByTimeRange(playbackHistory, currentTimeFilter);
        const elapsedFiltered = filteredHistory["Elapsed [s]"] || [];

        for (const [id, group] of Object.entries(fields)) {
          const values = filteredHistory[id] || [];
          if (chartRefs[id]) {
            chartRefs[id].data.labels = elapsedFiltered;
            chartRefs[id].data.datasets[0].data = values;
            chartRefs[id].update('none');
          }
        }

        // Update statistics
        const bmeRows = [], mpuRows = [];
        for (const [id, group] of Object.entries(fields)) {
          const values = filteredHistory[id] || [];
          const stats = computeExtendedStats(values, elapsedFiltered);
          const row = `<tr>
            <td>${id}</td>
            <td>${stats.min}</td>
            <td>${stats.max}</td>
            <td>${stats.avg}</td>
            <td>${stats.median}</td>
            <td>${stats.stdDev}</td>
            <td>${stats.p25}</td>
            <td>${stats.p75}</td>
            <td>${stats.p95}</td>
            <td>${formatRateWithColor(stats.ratePerSec)}</td>
          </tr>`;
          (group === "bme" ? bmeRows : mpuRows).push(row);
        }

        document.getElementById("bmeSummary").innerHTML = bmeRows.join("");
        document.getElementById("mpuSummary").innerHTML = mpuRows.join("");

        // Update stats meta
        const totalPoints = elapsed.length;
        const filteredPoints = elapsedFiltered.length;
        updateFilterInfo(totalPoints, filteredPoints);
        updateStatsMeta(totalPoints, filteredPoints, elapsedFiltered);
      }

      setStatus(message, active = false) {
        this.elements.status.textContent = message;
        this.elements.status.className = active ? 'playback-status active' : 'playback-status';
      }
    }

    // Global playback controller instance
    let playbackController;

    // Time Range Filter Functions
    function filterDataByTimeRange(history, filter) {
      const elapsed = history["Elapsed [s]"] || [];
      if (!elapsed.length) return history;

      let startIdx = 0;
      let endIdx = elapsed.length - 1;

      if (filter.type === 'all') {
        // Return all data
        return history;
      } else if (filter.type === 'preset') {
        // Filter to last N seconds
        const maxTime = elapsed[elapsed.length - 1];
        const minTime = maxTime - filter.value;
        startIdx = elapsed.findIndex(t => t >= minTime);
        if (startIdx === -1) startIdx = 0;
      } else if (filter.type === 'custom') {
        // Filter to custom range
        const { from, to } = filter.value;
        startIdx = elapsed.findIndex(t => t >= from);
        if (startIdx === -1) startIdx = 0;
        endIdx = elapsed.findIndex(t => t > to);
        if (endIdx === -1) endIdx = elapsed.length;
        else endIdx = endIdx - 1;
      }

      // Create filtered history
      const filteredHistory = {};
      for (const key in history) {
        if (Array.isArray(history[key])) {
          filteredHistory[key] = history[key].slice(startIdx, endIdx + 1);
        } else {
          filteredHistory[key] = history[key];
        }
      }

      return filteredHistory;
    }

    function setTimeFilter(preset) {
      // Update active button
      document.querySelectorAll('.time-preset-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.preset === String(preset)) {
          btn.classList.add('active');
        }
      });

      // Update custom range container
      const customContainer = document.getElementById('customRangeContainer');
      customContainer.classList.remove('active');

      // Clear custom inputs
      document.getElementById('customFromTime').value = '';
      document.getElementById('customToTime').value = '';

      // Set filter
      if (preset === 'all') {
        currentTimeFilter = { type: 'all', value: null };
        updateTimeRangeDisplay('All');
      } else {
        currentTimeFilter = { type: 'preset', value: preset };
        updateTimeRangeDisplay(`Last ${formatDuration(preset)}`);
      }

      // Refresh display with new filter
      updateFilteredDisplay();
    }

    function applyCustomRange() {
      const fromInput = document.getElementById('customFromTime');
      const toInput = document.getElementById('customToTime');

      const from = parseFloat(fromInput.value);
      const to = parseFloat(toInput.value);

      // Validation
      if (isNaN(from) && isNaN(to)) {
        // If both empty, show all
        setTimeFilter('all');
        return;
      }

      const elapsed = fullHistory["Elapsed [s]"] || [];
      const maxTime = elapsed.length ? elapsed[elapsed.length - 1] : 0;
      const minTime = elapsed.length ? elapsed[0] : 0;

      // Default values if only one is provided
      const validFrom = isNaN(from) ? minTime : Math.max(from, minTime);
      const validTo = isNaN(to) ? maxTime : Math.min(to, maxTime);

      if (validFrom > validTo) {
        alert('Invalid range: "From" must be less than "To"');
        return;
      }

      // Update UI
      document.querySelectorAll('.time-preset-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('customRangeContainer').classList.add('active');

      // Set filter
      currentTimeFilter = {
        type: 'custom',
        value: { from: validFrom, to: validTo }
      };

      updateTimeRangeDisplay(`${validFrom.toFixed(1)}s - ${validTo.toFixed(1)}s`);
      updateFilteredDisplay();
    }

    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds}s`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}min`;
      return `${Math.floor(seconds / 3600)}h`;
    }

    function updateTimeRangeDisplay(text) {
      document.getElementById('currentTimeRange').textContent = text;
    }

    function updateFilterInfo(totalPoints, filteredPoints) {
      document.getElementById('totalPointsCount').textContent = totalPoints;
      document.getElementById('filteredPointsCount').textContent = filteredPoints;
    }

    function updateFilteredDisplay() {
      // Apply filter to full history
      const filteredHistory = filterDataByTimeRange(fullHistory, currentTimeFilter);
      const elapsed = filteredHistory["Elapsed [s]"] || [];
      const bmeRows = [], mpuRows = [];

      // Update charts and statistics with filtered data
      for (const [id, group] of Object.entries(fields)) {
        const values = filteredHistory[id] || [];
        if (chartRefs[id]) {
          chartRefs[id].data.labels = elapsed;
          chartRefs[id].data.datasets[0].data = values;
          chartRefs[id].update('none');
        }

        // Use extended statistics
        const stats = computeExtendedStats(values, elapsed);
        const row = `<tr>
          <td>${id}</td>
          <td>${stats.min}</td>
          <td>${stats.max}</td>
          <td>${stats.avg}</td>
          <td>${stats.median}</td>
          <td>${stats.stdDev}</td>
          <td>${stats.p25}</td>
          <td>${stats.p75}</td>
          <td>${stats.p95}</td>
          <td>${formatRateWithColor(stats.ratePerSec)}</td>
        </tr>`;
        (group === "bme" ? bmeRows : mpuRows).push(row);
      }

      document.getElementById("bmeSummary").innerHTML = bmeRows.join("");
      document.getElementById("mpuSummary").innerHTML = mpuRows.join("");

      // Update filter info
      const totalPoints = (fullHistory["Elapsed [s]"] || []).length;
      const filteredPoints = elapsed.length;
      updateFilterInfo(totalPoints, filteredPoints);

      // Update stats meta information
      updateStatsMeta(totalPoints, filteredPoints, elapsed);

      // Update 3D orientation visualization with latest gyro data
      if (orientationVis && orientationVis.isInitialized) {
        const gyroX = filteredHistory["Gyro x [/s]"] || [];
        const gyroY = filteredHistory["Gyro y [/s]"] || [];
        const gyroZ = filteredHistory["Gyro z [/s]"] || [];

        if (gyroX.length > 0) {
          // Get the latest gyro values
          const latestGyroX = gyroX[gyroX.length - 1];
          const latestGyroY = gyroY[gyroY.length - 1];
          const latestGyroZ = gyroZ[gyroZ.length - 1];

          // Update the 3D visualization with current gyro rates
          orientationVis.updateFromGyro(latestGyroX, latestGyroY, latestGyroZ, Date.now());
        }
      }
    }

    // Export Filter Functions (separate from display filter)
    function setExportFilter(preset) {
      // Update active button (only export preset buttons)
      document.querySelectorAll('[data-export-preset]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.exportPreset === String(preset)) {
          btn.classList.add('active');
        }
      });

      // Update custom range container
      const customContainer = document.getElementById('exportCustomRangeContainer');
      customContainer.classList.remove('active');

      // Clear custom inputs
      document.getElementById('exportFromTime').value = '';
      document.getElementById('exportToTime').value = '';

      // Set filter
      if (preset === 'all') {
        exportTimeFilter = { type: 'all', value: null };
        updateExportRangeDisplay('All');
      } else {
        exportTimeFilter = { type: 'preset', value: preset };
        updateExportRangeDisplay(`Last ${formatDuration(preset)}`);
      }

      // Update export info
      updateExportFilterInfo();
    }

    function applyExportCustomRange() {
      const fromInput = document.getElementById('exportFromTime');
      const toInput = document.getElementById('exportToTime');

      const from = parseFloat(fromInput.value);
      const to = parseFloat(toInput.value);

      // Validation
      if (isNaN(from) && isNaN(to)) {
        setExportFilter('all');
        return;
      }

      const elapsed = fullHistory["Elapsed [s]"] || [];
      const maxTime = elapsed.length ? elapsed[elapsed.length - 1] : 0;
      const minTime = elapsed.length ? elapsed[0] : 0;

      const validFrom = isNaN(from) ? minTime : Math.max(from, minTime);
      const validTo = isNaN(to) ? maxTime : Math.min(to, maxTime);

      if (validFrom > validTo) {
        alert('Invalid range: "From" must be less than "To"');
        return;
      }

      // Update UI
      document.querySelectorAll('[data-export-preset]').forEach(btn => btn.classList.remove('active'));
      document.getElementById('exportCustomRangeContainer').classList.add('active');

      // Set filter
      exportTimeFilter = {
        type: 'custom',
        value: { from: validFrom, to: validTo }
      };

      updateExportRangeDisplay(`${validFrom.toFixed(1)}s - ${validTo.toFixed(1)}s`);
      updateExportFilterInfo();
    }

    function updateExportRangeDisplay(text) {
      document.getElementById('exportTimeRange').textContent = text;
    }

    function updateExportFilterInfo() {
      const filteredHistory = filterDataByTimeRange(fullHistory, exportTimeFilter);
      const exportPoints = (filteredHistory["Elapsed [s]"] || []).length;
      document.getElementById('exportPointsCount').textContent = exportPoints;

      // Disable export button if no data
      const exportBtn = document.getElementById('exportFilteredBtn');
      exportBtn.disabled = exportPoints === 0;

      // Also update the data format export preview
      if (typeof updateExportRangePreview === 'function') {
        updateExportRangePreview();
      }
    }

    function exportFilteredData() {
      const filteredHistory = filterDataByTimeRange(fullHistory, exportTimeFilter);
      const elapsed = filteredHistory["Elapsed [s]"] || [];

      if (elapsed.length === 0) {
        alert('No data to export');
        return;
      }

      // Build CSV content
      const headers = ["Elapsed [s]", ...Object.keys(fields)];
      let csv = headers.join(",") + "\n";

      for (let i = 0; i < elapsed.length; i++) {
        const row = [elapsed[i].toFixed(3)];
        for (const field of Object.keys(fields)) {
          const values = filteredHistory[field] || [];
          row.push(values[i] !== undefined ? values[i].toFixed(3) : '');
        }
        csv += row.join(",") + "\n";
      }

      // Create download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;

      // Generate filename with filter info
      let filename = 'triton_filtered_';
      if (exportTimeFilter.type === 'all') {
        filename += 'all';
      } else if (exportTimeFilter.type === 'preset') {
        filename += `last_${exportTimeFilter.value}s`;
      } else {
        filename += `${exportTimeFilter.value.from.toFixed(0)}-${exportTimeFilter.value.to.toFixed(0)}s`;
      }
      filename += `_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.csv`;

      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Export data in multiple formats (JSON, Excel, PDF)
    async function exportDataFormat(format) {
      const statusEl = document.getElementById('dataExportStatus');
      statusEl.className = 'export-status';
      statusEl.textContent = `Preparing ${format.toUpperCase()} export...`;

      // Build query params based on time filter
      let queryParams = '';
      const useTimeRange = document.getElementById('useExportTimeRange').checked;

      if (useTimeRange && exportTimeFilter.type !== 'all') {
        const elapsed = fullHistory["Elapsed [s]"] || [];
        if (elapsed.length > 0) {
          let start = null;
          let end = null;

          if (exportTimeFilter.type === 'preset') {
            // Get last N seconds
            const maxTime = Math.max(...elapsed);
            start = Math.max(0, maxTime - exportTimeFilter.value);
            end = maxTime;
          } else if (exportTimeFilter.type === 'custom' && exportTimeFilter.value) {
            start = exportTimeFilter.value.from;
            end = exportTimeFilter.value.to;
          }

          if (start !== null) queryParams += `?start=${start}`;
          if (end !== null) queryParams += `${queryParams ? '&' : '?'}end=${end}`;
        }
      }

      try {
        const response = await fetch(`/export/${format}${queryParams}`);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Export failed with status ${response.status}`);
        }

        // Get filename from Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `triton_export.${format === 'excel' ? 'xlsx' : format}`;
        if (contentDisposition) {
          const match = contentDisposition.match(/filename=([^;]+)/);
          if (match) filename = match[1].trim();
        }

        // Download the file
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        statusEl.className = 'export-status success';
        statusEl.textContent = `${format.toUpperCase()} exported successfully!`;

        // Clear status after 3 seconds
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.className = 'export-status';
        }, 3000);

      } catch (error) {
        statusEl.className = 'export-status error';
        statusEl.textContent = `Export failed: ${error.message}`;
        console.error('Export error:', error);
      }
    }

    // Update export range preview
    function updateExportRangePreview() {
      const previewEl = document.getElementById('exportRangePreview');
      const useTimeRange = document.getElementById('useExportTimeRange').checked;

      if (!useTimeRange || exportTimeFilter.type === 'all') {
        previewEl.textContent = 'All data';
        return;
      }

      const elapsed = fullHistory["Elapsed [s]"] || [];
      if (elapsed.length === 0) {
        previewEl.textContent = 'No data';
        return;
      }

      if (exportTimeFilter.type === 'preset') {
        const maxTime = Math.max(...elapsed);
        const start = Math.max(0, maxTime - exportTimeFilter.value);
        previewEl.textContent = `${start.toFixed(1)}s - ${maxTime.toFixed(1)}s`;
      } else if (exportTimeFilter.type === 'custom' && exportTimeFilter.value) {
        previewEl.textContent = `${exportTimeFilter.value.from.toFixed(1)}s - ${exportTimeFilter.value.to.toFixed(1)}s`;
      } else {
        previewEl.textContent = 'All data';
      }
    }

    // Setup export range preview listener
    document.addEventListener('DOMContentLoaded', function() {
      const checkbox = document.getElementById('useExportTimeRange');
      if (checkbox) {
        checkbox.addEventListener('change', updateExportRangePreview);
      }
    });

    async function fetchData() {
      const res = await fetch("/data");
      const json = await res.json();

      // Store full history
      fullHistory = json.history;

      // Initialize charts if not already created
      for (const [id, group] of Object.entries(fields)) {
        if (!chartRefs[id]) {
          chartRefs[id] = createChart(id, id);
        }
      }

      // Apply time filter and update display
      updateFilteredDisplay();

      // Update export filter info as well
      updateExportFilterInfo();
    }

    async function loadArchivedLogs() {
      const res = await fetch("/download/list");
      const logs = await res.json();
      const select = document.getElementById("logSelect");
      logs.forEach(item => {
        const opt = document.createElement("option");
        // Handle both old format (string) and new format (object)
        if (typeof item === 'string') {
          opt.value = item;
          opt.textContent = item;
        } else {
          opt.value = item.filename;
          opt.textContent = item.display || item.filename;
        }
        select.appendChild(opt);
      });
    }

    function downloadLatest() {
      window.location.href = "/download/latest";
    }

    function downloadSelected() {
      const file = document.getElementById("logSelect").value;
      if (file) window.location.href = `/download/archive/${encodeURIComponent(file)}`;
    }

    async function openLogsFolder() {
      const folderStatus = document.getElementById("folderStatus");
      
      try {
        folderStatus.textContent = "Opening logs folder...";
        folderStatus.style.color = "#fbbf24";
        
        const response = await fetch("/open_logs_folder", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
          folderStatus.textContent = "Logs folder opened successfully!";
          folderStatus.style.color = "#22c55e";
        } else {
          throw new Error(result.message || "Unknown error");
        }
      } catch (error) {
        folderStatus.textContent = `Error opening folder: ${error.message}`;
        folderStatus.style.color = "#ef4444";
        console.error("Error opening logs folder:", error);
      }
      
      // Clear status message after 3 seconds
      setTimeout(() => {
        folderStatus.textContent = "";
      }, 3000);
    }

    let dataGenerationInterval = null;
    let isGenerating = false;
    let currentSpeed = 10; // Default 10x speed
    const baseInterval = 2000; // Base interval in milliseconds (2 seconds)

    async function generateSingleDataPoint() {
      try {
        const response = await fetch("/generate_random_data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        const result = await response.json();
        if (result.status !== "success") {
          throw new Error(result.message || "Unknown error");
        }
      } catch (error) {
        console.error("Error generating random data:", error);
        // Stop generation on error
        stopDataGeneration();
      }
    }

    function startDataGeneration() {
      if (isGenerating) return;
      
      isGenerating = true;
      const startStopBtn = document.getElementById("startStopBtn");
      const statusSpan = document.getElementById("generateStatus");
      const currentInterval = Math.round(baseInterval / currentSpeed);
      
      startStopBtn.textContent = " Stop Test Data";
      startStopBtn.style.backgroundColor = "#ef4444";
      statusSpan.textContent = ` Generating test data at ${currentSpeed}x speed (${currentInterval}ms intervals)`;
      statusSpan.style.color = "#22c55e";
      
      // Generate data at variable speed based on currentSpeed
      dataGenerationInterval = setInterval(generateSingleDataPoint, currentInterval);
      
      // Generate first data point immediately
      generateSingleDataPoint();
    }

    function stopDataGeneration() {
      if (!isGenerating) return;
      
      isGenerating = false;
      const startStopBtn = document.getElementById("startStopBtn");
      const statusSpan = document.getElementById("generateStatus");
      
      if (dataGenerationInterval) {
        clearInterval(dataGenerationInterval);
        dataGenerationInterval = null;
      }
      
      startStopBtn.textContent = "Start Test Data";
      startStopBtn.style.backgroundColor = "#38bdf8";
      statusSpan.textContent = " Test data generation stopped";
      statusSpan.style.color = "#fbbf24";
      
      // Clear status message after 3 seconds
      setTimeout(() => {
        if (!isGenerating) statusSpan.textContent = "";
      }, 3000);
    }

    function toggleDataGeneration() {
      if (isGenerating) {
        stopDataGeneration();
      } else {
        startDataGeneration();
      }
    }

    function updateSpeed() {
      const speedSelect = document.getElementById("speedSelect");
      currentSpeed = parseFloat(speedSelect.value);
      
      // If data generation is running, restart with new speed
      if (isGenerating) {
        stopDataGeneration();
        startDataGeneration();
      }
    }

    async function clearTestData() {
      const clearBtn = document.getElementById("clearBtn");
      const statusSpan = document.getElementById("generateStatus");
      
      // Stop data generation first
      if (isGenerating) {
        stopDataGeneration();
      }
      
      clearBtn.disabled = true;
      clearBtn.textContent = "Clearing...";
      
      try {
        const response = await fetch("/clear_test_data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
          statusSpan.textContent = "All test data cleared!";
          statusSpan.style.color = "#22c55e";
          // Clear status message after 3 seconds
          setTimeout(() => {
            statusSpan.textContent = "";
          }, 3000);
        } else {
          throw new Error(result.message || "Unknown error");
        }
      } catch (error) {
        statusSpan.textContent = "Error clearing data";
        statusSpan.style.color = "#ef4444";
        console.error("Error clearing test data:", error);
      } finally {
        clearBtn.disabled = false;
        clearBtn.textContent = "Clear Data";
      }
    }

    // ==================== Recording Functions ====================

    let isRecording = false;
    let recordingStartTime = null;
    let recordingTimerInterval = null;
    let recordingPointCount = 0;

    async function toggleRecording() {
      if (isRecording) {
        await stopRecording();
      } else {
        await startRecording();
      }
    }

    async function startRecording() {
      const recordBtn = document.getElementById('recordBtn');
      const recordBtnText = document.getElementById('recordBtnText');
      const recordingStatus = document.getElementById('recordingStatus');

      try {
        const response = await fetch('/recording/start', { method: 'POST' });
        const result = await response.json();

        if (result.status === 'success') {
          isRecording = true;
          recordingStartTime = Date.now();
          recordingPointCount = 0;

          recordBtn.classList.add('recording');
          recordBtnText.textContent = 'Stop Recording';
          recordingStatus.style.display = 'flex';
          recordingStatus.classList.add('active');

          // Update nav link indicator
          document.getElementById('recordingNavLink').classList.add('is-recording');

          // Start timer
          recordingTimerInterval = setInterval(updateRecordingTimer, 1000);
          updateRecordingTimer();

          // Start polling for point count
          pollRecordingStatus();

          console.log('[RECORDING] Started:', result.filename);
        } else {
          alert('Failed to start recording: ' + result.message);
        }
      } catch (error) {
        console.error('Error starting recording:', error);
        alert('Error starting recording');
      }
    }

    async function stopRecording() {
      const recordBtn = document.getElementById('recordBtn');
      const recordBtnText = document.getElementById('recordBtnText');
      const recordingStatus = document.getElementById('recordingStatus');

      try {
        const response = await fetch('/recording/stop', { method: 'POST' });
        const result = await response.json();

        if (result.status === 'success') {
          isRecording = false;

          recordBtn.classList.remove('recording');
          recordBtnText.textContent = 'Start Recording';
          recordingStatus.style.display = 'none';
          recordingStatus.classList.remove('active');

          // Update nav link indicator
          document.getElementById('recordingNavLink').classList.remove('is-recording');

          // Stop timer
          if (recordingTimerInterval) {
            clearInterval(recordingTimerInterval);
            recordingTimerInterval = null;
          }

          // Refresh recordings list
          await refreshRecordingsList();

          console.log('[RECORDING] Stopped:', result.filename, '- Points:', result.point_count);
        } else {
          alert('Failed to stop recording: ' + result.message);
        }
      } catch (error) {
        console.error('Error stopping recording:', error);
        alert('Error stopping recording');
      }
    }

    function updateRecordingTimer() {
      if (!recordingStartTime) return;

      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const seconds = (elapsed % 60).toString().padStart(2, '0');

      document.getElementById('recordingTime').textContent = `${minutes}:${seconds}`;
    }

    async function pollRecordingStatus() {
      if (!isRecording) return;

      try {
        const response = await fetch('/recording/status');
        const status = await response.json();

        if (status.is_recording) {
          recordingPointCount = status.point_count;
          document.getElementById('recordingPoints').textContent = `${status.point_count} points`;

          // Continue polling
          setTimeout(pollRecordingStatus, 1000);
        }
      } catch (error) {
        console.error('Error polling recording status:', error);
      }
    }

    async function refreshRecordingsList() {
      const listContainer = document.getElementById('recordingsList');

      try {
        const response = await fetch('/recordings/list');
        const recordings = await response.json();

        if (recordings.length === 0) {
          listContainer.innerHTML = '<div class="no-recordings">No recordings yet. Click "Start Recording" to begin.</div>';
          return;
        }

        listContainer.innerHTML = recordings.map(rec => `
          <div class="recording-item">
            <div class="recording-info">
              <span class="recording-name">${rec.filename}</span>
              <span class="recording-meta">${rec.modified} | ${rec.point_count} points | ${formatFileSize(rec.size)}</span>
            </div>
            <div class="recording-actions">
              <button onclick="downloadRecording('${rec.filename}')">Download</button>
              <button class="delete-btn" onclick="deleteRecording('${rec.filename}')">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading recordings:', error);
        listContainer.innerHTML = '<div class="no-recordings">Error loading recordings</div>';
      }
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function downloadRecording(filename) {
      window.location.href = `/recordings/download/${encodeURIComponent(filename)}`;
    }

    async function deleteRecording(filename) {
      if (!confirm(`Delete recording "${filename}"?`)) return;

      try {
        const response = await fetch(`/recordings/delete/${encodeURIComponent(filename)}`, {
          method: 'DELETE'
        });
        const result = await response.json();

        if (result.status === 'success') {
          await refreshRecordingsList();
        } else {
          alert('Failed to delete: ' + result.message);
        }
      } catch (error) {
        console.error('Error deleting recording:', error);
        alert('Error deleting recording');
      }
    }

    // Check recording status on page load
    async function checkRecordingStatus() {
      try {
        const response = await fetch('/recording/status');
        const status = await response.json();

        if (status.is_recording) {
          // Recording was in progress, restore UI state
          isRecording = true;
          recordingStartTime = new Date(status.start_time).getTime();
          recordingPointCount = status.point_count;

          const recordBtn = document.getElementById('recordBtn');
          const recordBtnText = document.getElementById('recordBtnText');
          const recordingStatus = document.getElementById('recordingStatus');

          recordBtn.classList.add('recording');
          recordBtnText.textContent = 'Stop Recording';
          recordingStatus.style.display = 'flex';
          recordingStatus.classList.add('active');

          // Update nav link indicator
          document.getElementById('recordingNavLink').classList.add('is-recording');

          recordingTimerInterval = setInterval(updateRecordingTimer, 1000);
          updateRecordingTimer();
          pollRecordingStatus();
        }
      } catch (error) {
        console.error('Error checking recording status:', error);
      }
    }

    // ==================== Motor Control Functions ====================

    // Update throttle display when slider moves
    function updateThrottleDisplay(value) {
      document.getElementById('throttleValue').textContent = value;
      // Highlight matching preset button
      const intValue = parseInt(value);
      document.querySelectorAll('.preset-btn[data-preset]').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.preset) === intValue);
      });
    }

    // Apply throttle from slider
    async function applyThrottle() {
      const throttle = parseInt(document.getElementById('throttleSlider').value);
      await sendMotorCommand('throttle', throttle);
    }

    // Set motor to preset value
    async function setMotorPreset(percent) {
      // If setting to 0 (stop), abort any running ramp test
      if (percent === 0) {
        rampTestAborted = true;
      }

      document.getElementById('throttleSlider').value = percent;
      document.getElementById('throttleValue').textContent = percent;

      // Highlight active preset button
      document.querySelectorAll('.preset-btn[data-preset]').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.preset) === percent);
      });

      await sendMotorCommand('preset', percent);
    }

    // Emergency stop
    async function emergencyStop() {
      // Abort any running ramp test
      rampTestAborted = true;

      document.getElementById('throttleSlider').value = 0;
      document.getElementById('throttleValue').textContent = 0;
      await sendMotorCommand('emergency_stop');
    }

    // Ramp test state
    let rampTestRunning = false;
    let rampTestAborted = false;

    // Run ramp test: 0 -> 100% -> hold 3s -> 0%
    async function runRampTest() {
      const rampBtn = document.getElementById('rampTestBtn');

      // If already running, abort
      if (rampTestRunning) {
        rampTestAborted = true;
        rampBtn.textContent = 'Stopping...';
        return;
      }

      rampTestRunning = true;
      rampTestAborted = false;
      rampBtn.classList.add('running');
      rampBtn.textContent = 'Stop Test';

      const slider = document.getElementById('throttleSlider');
      const throttleDisplay = document.getElementById('throttleValue');

      const rampDuration = 3000; // 3 seconds to ramp up/down
      const holdDuration = 3000; // 3 seconds hold at 100%
      const stepInterval = 50;   // Update every 50ms
      const steps = rampDuration / stepInterval;
      const stepSize = 100 / steps;

      try {
        // Ramp up: 0% -> 100%
        rampBtn.textContent = 'Ramping Up...';
        for (let throttle = 0; throttle <= 100 && !rampTestAborted; throttle += stepSize) {
          const value = Math.min(100, Math.round(throttle));
          slider.value = value;
          throttleDisplay.textContent = value;
          await sendMotorCommand('throttle', value);
          await new Promise(r => setTimeout(r, stepInterval));
        }

        // Hold at 100% for 3 seconds
        if (!rampTestAborted) {
          rampBtn.textContent = 'Holding 100%...';
          slider.value = 100;
          throttleDisplay.textContent = 100;
          await sendMotorCommand('throttle', 100);

          // Wait in small increments to allow abort
          for (let i = 0; i < holdDuration / 100 && !rampTestAborted; i++) {
            await new Promise(r => setTimeout(r, 100));
          }
        }

        // Ramp down: 100% -> 0%
        rampBtn.textContent = 'Ramping Down...';
        for (let throttle = 100; throttle >= 0 && !rampTestAborted; throttle -= stepSize) {
          const value = Math.max(0, Math.round(throttle));
          slider.value = value;
          throttleDisplay.textContent = value;
          await sendMotorCommand('throttle', value);
          await new Promise(r => setTimeout(r, stepInterval));
        }

        // Ensure we end at 0
        slider.value = 0;
        throttleDisplay.textContent = 0;
        await sendMotorCommand('throttle', 0);

      } catch (error) {
        console.error('Ramp test error:', error);
      } finally {
        rampTestRunning = false;
        rampTestAborted = false;
        rampBtn.classList.remove('running');
        rampBtn.textContent = 'Ramp Test';
      }
    }

    // Send motor command to server
    async function sendMotorCommand(type, value = 0) {
      const statusText = document.getElementById('motorStatusText');
      const currentThrottle = document.getElementById('currentThrottle');

      try {
        let endpoint = '/motor/';
        let body = {};

        switch(type) {
          case 'throttle':
            endpoint += 'throttle';
            body = { throttle: value };
            break;
          case 'preset':
            endpoint += `preset/${value}`;
            break;
          case 'stop':
            endpoint += 'stop';
            break;
          case 'emergency_stop':
            endpoint += 'emergency_stop';
            break;
          default:
            throw new Error('Unknown command type');
        }

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: type === 'throttle' ? JSON.stringify(body) : undefined
        });

        const result = await response.json();

        if (result.status === 'success') {
          // Update UI
          if (type === 'emergency_stop') {
            statusText.textContent = 'EMERGENCY STOP';
            statusText.className = 'motor-status-value status-emergency';
            currentThrottle.textContent = '0%';
          } else if (type === 'stop' || value === 0) {
            statusText.textContent = 'Stopped';
            statusText.className = 'motor-status-value status-stopped';
            currentThrottle.textContent = '0%';
          } else {
            statusText.textContent = `Running (${value}%)`;
            statusText.className = 'motor-status-value status-running';
            currentThrottle.textContent = `${value}%`;
          }

        } else {
          throw new Error(result.message || 'Command failed');
        }

      } catch (error) {
        console.error('Motor command error:', error);
        statusText.textContent = 'Error: ' + error.message;
        statusText.className = 'motor-status-value status-disconnected';
      }
    }

    // Poll motor status
    async function pollMotorStatus() {
      try {
        const response = await fetch('/motor/status');
        const status = await response.json();

        const statusText = document.getElementById('motorStatusText');
        const currentThrottle = document.getElementById('currentThrottle');
        const loraConnection = document.getElementById('loraConnection');

        currentThrottle.textContent = `${status.throttle}%`;

        // Update status display
        switch(status.status) {
          case 'running':
            statusText.textContent = `Running (${status.throttle}%)`;
            statusText.className = 'motor-status-value status-running';
            loraConnection.textContent = 'Connected';
            loraConnection.style.color = '#4ade80';
            break;
          case 'stopped':
            statusText.textContent = 'Stopped';
            statusText.className = 'motor-status-value status-stopped';
            loraConnection.textContent = 'Connected';
            loraConnection.style.color = '#4ade80';
            break;
          case 'emergency_stop':
            statusText.textContent = 'EMERGENCY STOP';
            statusText.className = 'motor-status-value status-emergency';
            loraConnection.textContent = 'Connected';
            loraConnection.style.color = '#4ade80';
            break;
          default:
            statusText.textContent = 'Disconnected';
            statusText.className = 'motor-status-value status-disconnected';
            loraConnection.textContent = 'Not connected';
            loraConnection.style.color = '#6b7280';
        }

      } catch (error) {
        const loraConnection = document.getElementById('loraConnection');
        loraConnection.textContent = 'Error';
        loraConnection.style.color = '#ef4444';
      }
    }

    // Start polling motor status every 2 seconds
    setInterval(pollMotorStatus, 2000);

    // Initial status check
    pollMotorStatus();

    // ==================== Configuration Management System ====================

    // Load configuration from server
    async function loadConfiguration() {
      try {
        const response = await fetch('/config');
        const config = await response.json();

        // Populate main settings
        document.getElementById('configSeaLevelPressure').value = config.sea_level_pressure || 993.9;
        document.getElementById('configUpdateFrequency').value = config.update_frequency || 1.0;
        document.getElementById('configHistoryLength').value = config.history_length || 300;

        // Populate thresholds
        const thresholds = config.transmission_thresholds || {};
        document.getElementById('configThresholdTempBme').value = thresholds.temp_bme280 || 0.25;
        document.getElementById('configThresholdHumidity').value = thresholds.humidity || 1.0;
        document.getElementById('configThresholdPressure').value = thresholds.pressure || 0.5;
        document.getElementById('configThresholdAltitude').value = thresholds.altitude || 0.5;
        document.getElementById('configThresholdAcceleration').value = thresholds.acceleration || 0.25;
        document.getElementById('configThresholdGyroscope').value = thresholds.gyroscope || 5.0;
        document.getElementById('configThresholdTempMpu').value = thresholds.temp_mpu || 0.25;

        showConfigStatus('Configuration loaded successfully', 'success');
      } catch (error) {
        console.error('Error loading configuration:', error);
        showConfigStatus('Failed to load configuration: ' + error.message, 'error');
      }
    }

    // Save configuration to server
    async function saveConfiguration() {
      try {
        const config = {
          sea_level_pressure: parseFloat(document.getElementById('configSeaLevelPressure').value),
          update_frequency: parseFloat(document.getElementById('configUpdateFrequency').value),
          history_length: parseInt(document.getElementById('configHistoryLength').value),
          transmission_thresholds: {
            temp_bme280: parseFloat(document.getElementById('configThresholdTempBme').value),
            humidity: parseFloat(document.getElementById('configThresholdHumidity').value),
            pressure: parseFloat(document.getElementById('configThresholdPressure').value),
            altitude: parseFloat(document.getElementById('configThresholdAltitude').value),
            acceleration: parseFloat(document.getElementById('configThresholdAcceleration').value),
            gyroscope: parseFloat(document.getElementById('configThresholdGyroscope').value),
            temp_mpu: parseFloat(document.getElementById('configThresholdTempMpu').value)
          }
        };

        const response = await fetch('/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        showConfigStatus('Configuration saved successfully', 'success');
      } catch (error) {
        console.error('Error saving configuration:', error);
        showConfigStatus('Failed to save configuration: ' + error.message, 'error');
      }
    }

    // Reset configuration to defaults
    async function resetConfiguration() {
      if (!confirm('Are you sure you want to reset all settings to defaults?')) {
        return;
      }

      try {
        const response = await fetch('/config/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        // Reload the configuration to update UI
        await loadConfiguration();
        showConfigStatus('Configuration reset to defaults', 'success');
      } catch (error) {
        console.error('Error resetting configuration:', error);
        showConfigStatus('Failed to reset configuration: ' + error.message, 'error');
      }
    }

    // Show configuration status message
    function showConfigStatus(message, type) {
      const statusEl = document.getElementById('configStatus');
      statusEl.textContent = message;
      statusEl.className = 'config-status ' + type;

      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusEl.className = 'config-status';
        statusEl.textContent = '';
      }, 5000);
    }

    // Load available profiles
    async function loadProfileList() {
      try {
        const response = await fetch('/config/profiles');
        const data = await response.json();

        const select = document.getElementById('profileSelect');
        // Clear existing options except the first one
        select.innerHTML = '<option value="">-- Select a profile --</option>';

        (data.profiles || []).forEach(profile => {
          const option = document.createElement('option');
          option.value = profile;
          option.textContent = profile;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading profiles:', error);
      }
    }

    // Load a specific profile
    async function loadProfile() {
      const select = document.getElementById('profileSelect');
      const profileName = select.value;

      if (!profileName) {
        showProfileStatus('Please select a profile', 'error');
        return;
      }

      try {
        // Apply the profile as current config
        const response = await fetch(`/config/profiles/${encodeURIComponent(profileName)}/apply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        // Reload the configuration to update UI
        await loadConfiguration();
        showProfileStatus(`Profile "${profileName}" loaded and applied`, 'success');
      } catch (error) {
        console.error('Error loading profile:', error);
        showProfileStatus('Failed to load profile: ' + error.message, 'error');
      }
    }

    // Save current config as a new profile
    async function saveProfile() {
      const nameInput = document.getElementById('newProfileName');
      const profileName = nameInput.value.trim();

      if (!profileName) {
        showProfileStatus('Please enter a profile name', 'error');
        return;
      }

      // Check for valid characters
      if (!/^[a-zA-Z0-9_-]+$/.test(profileName)) {
        showProfileStatus('Profile name can only contain letters, numbers, hyphens, and underscores', 'error');
        return;
      }

      try {
        // First save current config
        const config = {
          sea_level_pressure: parseFloat(document.getElementById('configSeaLevelPressure').value),
          update_frequency: parseFloat(document.getElementById('configUpdateFrequency').value),
          history_length: parseInt(document.getElementById('configHistoryLength').value),
          transmission_thresholds: {
            temp_bme280: parseFloat(document.getElementById('configThresholdTempBme').value),
            humidity: parseFloat(document.getElementById('configThresholdHumidity').value),
            pressure: parseFloat(document.getElementById('configThresholdPressure').value),
            altitude: parseFloat(document.getElementById('configThresholdAltitude').value),
            acceleration: parseFloat(document.getElementById('configThresholdAcceleration').value),
            gyroscope: parseFloat(document.getElementById('configThresholdGyroscope').value),
            temp_mpu: parseFloat(document.getElementById('configThresholdTempMpu').value)
          }
        };

        const response = await fetch(`/config/profiles/${encodeURIComponent(profileName)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        // Clear input and reload profile list
        nameInput.value = '';
        await loadProfileList();
        showProfileStatus(`Profile "${profileName}" saved successfully`, 'success');
      } catch (error) {
        console.error('Error saving profile:', error);
        showProfileStatus('Failed to save profile: ' + error.message, 'error');
      }
    }

    // Delete a profile
    async function deleteProfile() {
      const select = document.getElementById('profileSelect');
      const profileName = select.value;

      if (!profileName) {
        showProfileStatus('Please select a profile to delete', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to delete the profile "${profileName}"?`)) {
        return;
      }

      try {
        const response = await fetch(`/config/profiles/${encodeURIComponent(profileName)}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        if (result.error) {
          throw new Error(result.error);
        }

        // Reload profile list
        await loadProfileList();
        showProfileStatus(`Profile "${profileName}" deleted`, 'success');
      } catch (error) {
        console.error('Error deleting profile:', error);
        showProfileStatus('Failed to delete profile: ' + error.message, 'error');
      }
    }

    // Show profile status message
    function showProfileStatus(message, type) {
      const statusEl = document.getElementById('profileStatus');
      statusEl.textContent = message;
      statusEl.className = 'config-status ' + type;

      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusEl.className = 'config-status';
        statusEl.textContent = '';
      }, 5000);
    }

    // Theme Management System
    class ThemeManager {
      constructor() {
        this.currentTheme = localStorage.getItem('triton-theme') || 'dark-ocean';
        this.dropdown = null;
        this.dropdownBtn = null;
        this.currentSpan = null;
        this.init();
      }
      
      init() {
        this.dropdown = document.querySelector('.theme-dropdown');
        this.dropdownBtn = document.querySelector('.theme-dropdown-btn');
        this.currentSpan = document.querySelector('.theme-current');
        
        this.applyTheme(this.currentTheme);
        this.setupEventListeners();
        this.updateActiveButton();
        this.updateChartColors();
      }
      
      applyTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        this.currentTheme = themeName;
        localStorage.setItem('triton-theme', themeName);
        
        // Update dropdown button text
        if (this.currentSpan) {
          const themeNames = {
            'dark-ocean': 'Dark Ocean',
            'night': 'Night',
            'light-ocean': 'Light Ocean',
            'nature': 'Nature',
            'retro': 'Retro',
            'futuristic': 'Futuristic'
          };
          this.currentSpan.textContent = themeNames[themeName] || themeName;
        }
        
        // Update chart colors when theme changes
        setTimeout(() => this.updateChartColors(), 100);
      }
      
      updateChartColors() {
        // Get current theme colors
        const computedStyle = getComputedStyle(document.documentElement);
        const chartColor = computedStyle.getPropertyValue('--color-chart').trim() ||
                          computedStyle.getPropertyValue('--color-primary').trim();
        const borderColor = computedStyle.getPropertyValue('--color-border').trim();
        const textMuted = computedStyle.getPropertyValue('--color-text-muted').trim();
        const textSecondary = computedStyle.getPropertyValue('--color-text-secondary').trim();
        const textPrimary = computedStyle.getPropertyValue('--color-text-primary').trim();

        // Update all existing charts
        Object.values(chartRefs).forEach(chart => {
          if (chart && chart.data && chart.data.datasets && chart.data.datasets[0]) {
            // Update line colors
            chart.data.datasets[0].borderColor = chartColor;
            chart.data.datasets[0].backgroundColor = chartColor + '20';
            chart.data.datasets[0].pointHoverBackgroundColor = chartColor;

            // Update grid and axis colors
            if (chart.options.scales) {
              if (chart.options.scales.x) {
                chart.options.scales.x.grid.color = borderColor;
                chart.options.scales.x.ticks.color = textSecondary;
                if (chart.options.scales.x.title) {
                  chart.options.scales.x.title.color = textMuted;
                }
              }
              if (chart.options.scales.y) {
                chart.options.scales.y.grid.color = borderColor;
                chart.options.scales.y.ticks.color = textSecondary;
                if (chart.options.scales.y.title) {
                  chart.options.scales.y.title.color = textMuted;
                }
              }
            }

            // Update legend colors
            if (chart.options.plugins && chart.options.plugins.legend) {
              chart.options.plugins.legend.labels.color = textPrimary;
            }

            // Update tooltip border color
            if (chart.options.plugins && chart.options.plugins.tooltip) {
              chart.options.plugins.tooltip.borderColor = chartColor;
            }

            chart.update('none');
          }
        });
      }
      
      setupEventListeners() {
        // Dropdown toggle
        if (this.dropdownBtn) {
          this.dropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.dropdown.classList.toggle('open');
          });
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          if (this.dropdown) {
            this.dropdown.classList.remove('open');
          }
        });
        
        // Theme option clicks
        const themeOptions = document.querySelectorAll('.theme-button');
        themeOptions.forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const theme = option.getAttribute('data-theme');
            this.applyTheme(theme);
            this.updateActiveButton();
            this.dropdown.classList.remove('open');
            
            // Add visual feedback
            option.style.transform = 'scale(0.95)';
            setTimeout(() => {
              option.style.transform = '';
            }, 150);
          });
        });
      }
      
      updateActiveButton() {
        const themeOptions = document.querySelectorAll('.theme-button');
        themeOptions.forEach(option => {
          option.classList.remove('active');
          if (option.getAttribute('data-theme') === this.currentTheme) {
            option.classList.add('active');
          }
        });
      }
    }

    // Layout Preset Management System
    let layoutManager = null;

    class LayoutManager {
      constructor() {
        this.currentLayout = localStorage.getItem('triton-layout') || 'full-dashboard';
        this.dropdown = null;
        this.dropdownBtn = null;
        this.currentSpan = null;

        this.presets = {
          'full-dashboard': {
            name: 'Full Dashboard',
            icon: '&#128421;',
            description: 'All sections, 4 columns',
            sections: ['mission-control', 'bme280', 'mpu6050', 'orientation-3d', 'correlation', 'mission-compare', 'mission-replay', 'statistics', 'configuration', 'downloads'],
            gridColumns: 4,
            densityClass: 'layout-ultra-dense'
          },
          'dense-3col': {
            name: 'Dense (3 columns)',
            icon: '&#9638;',
            description: '3 charts per row, less scrolling',
            sections: ['mission-control', 'bme280', 'mpu6050', 'orientation-3d', 'statistics'],
            gridColumns: 3,
            densityClass: 'layout-dense'
          },
          'ultra-dense-4col': {
            name: 'Ultra Dense (4 columns)',
            icon: '&#9641;',
            description: '4 charts per row, minimal scrolling',
            sections: ['bme280', 'mpu6050', 'orientation-3d', 'statistics'],
            gridColumns: 4,
            densityClass: 'layout-ultra-dense'
          },
          'all-sensors-3col': {
            name: 'All Sensors (3 col)',
            icon: '&#128200;',
            description: 'All 11 charts in 3 columns',
            sections: ['bme280', 'mpu6050', 'orientation-3d'],
            gridColumns: 3,
            densityClass: 'layout-dense'
          },
          'mission-overview': {
            name: 'Mission Overview',
            icon: '&#128640;',
            description: 'Essential monitoring',
            sections: ['mission-control', 'bme280', 'mpu6050', 'orientation-3d', 'statistics'],
            gridColumns: 2,
            densityClass: ''
          },
          'environmental-focus': {
            name: 'Environmental Focus',
            icon: '&#127754;',
            description: 'BME280 deep dive',
            sections: ['mission-control', 'bme280', 'correlation', 'statistics'],
            gridColumns: 2,
            densityClass: ''
          },
          'navigation-focus': {
            name: 'Navigation Focus',
            icon: '&#129517;',
            description: 'MPU6050 inertial data',
            sections: ['mission-control', 'mpu6050', 'orientation-3d', 'correlation', 'statistics'],
            gridColumns: 2,
            densityClass: ''
          },
          'analysis-mode': {
            name: 'Analysis Mode',
            icon: '&#128202;',
            description: 'Post-mission review',
            sections: ['mission-compare', 'mission-replay', 'statistics', 'downloads'],
            gridColumns: 2,
            densityClass: ''
          },
          'compact': {
            name: 'Compact',
            icon: '&#128241;',
            description: 'Minimal monitoring',
            sections: ['mission-control', 'statistics'],
            gridColumns: 1,
            densityClass: ''
          },
          'wide-charts': {
            name: 'Wide Charts',
            icon: '&#128250;',
            description: 'Full-width charts',
            sections: ['bme280', 'mpu6050', 'orientation-3d'],
            gridColumns: 1,
            densityClass: ''
          }
        };

        this.allSections = ['mission-control', 'bme280', 'mpu6050', 'correlation', 'mission-compare', 'mission-replay', 'statistics', 'configuration', 'orientation-3d', 'downloads'];

        // Load custom layouts from localStorage
        this.customLayouts = JSON.parse(localStorage.getItem('triton-custom-layouts') || '{}');

        this.init();
      }

      init() {
        this.dropdown = document.querySelector('.layout-dropdown');
        this.dropdownBtn = document.querySelector('.layout-dropdown-btn');
        this.currentSpan = document.querySelector('.layout-current');

        this.renderCustomLayouts();
        // Always start with all sections visible (full-dashboard)
        this.applyLayout('full-dashboard');
        this.setupEventListeners();
        this.setupToggleBar();
        this.updateActiveButton();

        // Apply super-compact class to Mission Replay, Statistics, Configuration, and Downloads
        this.applySuperCompactSections();
      }

      // Apply super-compact class to specified sections for reduced size
      applySuperCompactSections() {
        const superCompactSections = ['mission-replay', 'statistics', 'configuration', 'downloads'];
        superCompactSections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            section.classList.add('super-compact');
          }
        });
      }

      // Select all sections
      selectAllSections() {
        const toggleChips = document.querySelectorAll('.section-toggle-chip');
        toggleChips.forEach(chip => {
          const sectionId = chip.getAttribute('data-section');
          const section = document.getElementById(sectionId);
          const checkbox = chip.querySelector('input');

          chip.classList.add('active');
          checkbox.checked = true;
          if (section) section.classList.remove('hidden-section');
        });
        this.updateNavLinksFromToggleBar();
        this.triggerChartResize();
      }

      // Deselect all sections
      deselectAllSections() {
        const toggleChips = document.querySelectorAll('.section-toggle-chip');
        toggleChips.forEach(chip => {
          const sectionId = chip.getAttribute('data-section');
          const section = document.getElementById(sectionId);
          const checkbox = chip.querySelector('input');

          chip.classList.remove('active');
          checkbox.checked = false;
          if (section) section.classList.add('hidden-section');
        });
        this.updateNavLinksFromToggleBar();
        this.triggerChartResize();
      }

      // Setup toggle bar event listeners
      setupToggleBar() {
        // Section toggle chips
        const toggleChips = document.querySelectorAll('.section-toggle-chip');
        toggleChips.forEach(chip => {
          chip.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = chip.getAttribute('data-section');
            const section = document.getElementById(sectionId);
            const checkbox = chip.querySelector('input');

            if (chip.classList.contains('active')) {
              chip.classList.remove('active');
              checkbox.checked = false;
              if (section) section.classList.add('hidden-section');
            } else {
              chip.classList.add('active');
              checkbox.checked = true;
              if (section) section.classList.remove('hidden-section');
            }

            this.updateNavLinksFromToggleBar();
            this.triggerChartResize();
          });
        });

        // Grid column chips
        const colChips = document.querySelectorAll('.grid-col-chip');
        colChips.forEach(chip => {
          chip.addEventListener('click', () => {
            const cols = parseInt(chip.getAttribute('data-cols'));

            // Update active state
            colChips.forEach(c => c.classList.remove('active'));
            chip.classList.add('active');

            // Update grid
            this.currentGridColumns = cols;
            this.updateGridLayout(cols);

            // Apply density class
            document.body.classList.remove('layout-dense', 'layout-ultra-dense');
            if (cols >= 4) {
              document.body.classList.add('layout-ultra-dense');
            } else if (cols >= 3) {
              document.body.classList.add('layout-dense');
            }

            this.triggerChartResize();
          });
        });
      }

      // Update nav links based on toggle bar state
      updateNavLinksFromToggleBar() {
        const visibleSections = [];
        document.querySelectorAll('.section-toggle-chip.active').forEach(chip => {
          visibleSections.push(chip.getAttribute('data-section'));
        });
        this.updateNavLinks(visibleSections);
      }

      // Trigger chart resize
      triggerChartResize() {
        setTimeout(() => {
          if (typeof chartRefs !== 'undefined') {
            Object.values(chartRefs).forEach(chart => {
              if (chart && chart.resize) chart.resize();
            });
          }
        }, 100);
      }

      applyLayout(layoutName) {
        // Check presets first, then custom layouts
        let preset = this.presets[layoutName] || this.customLayouts[layoutName];
        if (!preset) {
          // Fall back to full dashboard
          layoutName = 'full-dashboard';
          preset = this.presets[layoutName];
        }

        this.currentLayout = layoutName;
        localStorage.setItem('triton-layout', layoutName);

        // Update dropdown button text
        if (this.currentSpan) {
          this.currentSpan.textContent = preset.name;
        }

        // Apply density class to body
        document.body.classList.remove('layout-dense', 'layout-ultra-dense');
        if (preset.densityClass) {
          document.body.classList.add(preset.densityClass);
        }

        // Show/hide sections
        this.allSections.forEach(sectionId => {
          const section = document.getElementById(sectionId);
          if (section) {
            if (preset.sections.includes(sectionId)) {
              section.classList.remove('hidden-section');
            } else {
              section.classList.add('hidden-section');
            }
          }
        });

        // Update grid columns
        this.updateGridLayout(preset.gridColumns);
        this.currentGridColumns = preset.gridColumns;

        // Update navigation links visibility
        this.updateNavLinks(preset.sections);

        // Sync toggle checkboxes with preset
        this.syncTogglesWithLayout(preset.sections);

        // Sync grid column buttons
        this.syncGridColumnsButton(preset.gridColumns);

        // Trigger chart resize after layout change
        setTimeout(() => {
          if (typeof chartRefs !== 'undefined') {
            Object.values(chartRefs).forEach(chart => {
              if (chart && chart.resize) chart.resize();
            });
          }
        }, 100);
      }

      updateGridLayout(columns) {
        const grids = document.querySelectorAll('.grid-2col, .grid-1col, .grid-3col, .grid-4col');
        grids.forEach(grid => {
          grid.classList.remove('grid-1col', 'grid-2col', 'grid-3col', 'grid-4col');
          grid.classList.add(`grid-${columns}col`);
        });
      }

      updateNavLinks(visibleSections) {
        const navLinks = document.querySelectorAll('.main-nav a[href^="#"]');
        navLinks.forEach(link => {
          const href = link.getAttribute('href');
          if (href && href.startsWith('#')) {
            const sectionId = href.substring(1);
            if (visibleSections.includes(sectionId)) {
              link.style.display = '';
            } else {
              link.style.display = 'none';
            }
          }
        });
      }

      setupEventListeners() {
        // Dropdown toggle
        if (this.dropdownBtn) {
          this.dropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.dropdown.classList.toggle('open');
            // Close theme dropdown if open
            const themeDropdown = document.querySelector('.theme-dropdown');
            if (themeDropdown) themeDropdown.classList.remove('open');
          });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (this.dropdown && !this.dropdown.contains(e.target)) {
            this.dropdown.classList.remove('open');
          }
        });

        // Layout option clicks (for preset buttons)
        this.attachLayoutButtonListeners();
      }

      attachLayoutButtonListeners() {
        const layoutOptions = document.querySelectorAll('.layout-button[data-layout]');
        layoutOptions.forEach(option => {
          // Remove existing listeners by cloning
          const newOption = option.cloneNode(true);
          option.parentNode.replaceChild(newOption, option);

          newOption.addEventListener('click', (e) => {
            e.stopPropagation();
            const layout = newOption.getAttribute('data-layout');
            this.applyLayout(layout);
            this.updateActiveButton();
            this.dropdown.classList.remove('open');

            // Visual feedback
            newOption.style.transform = 'scale(0.98)';
            setTimeout(() => {
              newOption.style.transform = '';
            }, 150);
          });
        });
      }

      updateActiveButton() {
        const layoutOptions = document.querySelectorAll('.layout-button[data-layout]');
        layoutOptions.forEach(option => {
          option.classList.remove('active');
          if (option.getAttribute('data-layout') === this.currentLayout) {
            option.classList.add('active');
          }
        });
      }

      // Custom layout management
      saveCustomLayout() {
        const nameInput = document.getElementById('customLayoutName');
        const name = nameInput.value.trim();

        if (!name) {
          alert('Please enter a name for the layout');
          return;
        }

        // Get currently visible sections
        const visibleSections = this.allSections.filter(sectionId => {
          const section = document.getElementById(sectionId);
          return section && !section.classList.contains('hidden-section');
        });

        // Get current grid setting
        const grid = document.querySelector('.grid-2col, .grid-1col, .grid-3col, .grid-4col');
        let gridColumns = this.currentGridColumns || 2;
        if (grid) {
          if (grid.classList.contains('grid-1col')) gridColumns = 1;
          else if (grid.classList.contains('grid-3col')) gridColumns = 3;
          else if (grid.classList.contains('grid-4col')) gridColumns = 4;
        }

        // Determine density class
        let densityClass = '';
        if (gridColumns >= 4) densityClass = 'layout-ultra-dense';
        else if (gridColumns >= 3) densityClass = 'layout-dense';

        const layoutKey = 'custom-' + name.toLowerCase().replace(/[^a-z0-9]/g, '-');

        this.customLayouts[layoutKey] = {
          name: name,
          icon: '&#11088;', // Star icon
          description: `${visibleSections.length} sections, ${gridColumns} cols`,
          sections: visibleSections,
          gridColumns: gridColumns,
          densityClass: densityClass,
          isCustom: true
        };

        localStorage.setItem('triton-custom-layouts', JSON.stringify(this.customLayouts));

        // Clear input
        nameInput.value = '';

        // Re-render custom layouts
        this.renderCustomLayouts();

        // Apply the new layout
        this.applyLayout(layoutKey);
        this.updateActiveButton();
      }

      deleteCustomLayout(layoutKey) {
        if (confirm('Delete this custom layout?')) {
          delete this.customLayouts[layoutKey];
          localStorage.setItem('triton-custom-layouts', JSON.stringify(this.customLayouts));

          // If current layout was deleted, switch to full dashboard
          if (this.currentLayout === layoutKey) {
            this.applyLayout('full-dashboard');
          }

          this.renderCustomLayouts();
          this.updateActiveButton();
        }
      }

      renderCustomLayouts() {
        const customSection = document.getElementById('customLayoutsSection');
        const customList = document.getElementById('customLayoutsList');

        if (!customSection || !customList) return;

        const customKeys = Object.keys(this.customLayouts);

        if (customKeys.length === 0) {
          customSection.style.display = 'none';
          return;
        }

        customSection.style.display = 'block';
        customList.innerHTML = '';

        customKeys.forEach(key => {
          const layout = this.customLayouts[key];
          const button = document.createElement('div');
          button.className = 'layout-button';
          button.setAttribute('data-layout', key);
          button.innerHTML = `
            <span class="layout-icon">${layout.icon}</span>
            <span class="layout-info">
              <span class="layout-name">${layout.name}</span>
              <span class="layout-desc">${layout.sections.length} sections</span>
            </span>
            <button class="layout-button-delete" onclick="event.stopPropagation(); layoutManager.deleteCustomLayout('${key}')">Delete</button>
          `;
          customList.appendChild(button);
        });

        // Re-attach event listeners
        this.attachLayoutButtonListeners();
      }

      // Toggle individual section visibility
      toggleSection(checkbox) {
        const sectionId = checkbox.getAttribute('data-section');
        const section = document.getElementById(sectionId);
        const label = checkbox.closest('.section-toggle');

        if (section) {
          if (checkbox.checked) {
            section.classList.remove('hidden-section');
            label.classList.add('checked');
          } else {
            section.classList.add('hidden-section');
            label.classList.remove('checked');
          }
        }

        // Update nav links
        this.updateNavLinksFromToggles();

        // Trigger chart resize
        setTimeout(() => {
          if (typeof chartRefs !== 'undefined') {
            Object.values(chartRefs).forEach(chart => {
              if (chart && chart.resize) chart.resize();
            });
          }
        }, 100);

        // Clear preset selection since we're now in custom mode
        this.currentLayout = 'custom';
        if (this.currentSpan) {
          this.currentSpan.textContent = 'Custom';
        }
        this.updateActiveButton();
      }

      // Set grid columns directly
      setGridColumns(columns) {
        this.currentGridColumns = columns;
        this.updateGridLayout(columns);

        // Update button states
        const buttons = document.querySelectorAll('.grid-col-btn');
        buttons.forEach(btn => {
          btn.classList.remove('active');
          if (parseInt(btn.getAttribute('data-cols')) === columns) {
            btn.classList.add('active');
          }
        });

        // Apply density class based on columns
        document.body.classList.remove('layout-dense', 'layout-ultra-dense');
        if (columns >= 4) {
          document.body.classList.add('layout-ultra-dense');
        } else if (columns >= 3) {
          document.body.classList.add('layout-dense');
        }

        // Trigger chart resize
        setTimeout(() => {
          if (typeof chartRefs !== 'undefined') {
            Object.values(chartRefs).forEach(chart => {
              if (chart && chart.resize) chart.resize();
            });
          }
        }, 100);

        // Mark as custom layout
        this.currentLayout = 'custom';
        if (this.currentSpan) {
          this.currentSpan.textContent = 'Custom';
        }
        this.updateActiveButton();
      }

      // Update nav links based on current toggle states
      updateNavLinksFromToggles() {
        const checkboxes = document.querySelectorAll('#sectionToggles input[type="checkbox"]');
        const visibleSections = [];
        checkboxes.forEach(cb => {
          if (cb.checked) {
            visibleSections.push(cb.getAttribute('data-section'));
          }
        });
        this.updateNavLinks(visibleSections);
      }

      // Sync checkboxes with current layout (dropdown version)
      syncTogglesWithLayout(sections) {
        // Sync dropdown toggles
        const checkboxes = document.querySelectorAll('#sectionToggles input[type="checkbox"]');
        checkboxes.forEach(cb => {
          const sectionId = cb.getAttribute('data-section');
          const label = cb.closest('.section-toggle');
          if (sections.includes(sectionId)) {
            cb.checked = true;
            if (label) label.classList.add('checked');
          } else {
            cb.checked = false;
            if (label) label.classList.remove('checked');
          }
        });

        // Sync toggle bar chips
        const toggleChips = document.querySelectorAll('.section-toggle-chip');
        toggleChips.forEach(chip => {
          const sectionId = chip.getAttribute('data-section');
          const checkbox = chip.querySelector('input');
          if (sections.includes(sectionId)) {
            chip.classList.add('active');
            if (checkbox) checkbox.checked = true;
          } else {
            chip.classList.remove('active');
            if (checkbox) checkbox.checked = false;
          }
        });
      }

      // Sync grid column buttons with current layout
      syncGridColumnsButton(columns) {
        // Sync dropdown buttons
        const buttons = document.querySelectorAll('.grid-col-btn');
        buttons.forEach(btn => {
          btn.classList.remove('active');
          if (parseInt(btn.getAttribute('data-cols')) === columns) {
            btn.classList.add('active');
          }
        });

        // Sync toggle bar chips
        const colChips = document.querySelectorAll('.grid-col-chip');
        colChips.forEach(chip => {
          chip.classList.remove('active');
          if (parseInt(chip.getAttribute('data-cols')) === columns) {
            chip.classList.add('active');
          }
        });
      }
    }

    // Gyroscope Integrator - Integrates angular velocities to get orientation angles
    class GyroIntegrator {
      constructor() {
        this.pitch = 0;  // Rotation around X axis (degrees)
        this.roll = 0;   // Rotation around Y axis (degrees)
        this.yaw = 0;    // Rotation around Z axis (degrees)
        this.lastTimestamp = null;
      }

      // Update orientation based on gyroscope readings
      // gyroX, gyroY, gyroZ are in degrees per second
      update(gyroX, gyroY, gyroZ, timestamp = Date.now()) {
        if (this.lastTimestamp === null) {
          this.lastTimestamp = timestamp;
          return { pitch: this.pitch, roll: this.roll, yaw: this.yaw };
        }

        // Calculate time delta in seconds
        const dt = (timestamp - this.lastTimestamp) / 1000;
        this.lastTimestamp = timestamp;

        // Integrate angular velocities to get angle changes
        // Limit dt to prevent large jumps if there's a gap in data
        const clampedDt = Math.min(dt, 0.5);

        this.pitch += gyroX * clampedDt;
        this.roll += gyroY * clampedDt;
        this.yaw += gyroZ * clampedDt;

        // Normalize angles to -180 to 180 range
        this.pitch = this.normalizeAngle(this.pitch);
        this.roll = this.normalizeAngle(this.roll);
        this.yaw = this.normalizeAngle(this.yaw);

        return { pitch: this.pitch, roll: this.roll, yaw: this.yaw };
      }

      normalizeAngle(angle) {
        while (angle > 180) angle -= 360;
        while (angle < -180) angle += 360;
        return angle;
      }

      reset() {
        this.pitch = 0;
        this.roll = 0;
        this.yaw = 0;
        this.lastTimestamp = null;
      }

      getOrientation() {
        return { pitch: this.pitch, roll: this.roll, yaw: this.yaw };
      }
    }

    // 3D Orientation Visualization using Three.js
    class OrientationVisualization {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        if (!this.container) {
          console.error('Orientation container not found:', containerId);
          return;
        }

        this.gyroIntegrator = new GyroIntegrator();
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.submarine = null;
        this.autoRotate = false;
        this.isInitialized = false;
        this.animationId = null;
        this.lastGyroData = { x: 0, y: 0, z: 0 };

        this.init();
      }

      init() {
        // Check if Three.js is available
        if (typeof THREE === 'undefined') {
          console.error('Three.js not loaded');
          this.updateStatus('Three.js library not loaded');
          return;
        }

        try {
          // Scene setup
          this.scene = new THREE.Scene();
          this.scene.background = new THREE.Color(0x0f1f2f);

          // Camera setup
          const aspect = this.container.clientWidth / this.container.clientHeight;
          this.camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 1000);
          this.camera.position.set(4, 3, 5);
          this.camera.lookAt(0, 0, 0);

          // Renderer setup
          this.renderer = new THREE.WebGLRenderer({ antialias: true });
          this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
          this.renderer.setPixelRatio(window.devicePixelRatio);
          this.container.appendChild(this.renderer.domElement);

          // Lighting
          const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
          this.scene.add(ambientLight);

          const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
          directionalLight.position.set(5, 5, 5);
          this.scene.add(directionalLight);

          const backLight = new THREE.DirectionalLight(0x00aaff, 0.3);
          backLight.position.set(-5, -3, -5);
          this.scene.add(backLight);

          // Create submarine model
          this.createSubmarine();

          // Add grid helper for reference
          const gridHelper = new THREE.GridHelper(10, 10, 0x00aaff, 0x1a2a3a);
          gridHelper.position.y = -1.5;
          this.scene.add(gridHelper);

          // Add axis helper
          const axesHelper = new THREE.AxesHelper(2);
          this.scene.add(axesHelper);

          // Handle window resize
          window.addEventListener('resize', () => this.onWindowResize());

          // Mouse drag controls for camera
          this.setupMouseControls();

          // Start animation loop
          this.isInitialized = true;
          this.animate();
          this.updateStatus('Ready - receiving sensor data');

        } catch (error) {
          console.error('Error initializing 3D visualization:', error);
          this.updateStatus('Error initializing 3D view');
        }
      }

      createSubmarine() {
        // Create submarine group
        this.submarine = new THREE.Group();

        // Hull - main body (elongated capsule shape)
        const hullGeometry = new THREE.CapsuleGeometry(0.4, 2, 16, 32);
        const hullMaterial = new THREE.MeshPhongMaterial({
          color: 0x2a5580,
          shininess: 80,
          specular: 0x444444
        });
        const hull = new THREE.Mesh(hullGeometry, hullMaterial);
        hull.rotation.z = Math.PI / 2; // Rotate to horizontal
        this.submarine.add(hull);

        // Conning tower (sail)
        const towerGeometry = new THREE.BoxGeometry(0.3, 0.5, 0.6);
        const towerMaterial = new THREE.MeshPhongMaterial({
          color: 0x3a6590,
          shininess: 60
        });
        const tower = new THREE.Mesh(towerGeometry, towerMaterial);
        tower.position.set(0, 0.45, 0);
        this.submarine.add(tower);

        // Periscope
        const periscopeGeometry = new THREE.CylinderGeometry(0.03, 0.03, 0.3, 8);
        const periscopeMaterial = new THREE.MeshPhongMaterial({ color: 0x666666 });
        const periscope = new THREE.Mesh(periscopeGeometry, periscopeMaterial);
        periscope.position.set(0.05, 0.85, 0);
        this.submarine.add(periscope);

        // Propeller cone
        const propConeGeometry = new THREE.ConeGeometry(0.2, 0.4, 8);
        const propConeMaterial = new THREE.MeshPhongMaterial({ color: 0x555555 });
        const propCone = new THREE.Mesh(propConeGeometry, propConeMaterial);
        propCone.rotation.z = -Math.PI / 2;
        propCone.position.set(-1.4, 0, 0);
        this.submarine.add(propCone);

        // Propeller blades
        const bladeGeometry = new THREE.BoxGeometry(0.02, 0.3, 0.08);
        const bladeMaterial = new THREE.MeshPhongMaterial({ color: 0x777777 });
        for (let i = 0; i < 4; i++) {
          const blade = new THREE.Mesh(bladeGeometry, bladeMaterial);
          blade.rotation.x = (i * Math.PI) / 2;
          blade.position.set(-1.5, 0, 0);
          this.submarine.add(blade);
        }

        // Bow (front)
        const bowGeometry = new THREE.SphereGeometry(0.4, 16, 16, 0, Math.PI);
        const bowMesh = new THREE.Mesh(bowGeometry, hullMaterial);
        bowMesh.rotation.z = -Math.PI / 2;
        bowMesh.position.x = 1.0;
        this.submarine.add(bowMesh);

        // Horizontal fins (dive planes)
        const finGeometry = new THREE.BoxGeometry(0.1, 0.02, 0.4);
        const finMaterial = new THREE.MeshPhongMaterial({ color: 0x3a6590 });

        // Front fins
        const frontFinLeft = new THREE.Mesh(finGeometry, finMaterial);
        frontFinLeft.position.set(0.7, 0, 0.3);
        this.submarine.add(frontFinLeft);

        const frontFinRight = new THREE.Mesh(finGeometry, finMaterial);
        frontFinRight.position.set(0.7, 0, -0.3);
        this.submarine.add(frontFinRight);

        // Rear fins
        const rearFinLeft = new THREE.Mesh(finGeometry, finMaterial);
        rearFinLeft.position.set(-1.1, 0, 0.3);
        this.submarine.add(rearFinLeft);

        const rearFinRight = new THREE.Mesh(finGeometry, finMaterial);
        rearFinRight.position.set(-1.1, 0, -0.3);
        this.submarine.add(rearFinRight);

        // Vertical tail fin
        const tailFinGeometry = new THREE.BoxGeometry(0.15, 0.4, 0.02);
        const tailFin = new THREE.Mesh(tailFinGeometry, finMaterial);
        tailFin.position.set(-1.2, 0.2, 0);
        this.submarine.add(tailFin);

        // Add lights on sub
        const lightGeometry = new THREE.SphereGeometry(0.05, 8, 8);
        const lightMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const light1 = new THREE.Mesh(lightGeometry, lightMaterial);
        light1.position.set(1.15, 0.1, 0);
        this.submarine.add(light1);

        this.scene.add(this.submarine);
      }

      setupMouseControls() {
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let cameraAngleX = 0;
        let cameraAngleY = Math.PI / 6;
        let cameraDistance = 7;

        this.renderer.domElement.addEventListener('mousedown', (e) => {
          isDragging = true;
          previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        document.addEventListener('mouseup', () => {
          isDragging = false;
        });

        document.addEventListener('mousemove', (e) => {
          if (!isDragging) return;

          const deltaX = e.clientX - previousMousePosition.x;
          const deltaY = e.clientY - previousMousePosition.y;

          cameraAngleX += deltaX * 0.01;
          cameraAngleY = Math.max(-Math.PI / 2.5, Math.min(Math.PI / 2.5, cameraAngleY + deltaY * 0.01));

          previousMousePosition = { x: e.clientX, y: e.clientY };

          this.camera.position.x = cameraDistance * Math.sin(cameraAngleX) * Math.cos(cameraAngleY);
          this.camera.position.y = cameraDistance * Math.sin(cameraAngleY);
          this.camera.position.z = cameraDistance * Math.cos(cameraAngleX) * Math.cos(cameraAngleY);
          this.camera.lookAt(0, 0, 0);
        });

        // Zoom with mouse wheel
        this.renderer.domElement.addEventListener('wheel', (e) => {
          e.preventDefault();
          cameraDistance = Math.max(3, Math.min(15, cameraDistance + e.deltaY * 0.01));

          this.camera.position.x = cameraDistance * Math.sin(cameraAngleX) * Math.cos(cameraAngleY);
          this.camera.position.y = cameraDistance * Math.sin(cameraAngleY);
          this.camera.position.z = cameraDistance * Math.cos(cameraAngleX) * Math.cos(cameraAngleY);
          this.camera.lookAt(0, 0, 0);
        });
      }

      animate() {
        if (!this.isInitialized) return;

        this.animationId = requestAnimationFrame(() => this.animate());

        // Auto-rotate if enabled
        if (this.autoRotate && this.submarine) {
          this.submarine.rotation.y += 0.005;
        }

        this.renderer.render(this.scene, this.camera);
      }

      // Update orientation from gyroscope data
      updateFromGyro(gyroX, gyroY, gyroZ, timestamp) {
        this.lastGyroData = { x: gyroX, y: gyroY, z: gyroZ };
        const orientation = this.gyroIntegrator.update(gyroX, gyroY, gyroZ, timestamp);

        // Update 3D model rotation
        if (this.submarine) {
          // Convert degrees to radians and apply to submarine
          this.submarine.rotation.x = THREE.MathUtils.degToRad(orientation.pitch);
          this.submarine.rotation.z = THREE.MathUtils.degToRad(orientation.roll);
          this.submarine.rotation.y = THREE.MathUtils.degToRad(orientation.yaw);
        }

        // Update display values
        this.updateDisplayValues(orientation, { x: gyroX, y: gyroY, z: gyroZ });

        return orientation;
      }

      updateDisplayValues(orientation, gyroRates) {
        // Update orientation angles
        const pitchEl = document.getElementById('pitchValue');
        const rollEl = document.getElementById('rollValue');
        const yawEl = document.getElementById('yawValue');

        if (pitchEl) pitchEl.textContent = orientation.pitch.toFixed(1) + '';
        if (rollEl) rollEl.textContent = orientation.roll.toFixed(1) + '';
        if (yawEl) yawEl.textContent = orientation.yaw.toFixed(1) + '';

        // Update gyro rates
        const gyroXEl = document.getElementById('gyroXValue');
        const gyroYEl = document.getElementById('gyroYValue');
        const gyroZEl = document.getElementById('gyroZValue');

        if (gyroXEl) gyroXEl.textContent = gyroRates.x.toFixed(2) + ' /s';
        if (gyroYEl) gyroYEl.textContent = gyroRates.y.toFixed(2) + ' /s';
        if (gyroZEl) gyroZEl.textContent = gyroRates.z.toFixed(2) + ' /s';
      }

      updateStatus(message) {
        const statusEl = document.getElementById('orientationStatus');
        if (statusEl) {
          statusEl.textContent = message;
          statusEl.classList.toggle('active', message.includes('Ready') || message.includes('receiving'));
        }
      }

      resetOrientation() {
        this.gyroIntegrator.reset();
        if (this.submarine) {
          this.submarine.rotation.set(0, 0, 0);
        }
        this.updateDisplayValues({ pitch: 0, roll: 0, yaw: 0 }, { x: 0, y: 0, z: 0 });
        this.updateStatus('Orientation reset');
        setTimeout(() => this.updateStatus('Ready - receiving sensor data'), 1500);
      }

      toggleAutoRotate() {
        this.autoRotate = !this.autoRotate;
        this.updateStatus(this.autoRotate ? 'Auto-rotate enabled' : 'Auto-rotate disabled');
        setTimeout(() => this.updateStatus('Ready - receiving sensor data'), 1500);
      }

      onWindowResize() {
        if (!this.container || !this.camera || !this.renderer) return;

        const width = this.container.clientWidth;
        const height = this.container.clientHeight;

        this.camera.aspect = width / height;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(width, height);
      }

      destroy() {
        if (this.animationId) {
          cancelAnimationFrame(this.animationId);
        }
        if (this.renderer) {
          this.renderer.dispose();
          if (this.container && this.renderer.domElement) {
            this.container.removeChild(this.renderer.domElement);
          }
        }
      }
    }

    // Global orientation visualization instance
    let orientationVis = null;

    // Sticky Navigation Handler
    class StickyNavHandler {
      constructor() {
        this.headerNav = document.querySelector('.header-nav');
        this.init();
      }
      
      init() {
        if (this.headerNav) {
          window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
              this.headerNav.classList.add('scrolled');
            } else {
              this.headerNav.classList.remove('scrolled');
            }
          });
        }
      }
    }

    window.onload = () => {
      // Initialize theme management
      new ThemeManager();
      // Initialize layout preset management
      layoutManager = new LayoutManager();
      // Initialize sticky navigation
      new StickyNavHandler();
      // Initialize 3D orientation visualization
      orientationVis = new OrientationVisualization('orientationCanvasWrapper');
      // Initialize correlation dropdowns
      initCorrelationDropdowns();
      // Initialize mission comparison
      refreshMissionList();
      loadArchivedLogs();
      // Initialize playback controller
      playbackController = new PlaybackController();
      // Initialize configuration
      loadConfiguration();
      loadProfileList();
      // Start live data fetching (stored in window for playback control)
      window.liveDataInterval = setInterval(fetchData, 1000);

      // Initialize recording status and list
      checkRecordingStatus();
      refreshRecordingsList();

      // Smooth scrolling for anchor links with offset for fixed header
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            const headerHeight = 70; // Account for fixed header
            const targetPosition = target.offsetTop - headerHeight;
            
            window.scrollTo({
              top: targetPosition,
              behavior: 'smooth'
            });
          }
        });
      });
    };
  </script>
</body>
</html>