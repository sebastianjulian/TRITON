<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mission Control TRITON</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root {
      /* Dark Ocean (Default) */
      --bg-primary: #0a1520;
      --bg-secondary: #1a2a3a;
      --bg-tertiary: #0f1f2f;
      --bg-card: #1f3545;
      --bg-header: #14242f;
      --color-primary: #00aaff;
      --color-secondary: #0088cc;
      --color-accent: #0066aa;
      --color-text-primary: #ffffff;
      --color-text-secondary: #e0f0ff;
      --color-text-muted: #b0c5dd;
      --color-border: #2a4050;
      --color-border-accent: #00aaff;
      --glow-primary: 0 0 20px rgba(0, 170, 255, 0.3);
      --glow-accent: 0 0 15px rgba(0, 102, 170, 0.2);
      --gradient-bg: linear-gradient(135deg, #0a1520 0%, #1a2a3a 100%);
      --gradient-card: linear-gradient(145deg, #1f3545 0%, #2a4050 100%);
    }
    
    
    [data-theme="night"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --bg-card: #1e293b;
      --bg-header: #0f172a;
      --color-primary: #f59e0b;
      --color-secondary: #d97706;
      --color-accent: #f59e0b;
      --color-text-primary: #f8fafc;
      --color-text-secondary: #e2e8f0;
      --color-text-muted: #94a3b8;
      --color-border: #475569;
      --color-border-accent: #f59e0b;
      --glow-primary: 0 0 20px rgba(245, 158, 11, 0.3);
      --glow-accent: 0 0 15px rgba(217, 119, 6, 0.2);
      --gradient-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --gradient-card: linear-gradient(145deg, #1e293b 0%, #334155 100%);
    }
    
    [data-theme="light-ocean"] {
      --bg-primary: #c2e7f7;
      --bg-secondary: #92d4ef;
      --bg-tertiary: #68c1e7;
      --bg-card: #a8dcf4;
      --bg-header: #7ac6eb;
      --color-primary: #0ea5e9;
      --color-secondary: #0284c7;
      --color-accent: #0369a1;
      --color-text-primary: #032436;
      --color-text-secondary: #05314a;
      --color-text-muted: #094358;
      --color-border: #5fb0db;
      --color-border-accent: #0ea5e9;
      --glow-primary: 0 0 20px rgba(14, 165, 233, 0.4);
      --glow-accent: 0 0 16px rgba(3, 105, 161, 0.3);
      --gradient-bg: linear-gradient(135deg, #c2e7f7 0%, #92d4ef 35%, #68c1e7 70%, #4fb6e3 100%);
      --gradient-card: linear-gradient(145deg, #a8dcf4 0%, #7ac6eb 40%, #5fb0db 80%, #4ba3d1 100%);
    }
    
    * {
      transition: color 0.4s ease, background-color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease, background 0.4s ease;
    }

    /* Theme transition animations */
    :root {
      transition: all 0.4s ease;
    }
    
    body, header, section, .chart-box {
      transition: background 0.4s ease, color 0.4s ease, border-color 0.4s ease, box-shadow 0.4s ease;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--gradient-bg);
      color: var(--color-text-primary);
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 25% 25%, var(--color-primary)10, transparent 50%),
                  radial-gradient(circle at 75% 75%, var(--color-accent)08, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .header-nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(20, 36, 47, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--color-border);
      padding: 10px 0;
      z-index: 10000;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .header-nav.scrolled {
      background: rgba(20, 36, 47, 0.98);
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.5);
    }

    /* Theme-specific navigation backgrounds */
    [data-theme="night"] .header-nav {
      background: rgba(15, 23, 42, 0.95);
    }

    [data-theme="night"] .header-nav.scrolled {
      background: rgba(15, 23, 42, 0.98);
    }

    [data-theme="light-ocean"] .header-nav {
      background: rgba(122, 198, 235, 0.95);
    }

    [data-theme="light-ocean"] .header-nav.scrolled {
      background: rgba(122, 198, 235, 0.98);
    }

    .main-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: nowrap;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 80px 0 20px;
      position: relative;
    }

    .main-nav a {
      color: var(--color-text-secondary);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9em;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid transparent;
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }

    .main-nav a:hover {
      color: var(--color-primary);
      background: var(--bg-card);
      border-color: var(--color-primary);
      box-shadow: var(--glow-primary);
      transform: translateY(-2px);
    }

    header {
      background: var(--bg-header);
      padding: 70px 20px 20px 20px;
      text-align: center;
      border-bottom: 2px solid var(--color-border-accent);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
    }
    
    header::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--color-primary), transparent);
      box-shadow: var(--glow-primary);
    }

    header h1 {
      margin: 0;
      font-size: 1.8em;
      color: var(--color-text-primary);
      text-shadow: var(--glow-primary);
    }

    section {
      padding: 20px 40px;
    }

    h2 {
      color: var(--color-text-primary);
      margin-top: 40px;
      font-size: 1.4em;
      border-left: 4px solid var(--color-primary);
      padding-left: 12px;
      text-shadow: var(--glow-accent);
      position: relative;
    }
    
    h2::before {
      content: '';
      position: absolute;
      left: -4px;
      top: 0;
      width: 4px;
      height: 100%;
      background: var(--color-primary);
      box-shadow: var(--glow-primary);
    }

    .grid-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 20px;
    }

    .chart-box {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      border: 1px solid var(--color-border);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .chart-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at top left, var(--color-primary)05, transparent 50%);
      pointer-events: none;
    }
    
    .chart-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5), var(--glow-primary);
      border-color: var(--color-primary);
    }

    .chart-box h3 {
      margin: 0 0 15px;
      text-align: center;
      font-size: 1.1em;
      color: var(--color-text-primary);
      font-weight: 600;
      text-shadow: var(--glow-accent);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .chart-header h3 {
      margin: 0;
      flex: 1;
      text-align: center;
    }

    .reset-zoom-btn {
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 0.75em;
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.7;
      font-weight: 500;
    }

    .reset-zoom-btn:hover {
      background: var(--color-primary);
      color: var(--bg-primary);
      opacity: 1;
      box-shadow: var(--glow-primary);
      border-color: var(--color-primary);
    }

    .zoom-controls {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .zoom-btn, .pan-btn {
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      width: 26px;
      height: 26px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
      opacity: 0.7;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .zoom-btn:hover, .pan-btn:hover {
      background: var(--color-primary);
      color: var(--bg-primary);
      opacity: 1;
      box-shadow: var(--glow-primary);
      border-color: var(--color-primary);
    }

    .chart-controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 2px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      padding: 3px;
      border: 1px solid var(--color-border);
    }

    .control-label {
      font-size: 0.65em;
      color: var(--color-text-muted);
      padding: 0 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .chart-controls-hint {
      font-size: 0.7em;
      color: var(--color-text-muted);
      text-align: center;
      margin-top: 8px;
      opacity: 0.7;
    }

    canvas {
      width: 100% !important;
      aspect-ratio: 1.6;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid var(--color-border);
      padding: 10px 15px;
      text-align: center;
      color: var(--color-text-secondary);
      font-family: 'JetBrains Mono', monospace;
    }

    th {
      background: var(--gradient-card);
      color: var(--color-text-primary);
      font-weight: 600;
      text-shadow: var(--glow-accent);
    }

    .download-controls {
      margin-top: 40px;
    }

    .download-controls button,
    .download-controls select {
      margin: 10px 10px 0 0;
      padding: 8px 12px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
    }

    .download-controls button {
      background: var(--color-primary);
      color: var(--bg-primary);
      cursor: pointer;
      box-shadow: var(--glow-primary);
      border: 1px solid var(--color-primary);
      transition: all 0.3s ease;
      font-weight: 600;
    }
    
    .download-controls button:hover {
      background: var(--color-accent);
      box-shadow: var(--glow-accent);
      transform: translateY(-1px);
    }

    .download-controls select {
      background: var(--bg-card);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .back-btn {
      background: var(--color-primary);
      color: var(--bg-primary);
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.3s ease;
      box-shadow: var(--glow-primary);
      border: 1px solid var(--color-primary);
    }

    .back-btn:hover {
      background: var(--color-accent);
      transform: translateY(-2px);
      box-shadow: var(--glow-accent);
    }

    /* Time Range Filter Styles */
    .time-filter-section {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .time-filter-section h3 {
      margin: 0 0 15px 0;
      color: var(--color-text-primary);
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .time-filter-section h3::before {
      content: '';
      width: 4px;
      height: 20px;
      background: var(--color-primary);
      border-radius: 2px;
      box-shadow: var(--glow-primary);
    }

    .time-filter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .time-preset-btn {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .time-preset-btn:hover {
      background: var(--bg-card);
      border-color: var(--color-primary);
      color: var(--color-text-primary);
      box-shadow: var(--glow-accent);
    }

    .time-preset-btn.active {
      background: var(--color-primary);
      color: var(--bg-primary);
      border-color: var(--color-primary);
      box-shadow: var(--glow-primary);
      font-weight: 600;
    }

    .time-filter-divider {
      width: 1px;
      height: 30px;
      background: var(--color-border);
      margin: 0 5px;
    }

    .custom-range-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--color-border);
    }

    .custom-range-container.active {
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
    }

    .custom-range-label {
      font-size: 0.8em;
      color: var(--color-text-muted);
      font-weight: 500;
    }

    .custom-range-input {
      width: 70px;
      padding: 6px 10px;
      background: var(--bg-secondary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85em;
      text-align: center;
    }

    .custom-range-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
    }

    .custom-range-input::placeholder {
      color: var(--color-text-muted);
      opacity: 0.6;
    }

    .apply-custom-btn {
      padding: 6px 12px;
      background: var(--color-secondary);
      color: var(--bg-primary);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .apply-custom-btn:hover {
      background: var(--color-primary);
      box-shadow: var(--glow-primary);
    }

    .time-filter-info {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--color-border);
      font-size: 0.85em;
      color: var(--color-text-muted);
    }

    .time-filter-info span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .time-filter-info .info-value {
      color: var(--color-text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    .export-filtered-btn {
      margin-left: auto;
      padding: 8px 16px;
      background: var(--color-accent);
      color: var(--color-text-primary);
      border: 1px solid var(--color-primary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .export-filtered-btn:hover {
      background: var(--color-primary);
      color: var(--bg-primary);
      box-shadow: var(--glow-primary);
    }

    .export-filtered-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .time-filter-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .time-filter-divider {
        width: 100%;
        height: 1px;
        margin: 5px 0;
      }

      .custom-range-container {
        flex-wrap: wrap;
        justify-content: center;
      }

      .time-filter-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .export-filtered-btn {
        margin-left: 0;
        width: 100%;
        justify-content: center;
      }
    }
    
    /* Theme Selector Styles */
    .theme-selector {
      position: fixed;
      top: 8px;
      right: 20px;
      z-index: 10001;
      background: var(--gradient-card);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      box-shadow: var(--glow-primary), 0 4px 15px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      width: 140px;
    }
    
    .theme-selector:hover {
      box-shadow: var(--glow-accent), 0 6px 20px rgba(0, 0, 0, 0.5);
    }
    
    .theme-dropdown {
      position: relative;
    }
    
    .theme-dropdown-btn {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-card);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 500;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .theme-dropdown-btn:hover {
      border-color: var(--color-primary);
      box-shadow: var(--glow-primary);
    }
    
    .theme-dropdown-arrow {
      font-size: 0.7em;
      transition: transform 0.3s ease;
      color: var(--color-primary);
    }
    
    .theme-dropdown.open .theme-dropdown-arrow {
      transform: rotate(180deg);
    }
    
    .theme-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--gradient-card);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      margin-top: 4px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }
    
    .theme-dropdown.open .theme-options {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .theme-button {
      width: 100%;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: #ffffff !important;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85em;
      font-weight: 500;
      text-align: left;
      border-radius: 6px;
      margin: 2px 0;
    }
    
    .theme-button:first-child {
      border-radius: 8px 8px 6px 6px;
    }
    
    .theme-button:last-child {
      border-radius: 6px 6px 8px 8px;
    }
    
    .theme-button:hover {
      background: var(--bg-tertiary);
      color: #ffffff !important;
    }
    
    .theme-button.active {
      background: var(--color-primary);
      color: #000000;
      font-weight: 600;
    }
    
    
    @media (max-width: 768px) {
      .theme-selector {
        top: 8px;
        right: 10px;
        width: 120px;
      }

      .theme-dropdown-btn {
        padding: 8px 10px;
        font-size: 0.8em;
      }

      .theme-options {
        min-width: 120px;
      }
    }

    /* Extended Statistics Styles */
    .stats-meta-section {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      margin-top: 20px;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .stats-meta-section h2 {
      margin-top: 0;
      margin-bottom: 15px;
    }

    .stats-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .stats-meta-card {
      background: var(--bg-tertiary);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .stats-meta-card:hover {
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
      transform: translateY(-2px);
    }

    .stats-meta-label {
      font-size: 0.75em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    .stats-meta-value {
      font-size: 1.3em;
      color: var(--color-primary);
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      text-shadow: var(--glow-accent);
    }

    .stats-table-container {
      overflow-x: auto;
      margin-top: 15px;
      border-radius: 12px;
      border: 1px solid var(--color-border);
      background: var(--gradient-card);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .extended-stats-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      min-width: 900px;
    }

    .extended-stats-table th,
    .extended-stats-table td {
      border: 1px solid var(--color-border);
      padding: 12px 10px;
      text-align: center;
      font-size: 0.85em;
    }

    .extended-stats-table th {
      background: var(--bg-header);
      color: var(--color-text-primary);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75em;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .extended-stats-table td {
      font-family: 'JetBrains Mono', monospace;
    }

    .extended-stats-table td:first-child {
      text-align: left;
      font-weight: 500;
      color: var(--color-text-primary);
      background: var(--bg-tertiary);
      white-space: nowrap;
    }

    .extended-stats-table tbody tr:hover {
      background: rgba(0, 170, 255, 0.05);
    }

    .extended-stats-table tbody tr:hover td:first-child {
      background: rgba(0, 170, 255, 0.1);
    }

    .stat-positive {
      color: #22c55e;
    }

    .stat-negative {
      color: #ef4444;
    }

    .stat-neutral {
      color: var(--color-text-secondary);
    }

    @media (max-width: 768px) {
      .stats-meta-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .stats-meta-card {
        padding: 12px;
      }

      .stats-meta-value {
        font-size: 1.1em;
      }

      .extended-stats-table th,
      .extended-stats-table td {
        padding: 8px 6px;
        font-size: 0.8em;
      }
    }

    /* Multi-Metric Correlation Styles */
    .correlation-controls {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .correlation-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: flex-end;
    }

    .selector-group {
      flex: 1;
      min-width: 200px;
    }

    .selector-label {
      display: block;
      font-size: 0.85em;
      color: var(--color-text-muted);
      margin-bottom: 8px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .multi-select-container {
      position: relative;
    }

    .multi-select-btn {
      width: 100%;
      padding: 12px 15px;
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .multi-select-btn:hover {
      border-color: var(--color-primary);
      box-shadow: var(--glow-accent);
    }

    .multi-select-btn .dropdown-arrow {
      font-size: 0.7em;
      color: var(--color-primary);
      transition: transform 0.3s ease;
    }

    .multi-select-container.open .dropdown-arrow {
      transform: rotate(180deg);
    }

    .multi-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      margin-top: 4px;
      max-height: 250px;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 100;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    .multi-select-container.open .multi-select-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .multi-select-option {
      padding: 10px 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--color-border);
    }

    .multi-select-option:last-child {
      border-bottom: none;
    }

    .multi-select-option:hover {
      background: var(--bg-tertiary);
    }

    .multi-select-option.selected {
      background: rgba(0, 170, 255, 0.1);
    }

    .multi-select-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--color-border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .multi-select-option.selected .multi-select-checkbox {
      background: var(--color-primary);
      border-color: var(--color-primary);
    }

    .multi-select-checkbox::after {
      content: '✓';
      color: var(--bg-primary);
      font-size: 0.8em;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .multi-select-option.selected .multi-select-checkbox::after {
      opacity: 1;
    }

    .multi-select-option-label {
      flex: 1;
      font-size: 0.85em;
      color: var(--color-text-secondary);
    }

    .multi-select-option-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .correlation-update-btn {
      padding: 12px 24px;
      background: var(--color-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--glow-primary);
    }

    .correlation-update-btn:hover {
      background: var(--color-secondary);
      transform: translateY(-2px);
    }

    .correlation-clear-btn {
      padding: 12px 20px;
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .correlation-clear-btn:hover {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }

    .correlation-chart-box {
      min-height: 400px;
    }

    .correlation-chart-box canvas {
      aspect-ratio: 2.5;
    }

    .correlation-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--color-border);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8em;
      color: var(--color-text-secondary);
      padding: 5px 10px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      border: 1px solid var(--color-border);
    }

    .legend-line {
      width: 25px;
      height: 3px;
      border-radius: 2px;
    }

    .legend-line.dashed {
      background: repeating-linear-gradient(
        90deg,
        currentColor 0px,
        currentColor 5px,
        transparent 5px,
        transparent 10px
      );
      height: 3px;
    }

    .legend-axis-label {
      font-size: 0.7em;
      color: var(--color-text-muted);
      text-transform: uppercase;
      padding: 2px 6px;
      background: var(--bg-secondary);
      border-radius: 3px;
    }

    @media (max-width: 768px) {
      .correlation-selector {
        flex-direction: column;
      }

      .selector-group {
        width: 100%;
      }

      .correlation-update-btn,
      .correlation-clear-btn {
        width: 100%;
      }

      .correlation-chart-box canvas {
        aspect-ratio: 1.5;
      }
    }

    /* Chart Export Styles */
    .chart-export-controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .export-options-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .export-checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      background: var(--bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
      color: var(--color-text-secondary);
    }

    .export-checkbox-label:hover {
      border-color: var(--color-primary);
      background: var(--bg-card);
    }

    .export-checkbox-label input[type="checkbox"] {
      display: none;
    }

    .export-checkbox-custom {
      width: 20px;
      height: 20px;
      border: 2px solid var(--color-border);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .export-checkbox-label input[type="checkbox"]:checked + .export-checkbox-custom {
      background: var(--color-primary);
      border-color: var(--color-primary);
    }

    .export-checkbox-custom::after {
      content: '✓';
      color: var(--bg-primary);
      font-size: 0.85em;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .export-checkbox-label input[type="checkbox"]:checked + .export-checkbox-custom::after {
      opacity: 1;
    }

    .export-format-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .export-format-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .export-format-select {
      padding: 10px 15px;
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      min-width: 180px;
      transition: all 0.3s ease;
    }

    .export-format-select:hover,
    .export-format-select:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: var(--glow-accent);
    }

    .export-actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 5px;
    }

    .export-chart-btn {
      padding: 12px 24px;
      background: var(--color-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--glow-primary);
    }

    .export-chart-btn:hover {
      background: var(--color-secondary);
      transform: translateY(-2px);
    }

    .export-chart-btn.secondary {
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      box-shadow: none;
    }

    .export-chart-btn.secondary:hover {
      background: var(--bg-card);
      border-color: var(--color-primary);
      color: var(--color-text-primary);
    }

    .export-chart-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .export-status {
      font-size: 0.85em;
      color: var(--color-text-muted);
      min-height: 20px;
    }

    .export-status.success {
      color: #22c55e;
    }

    .export-status.error {
      color: #ef4444;
    }

    .export-status.progress {
      color: var(--color-primary);
    }

    @media (max-width: 768px) {
      .export-options-grid {
        flex-direction: column;
      }

      .export-checkbox-label {
        width: 100%;
      }

      .export-format-row {
        flex-direction: column;
      }

      .export-format-select {
        width: 100%;
      }

      .export-actions-row {
        flex-direction: column;
      }

      .export-chart-btn {
        width: 100%;
      }
    }

    /* Mission Comparison Styles */
    .comparison-controls {
      background: var(--gradient-card);
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      border: 1px solid var(--color-border);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }

    .comparison-selectors {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .mission-selector-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mission-select {
      padding: 12px 15px;
      background: var(--bg-tertiary);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mission-select:hover,
    .mission-select:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: var(--glow-accent);
    }

    .mission-select option {
      background: var(--bg-card);
      color: var(--color-text-primary);
    }

    .mission-info {
      font-size: 0.8em;
      color: var(--color-text-muted);
      min-height: 1.2em;
    }

    .mission-info.loaded {
      color: var(--color-primary);
    }

    .comparison-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .comparison-btn {
      padding: 12px 24px;
      background: var(--color-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9em;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--glow-primary);
    }

    .comparison-btn:hover {
      background: var(--color-secondary);
      transform: translateY(-2px);
    }

    .comparison-btn.secondary {
      background: var(--bg-tertiary);
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      box-shadow: none;
    }

    .comparison-btn.secondary:hover {
      background: var(--bg-card);
      border-color: var(--color-primary);
      color: var(--color-text-primary);
    }

    .comparison-checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: var(--bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
      color: var(--color-text-secondary);
    }

    .comparison-checkbox-label:hover {
      border-color: var(--color-primary);
    }

    .comparison-checkbox-label input[type="checkbox"] {
      display: none;
    }

    .comparison-status {
      font-size: 0.85em;
      color: var(--color-text-muted);
      min-height: 20px;
      margin-bottom: 15px;
    }

    .comparison-status.loading {
      color: var(--color-primary);
    }

    .comparison-status.error {
      color: #ef4444;
    }

    .comparison-status.success {
      color: #22c55e;
    }

    .comparison-chart-box {
      min-height: 400px;
    }

    .comparison-chart-box canvas {
      aspect-ratio: 2.5;
    }

    .comparison-stats-section {
      margin-top: 30px;
    }

    .comparison-stats-section h3 {
      margin-bottom: 15px;
    }

    .comparison-stats-table td.positive {
      color: #22c55e;
    }

    .comparison-stats-table td.negative {
      color: #ef4444;
    }

    .comparison-stats-table td.neutral {
      color: var(--color-text-muted);
    }

    @media (max-width: 768px) {
      .comparison-selectors {
        grid-template-columns: 1fr;
      }

      .comparison-actions {
        flex-direction: column;
      }

      .comparison-btn,
      .comparison-checkbox-label {
        width: 100%;
        justify-content: center;
      }

      .comparison-chart-box canvas {
        aspect-ratio: 1.5;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-nav">
      <nav class="main-nav">
        <a href="/">← Back to Homepage</a>
        <a href="#mission-control">Mission Control</a>
        <a href="#bme280">BME280 Data</a>
        <a href="#mpu6050">MPU6050 Data</a>
        <a href="#correlation">Correlation</a>
        <a href="#mission-compare">Compare</a>
        <a href="#statistics">Statistics</a>
        <a href="#downloads">Downloads</a>
        <!-- Theme Selector -->
        <div class="theme-selector">
          <div class="theme-dropdown">
            <button class="theme-dropdown-btn">
              <span class="theme-current">Dark Ocean</span>
              <span class="theme-dropdown-arrow">▼</span>
            </button>
            <div class="theme-options">
              <div class="theme-button active" data-theme="dark-ocean">Dark Ocean</div>
              <div class="theme-button" data-theme="night">Night</div>
              <div class="theme-button" data-theme="light-ocean">Light Ocean</div>
            </div>
          </div>
        </div>
      </nav>
    </div>
    <h1 style="margin: 60px 0 0 0;">Mission Control TRITON</h1>
  </header>

  <!-- Mission Control Section -->
  <section id="mission-control" class="download-controls">
    <h2>Mission Control</h2>
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <button id="startStopBtn" onclick="toggleDataGeneration()">Start Test Data</button>
      <select id="speedSelect" onchange="updateSpeed()" style="background-color: #1c1d22; color: #f0f0f0; border: 1px solid #333; padding: 8px 12px; border-radius: 6px;">
        <option value="0.5">0.5x Speed (4s)</option>
        <option value="1">1x Speed (2s)</option>
        <option value="2">2x Speed (1s)</option>
        <option value="5">5x Speed (0.4s)</option>
        <option value="10" selected>10x Speed (0.2s)</option>
      </select>
      <button id="clearBtn" onclick="clearTestData()" style="background-color: #ef4444;">Clear Data</button>
    </div>
    <div style="margin-top: 10px;">
      <span id="generateStatus" style="color: #38bdf8;"></span>
    </div>

    <!-- Time Range Filter -->
    <div class="time-filter-section">
      <h3>Time Range Filter</h3>
      <div class="time-filter-controls">
        <button class="time-preset-btn active" data-preset="all" onclick="setTimeFilter('all')">All Data</button>
        <button class="time-preset-btn" data-preset="30" onclick="setTimeFilter(30)">Last 30s</button>
        <button class="time-preset-btn" data-preset="60" onclick="setTimeFilter(60)">Last 1min</button>
        <button class="time-preset-btn" data-preset="300" onclick="setTimeFilter(300)">Last 5min</button>

        <div class="time-filter-divider"></div>

        <div class="custom-range-container" id="customRangeContainer">
          <span class="custom-range-label">Custom:</span>
          <input type="number" class="custom-range-input" id="customFromTime" placeholder="From (s)" min="0" step="0.1">
          <span class="custom-range-label">to</span>
          <input type="number" class="custom-range-input" id="customToTime" placeholder="To (s)" min="0" step="0.1">
          <button class="apply-custom-btn" onclick="applyCustomRange()">Apply</button>
        </div>
      </div>

      <div class="time-filter-info">
        <span>Total points: <span class="info-value" id="totalPointsCount">0</span></span>
        <span>Filtered points: <span class="info-value" id="filteredPointsCount">0</span></span>
        <span>Time range: <span class="info-value" id="currentTimeRange">All</span></span>
      </div>
    </div>
  </section>

  <!-- BME280 Section -->
  <section id="bme280">
    <h2>BME280 Sensor</h2>
    <p class="chart-controls-hint">Use controls below each chart to zoom and pan • Drag to select zoom area • Click legend to toggle</p>
    <div class="grid-2col">
      <div class="chart-box">
        <h3>Temperature [°C]</h3>
        <canvas id="Temp_BME280 [°C]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Temp_BME280 [°C]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Temp_BME280 [°C]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Temp_BME280 [°C]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Temp_BME280 [°C]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Temp_BME280 [°C]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Temp_BME280 [°C]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Temp_BME280 [°C]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Humidity [%]</h3>
        <canvas id="Hum [%]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Hum [%]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Hum [%]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Hum [%]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Hum [%]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Hum [%]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Hum [%]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Hum [%]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Pressure [hPa]</h3>
        <canvas id="Press [hPa]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Press [hPa]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Press [hPa]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Press [hPa]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Press [hPa]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Press [hPa]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Press [hPa]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Press [hPa]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Altitude [m]</h3>
        <canvas id="Alt [m]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Alt [m]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Alt [m]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Alt [m]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Alt [m]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Alt [m]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Alt [m]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Alt [m]')">Reset</button>
        </div>
      </div>
    </div>
  </section>

  <!-- MPU6050 Section -->
  <section id="mpu6050">
    <h2>MPU6050 Sensor</h2>
    <p class="chart-controls-hint">Use controls below each chart to zoom and pan • Drag to select zoom area • Click legend to toggle</p>
    <div class="grid-2col">
      <div class="chart-box">
        <h3>Acc X [m/s²]</h3>
        <canvas id="Acc x [m/s²]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Acc x [m/s²]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Acc x [m/s²]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Acc x [m/s²]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Acc x [m/s²]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Acc x [m/s²]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Acc x [m/s²]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Acc x [m/s²]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Gyro X [°/s]</h3>
        <canvas id="Gyro x [°/s]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Gyro x [°/s]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Gyro x [°/s]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Gyro x [°/s]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Gyro x [°/s]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Gyro x [°/s]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Gyro x [°/s]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Gyro x [°/s]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Acc Y [m/s²]</h3>
        <canvas id="Acc y [m/s²]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Acc y [m/s²]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Acc y [m/s²]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Acc y [m/s²]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Acc y [m/s²]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Acc y [m/s²]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Acc y [m/s²]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Acc y [m/s²]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Gyro Y [°/s]</h3>
        <canvas id="Gyro y [°/s]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Gyro y [°/s]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Gyro y [°/s]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Gyro y [°/s]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Gyro y [°/s]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Gyro y [°/s]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Gyro y [°/s]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Gyro y [°/s]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Acc Z [m/s²]</h3>
        <canvas id="Acc z [m/s²]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Acc z [m/s²]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Acc z [m/s²]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Acc z [m/s²]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Acc z [m/s²]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Acc z [m/s²]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Acc z [m/s²]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Acc z [m/s²]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Gyro Z [°/s]</h3>
        <canvas id="Gyro z [°/s]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Gyro z [°/s]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Gyro z [°/s]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Gyro z [°/s]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Gyro z [°/s]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Gyro z [°/s]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Gyro z [°/s]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Gyro z [°/s]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3>Temperature [°C]</h3>
        <canvas id="Temp_MPU [°C]"></canvas>
        <div class="chart-controls">
          <div class="control-group">
            <span class="control-label">Zoom</span>
            <button class="zoom-btn" onclick="zoomChart('Temp_MPU [°C]', 'out')">−</button>
            <button class="zoom-btn" onclick="zoomChart('Temp_MPU [°C]', 'in')">+</button>
          </div>
          <div class="control-group">
            <span class="control-label">Pan</span>
            <button class="pan-btn" onclick="panChart('Temp_MPU [°C]', 'left')">←</button>
            <button class="pan-btn" onclick="panChart('Temp_MPU [°C]', 'right')">→</button>
            <button class="pan-btn" onclick="panChart('Temp_MPU [°C]', 'up')">↑</button>
            <button class="pan-btn" onclick="panChart('Temp_MPU [°C]', 'down')">↓</button>
          </div>
          <button class="reset-zoom-btn" onclick="resetChartZoom('Temp_MPU [°C]')">Reset</button>
        </div>
      </div>
      <div class="chart-box">
        <h3 style="opacity: 0.5;">Reset All Charts</h3>
        <div style="display: flex; justify-content: center; align-items: center; height: 100%; min-height: 150px;">
          <button onclick="resetAllZoom()" style="padding: 15px 30px; font-size: 1em; background: var(--color-primary); color: var(--bg-primary); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: var(--glow-primary); transition: all 0.3s ease;">
            Reset All Zoom
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Multi-Metric Correlation Section -->
  <section id="correlation">
    <h2>Multi-Metric Correlation</h2>
    <p class="chart-controls-hint">Compare multiple metrics on dual Y-axes • Left axis = solid lines • Right axis = dashed lines</p>

    <div class="correlation-controls">
      <div class="correlation-selector">
        <div class="selector-group">
          <label class="selector-label">Left Y-Axis (Solid Lines)</label>
          <div class="multi-select-container" id="leftAxisContainer">
            <button class="multi-select-btn" onclick="toggleMultiSelect('left')">
              <span class="selected-count" id="leftSelectedCount">Select metrics...</span>
              <span class="dropdown-arrow">▼</span>
            </button>
            <div class="multi-select-dropdown" id="leftAxisDropdown">
              <!-- Options populated by JavaScript -->
            </div>
          </div>
        </div>

        <div class="selector-group">
          <label class="selector-label">Right Y-Axis (Dashed Lines)</label>
          <div class="multi-select-container" id="rightAxisContainer">
            <button class="multi-select-btn" onclick="toggleMultiSelect('right')">
              <span class="selected-count" id="rightSelectedCount">Select metrics...</span>
              <span class="dropdown-arrow">▼</span>
            </button>
            <div class="multi-select-dropdown" id="rightAxisDropdown">
              <!-- Options populated by JavaScript -->
            </div>
          </div>
        </div>

        <button class="correlation-update-btn" onclick="updateCorrelationChart()">Update Chart</button>
        <button class="correlation-clear-btn" onclick="clearCorrelationSelections()">Clear All</button>
      </div>
    </div>

    <div class="chart-box correlation-chart-box">
      <div class="chart-header">
        <h3>Metric Correlation View</h3>
        <button class="reset-zoom-btn" onclick="resetCorrelationZoom()">Reset Zoom</button>
      </div>
      <canvas id="correlationChart"></canvas>
      <div class="chart-controls">
        <div class="control-group">
          <span class="control-label">Zoom</span>
          <button class="zoom-btn" onclick="zoomCorrelationChart('out')">−</button>
          <button class="zoom-btn" onclick="zoomCorrelationChart('in')">+</button>
        </div>
        <div class="control-group">
          <span class="control-label">Pan</span>
          <button class="pan-btn" onclick="panCorrelationChart('left')">←</button>
          <button class="pan-btn" onclick="panCorrelationChart('right')">→</button>
        </div>
      </div>
      <div class="correlation-legend" id="correlationLegend">
        <!-- Legend populated by JavaScript -->
      </div>
    </div>
  </section>

  <!-- Mission Comparison Section -->
  <section id="mission-compare">
    <h2>Mission Comparison</h2>
    <p class="chart-controls-hint">Compare data from two different missions side-by-side</p>

    <div class="comparison-controls">
      <div class="comparison-selectors">
        <div class="mission-selector-group">
          <label class="selector-label">Mission 1 (Blue - Solid)</label>
          <select id="mission1Select" class="mission-select" onchange="onMissionSelect(1)">
            <option value="">Select a mission...</option>
          </select>
          <div class="mission-info" id="mission1Info"></div>
        </div>

        <div class="mission-selector-group">
          <label class="selector-label">Mission 2 (Orange - Dashed)</label>
          <select id="mission2Select" class="mission-select" onchange="onMissionSelect(2)">
            <option value="">Select a mission...</option>
          </select>
          <div class="mission-info" id="mission2Info"></div>
        </div>

        <div class="mission-selector-group">
          <label class="selector-label">Metric to Compare</label>
          <select id="compareMetricSelect" class="mission-select" onchange="updateComparisonChart()">
            <option value="Temp_BME280 [°C]">Temperature BME280 [°C]</option>
            <option value="Hum [%]">Humidity [%]</option>
            <option value="Press [hPa]">Pressure [hPa]</option>
            <option value="Alt [m]">Altitude [m]</option>
            <option value="Acc x [m/s²]">Acceleration X [m/s²]</option>
            <option value="Acc y [m/s²]">Acceleration Y [m/s²]</option>
            <option value="Acc z [m/s²]">Acceleration Z [m/s²]</option>
            <option value="Gyro x [°/s]">Gyroscope X [°/s]</option>
            <option value="Gyro y [°/s]">Gyroscope Y [°/s]</option>
            <option value="Gyro z [°/s]">Gyroscope Z [°/s]</option>
            <option value="Temp_MPU [°C]">Temperature MPU [°C]</option>
          </select>
        </div>
      </div>

      <div class="comparison-actions">
        <button class="comparison-btn" onclick="refreshMissionList()">Refresh Mission List</button>
        <button class="comparison-btn secondary" onclick="clearComparison()">Clear Comparison</button>
        <label class="comparison-checkbox-label">
          <input type="checkbox" id="includeCurrentData" onchange="updateComparisonChart()">
          <span class="export-checkbox-custom"></span>
          <span>Include Current Live Data (Green)</span>
        </label>
      </div>
    </div>

    <div class="comparison-status" id="comparisonStatus"></div>

    <!-- Comparison Chart -->
    <div class="chart-box comparison-chart-box">
      <div class="chart-header">
        <h3>Mission Comparison Chart</h3>
        <button class="reset-zoom-btn" onclick="resetComparisonZoom()">Reset Zoom</button>
      </div>
      <canvas id="comparisonChart"></canvas>
      <div class="chart-controls">
        <div class="control-group">
          <span class="control-label">Zoom</span>
          <button class="zoom-btn" onclick="zoomComparisonChart('out')">−</button>
          <button class="zoom-btn" onclick="zoomComparisonChart('in')">+</button>
        </div>
        <div class="control-group">
          <span class="control-label">Pan</span>
          <button class="pan-btn" onclick="panComparisonChart('left')">←</button>
          <button class="pan-btn" onclick="panComparisonChart('right')">→</button>
        </div>
      </div>
    </div>

    <!-- Comparison Statistics Table -->
    <div class="comparison-stats-section">
      <h3>Statistics Comparison</h3>
      <div class="stats-table-container">
        <table class="extended-stats-table comparison-stats-table">
          <thead>
            <tr>
              <th>Statistic</th>
              <th>Mission 1</th>
              <th>Mission 2</th>
              <th>Difference</th>
              <th>Current</th>
            </tr>
          </thead>
          <tbody id="comparisonStatsBody">
            <tr><td colspan="5" style="text-align: center; color: var(--color-text-muted);">Select missions to compare</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Statistics Section -->
  <section id="statistics">
    <!-- Stats Meta Info -->
    <div class="stats-meta-section">
      <h2>Data Overview</h2>
      <div class="stats-meta-grid">
        <div class="stats-meta-card">
          <span class="stats-meta-label">Total Points</span>
          <span class="stats-meta-value" id="statsTotalPoints">0</span>
        </div>
        <div class="stats-meta-card">
          <span class="stats-meta-label">Filtered Points</span>
          <span class="stats-meta-value" id="statsFilteredPoints">0</span>
        </div>
        <div class="stats-meta-card">
          <span class="stats-meta-label">Sample Rate</span>
          <span class="stats-meta-value" id="statsSampleRate">-- Hz</span>
        </div>
        <div class="stats-meta-card">
          <span class="stats-meta-label">Time Span</span>
          <span class="stats-meta-value" id="statsTimeSpan">-- s</span>
        </div>
        <div class="stats-meta-card">
          <span class="stats-meta-label">Last Update</span>
          <span class="stats-meta-value" id="statsLastUpdate">--</span>
        </div>
      </div>
    </div>

    <h2>Statistics: BME280</h2>
    <div class="stats-table-container">
      <table class="extended-stats-table">
        <thead>
          <tr>
            <th>Metric</th>
            <th>Min</th>
            <th>Max</th>
            <th>Avg</th>
            <th>Median</th>
            <th>StdDev</th>
            <th>25%</th>
            <th>75%</th>
            <th>95%</th>
            <th>Rate/s</th>
          </tr>
        </thead>
        <tbody id="bmeSummary"></tbody>
      </table>
    </div>

    <h2 style="margin-top: 50px;">Statistics: MPU6050</h2>
    <div class="stats-table-container">
      <table class="extended-stats-table">
        <thead>
          <tr>
            <th>Metric</th>
            <th>Min</th>
            <th>Max</th>
            <th>Avg</th>
            <th>Median</th>
            <th>StdDev</th>
            <th>25%</th>
            <th>75%</th>
            <th>95%</th>
            <th>Rate/s</th>
          </tr>
        </thead>
        <tbody id="mpuSummary"></tbody>
      </table>
    </div>
  </section>


  <!-- Download Section -->
  <section id="downloads" class="download-controls">
    <h2>Download Logs</h2>
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <button onclick="downloadLatest()">Download Latest Log</button>
      <select id="logSelect" onchange="downloadSelected()">
        <option value="">-- Select archived log --</option>
      </select>
      <button onclick="openLogsFolder()" style="background-color: #6366f1;">Open Logs Folder</button>
    </div>
    <div style="margin-top: 10px;">
      <span id="folderStatus" style="color: #38bdf8;"></span>
    </div>

    <!-- Export Filtered Data -->
    <div class="time-filter-section" style="margin-top: 30px;">
      <h3>Export Filtered Data</h3>
      <div class="time-filter-controls">
        <button class="time-preset-btn active" data-export-preset="all" onclick="setExportFilter('all')">All Data</button>
        <button class="time-preset-btn" data-export-preset="30" onclick="setExportFilter(30)">Last 30s</button>
        <button class="time-preset-btn" data-export-preset="60" onclick="setExportFilter(60)">Last 1min</button>
        <button class="time-preset-btn" data-export-preset="300" onclick="setExportFilter(300)">Last 5min</button>

        <div class="time-filter-divider"></div>

        <div class="custom-range-container" id="exportCustomRangeContainer">
          <span class="custom-range-label">Custom:</span>
          <input type="number" class="custom-range-input" id="exportFromTime" placeholder="From (s)" min="0" step="0.1">
          <span class="custom-range-label">to</span>
          <input type="number" class="custom-range-input" id="exportToTime" placeholder="To (s)" min="0" step="0.1">
          <button class="apply-custom-btn" onclick="applyExportCustomRange()">Apply</button>
        </div>
      </div>

      <div class="time-filter-info">
        <span>Points to export: <span class="info-value" id="exportPointsCount">0</span></span>
        <span>Export range: <span class="info-value" id="exportTimeRange">All</span></span>
        <button class="export-filtered-btn" onclick="exportFilteredData()" id="exportFilteredBtn">
          <span>Export Filtered CSV</span>
        </button>
      </div>
    </div>

    <!-- Export Charts Section -->
    <div class="time-filter-section" style="margin-top: 30px;">
      <h3>Export Charts as Images</h3>
      <div class="chart-export-controls">
        <div class="export-options-grid">
          <label class="export-checkbox-label">
            <input type="checkbox" id="exportBME280" checked>
            <span class="export-checkbox-custom"></span>
            <span>BME280 Charts (4)</span>
          </label>
          <label class="export-checkbox-label">
            <input type="checkbox" id="exportMPU6050" checked>
            <span class="export-checkbox-custom"></span>
            <span>MPU6050 Charts (7)</span>
          </label>
          <label class="export-checkbox-label">
            <input type="checkbox" id="exportCorrelation">
            <span class="export-checkbox-custom"></span>
            <span>Correlation Chart</span>
          </label>
        </div>

        <div class="export-format-row">
          <div class="export-format-group">
            <label class="selector-label">Format</label>
            <select id="chartExportFormat" class="export-format-select">
              <option value="png">PNG (High Quality)</option>
              <option value="jpeg">JPEG (Smaller Size)</option>
            </select>
          </div>

          <div class="export-format-group">
            <label class="selector-label">Download As</label>
            <select id="chartExportMode" class="export-format-select">
              <option value="zip">ZIP Archive</option>
              <option value="individual">Individual Files</option>
            </select>
          </div>
        </div>

        <div class="export-actions-row">
          <button class="export-chart-btn" onclick="exportSelectedCharts()">
            Export Selected Charts
          </button>
          <button class="export-chart-btn secondary" onclick="selectAllChartExports(true)">
            Select All
          </button>
          <button class="export-chart-btn secondary" onclick="selectAllChartExports(false)">
            Deselect All
          </button>
        </div>

        <div class="export-status" id="chartExportStatus"></div>
      </div>
    </div>
  </section>

  <!-- Chart and Data Script -->
  <script>
    const chartRefs = {};
    // Full history storage (all data from server)
    let fullHistory = {};
    // Current time filter settings (for display)
    let currentTimeFilter = {
      type: 'all',  // 'all', 'preset', 'custom'
      value: null,  // seconds for preset, or {from, to} for custom
    };
    // Export time filter settings (separate from display filter)
    let exportTimeFilter = {
      type: 'all',
      value: null,
    };

    const fields = {
      "Temp_BME280 [°C]": "bme",
      "Hum [%]": "bme",
      "Press [hPa]": "bme",
      "Alt [m]": "bme",
      "Acc x [m/s²]": "mpu",
      "Acc y [m/s²]": "mpu",
      "Acc z [m/s²]": "mpu",
      "Gyro x [°/s]": "mpu",
      "Gyro y [°/s]": "mpu",
      "Gyro z [°/s]": "mpu",
      "Temp_MPU [°C]": "mpu"
    };

    function createChart(id, label) {
      const ctx = document.getElementById(id).getContext("2d");
      // Get current theme colors
      const computedStyle = getComputedStyle(document.documentElement);
      const primaryColor = computedStyle.getPropertyValue('--color-primary').trim();
      const backgroundColor = primaryColor + '20'; // Add transparency

      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: label,
            data: [],
            borderColor: primaryColor,
            backgroundColor: backgroundColor,
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: primaryColor,
            pointHoverBorderColor: '#fff',
            pointHoverBorderWidth: 2,
            tension: 0.3
          }]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          scales: {
            x: {
              type: "linear",
              title: { display: true, text: "Elapsed [s]", color: computedStyle.getPropertyValue('--color-text-muted').trim() },
              ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
              grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
            },
            y: {
              title: { display: true, text: label, color: computedStyle.getPropertyValue('--color-text-muted').trim() },
              ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
              grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
            }
          },
          plugins: {
            legend: {
              labels: { color: computedStyle.getPropertyValue('--color-text-primary').trim() },
              onClick: (e, legendItem, legend) => {
                const index = legendItem.datasetIndex;
                const chart = legend.chart;
                const meta = chart.getDatasetMeta(index);
                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                chart.update();
              }
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(0, 0, 0, 0.85)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: primaryColor,
              borderWidth: 1,
              cornerRadius: 8,
              padding: 12,
              displayColors: true,
              callbacks: {
                title: function(context) {
                  const value = context[0].label;
                  return `Time: ${parseFloat(value).toFixed(2)}s`;
                },
                label: function(context) {
                  const value = context.raw;
                  return ` ${context.dataset.label}: ${parseFloat(value).toFixed(3)}`;
                }
              }
            },
            zoom: {
              pan: {
                enabled: true,
                mode: 'xy',
                modifierKey: 'ctrl',
              },
              zoom: {
                wheel: {
                  enabled: false,
                },
                pinch: {
                  enabled: true,
                },
                drag: {
                  enabled: true,
                  backgroundColor: 'rgba(0, 170, 255, 0.15)',
                  borderColor: 'rgba(0, 170, 255, 0.8)',
                  borderWidth: 1,
                },
                mode: 'xy',
              },
              limits: {
                x: {min: 'original', max: 'original'},
                y: {min: 'original', max: 'original'},
              },
            }
          }
        }
      });
    }

    // Reset zoom for a specific chart
    function resetChartZoom(chartId) {
      if (chartRefs[chartId] && chartRefs[chartId].resetZoom) {
        chartRefs[chartId].resetZoom();
      }
    }

    // Reset zoom for all charts
    function resetAllZoom() {
      Object.values(chartRefs).forEach(chart => {
        if (chart && chart.resetZoom) {
          chart.resetZoom();
        }
      });
    }

    // Zoom in or out on a specific chart
    function zoomChart(chartId, direction) {
      const chart = chartRefs[chartId];
      if (!chart) return;

      const zoomFactor = direction === 'in' ? 1.2 : 0.8;
      chart.zoom(zoomFactor);
    }

    // Pan chart in a direction
    function panChart(chartId, direction) {
      const chart = chartRefs[chartId];
      if (!chart) return;

      const panAmount = 50; // pixels to pan
      let deltaX = 0, deltaY = 0;

      switch(direction) {
        case 'left':  deltaX = panAmount; break;
        case 'right': deltaX = -panAmount; break;
        case 'up':    deltaY = panAmount; break;
        case 'down':  deltaY = -panAmount; break;
      }

      chart.pan({x: deltaX, y: deltaY}, undefined, 'default');
    }

    function computeStats(values) {
      if (!values.length) return ["-", "-", "-"];
      let min = values[0], max = values[0], sum = 0;
      for (let v of values) {
        min = Math.min(min, v);
        max = Math.max(max, v);
        sum += v;
      }
      return [min.toFixed(2), max.toFixed(2), (sum / values.length).toFixed(2)];
    }

    // Extended statistics computation
    function computeExtendedStats(values, elapsedTimes) {
      if (!values || !values.length) {
        return {
          min: "-",
          max: "-",
          avg: "-",
          median: "-",
          stdDev: "-",
          p25: "-",
          p75: "-",
          p95: "-",
          ratePerSec: "-"
        };
      }

      const n = values.length;

      // Basic stats
      let min = values[0], max = values[0], sum = 0;
      for (let v of values) {
        min = Math.min(min, v);
        max = Math.max(max, v);
        sum += v;
      }
      const avg = sum / n;

      // Sort values for percentile calculations
      const sorted = [...values].sort((a, b) => a - b);

      // Median (50th percentile)
      const median = getPercentile(sorted, 0.5);

      // Standard deviation
      let sumSquaredDiff = 0;
      for (let v of values) {
        sumSquaredDiff += Math.pow(v - avg, 2);
      }
      const stdDev = Math.sqrt(sumSquaredDiff / n);

      // Percentiles
      const p25 = getPercentile(sorted, 0.25);
      const p75 = getPercentile(sorted, 0.75);
      const p95 = getPercentile(sorted, 0.95);

      // Rate of change (linear regression slope of last 5 points)
      let ratePerSec = 0;
      if (elapsedTimes && elapsedTimes.length >= 2) {
        const windowSize = Math.min(5, values.length);
        const recentValues = values.slice(-windowSize);
        const recentTimes = elapsedTimes.slice(-windowSize);
        ratePerSec = calculateLinearRegressionSlope(recentTimes, recentValues);
      }

      return {
        min: min.toFixed(2),
        max: max.toFixed(2),
        avg: avg.toFixed(2),
        median: median.toFixed(2),
        stdDev: stdDev.toFixed(3),
        p25: p25.toFixed(2),
        p75: p75.toFixed(2),
        p95: p95.toFixed(2),
        ratePerSec: ratePerSec.toFixed(3)
      };
    }

    // Get percentile using linear interpolation
    function getPercentile(sortedArray, percentile) {
      if (sortedArray.length === 0) return 0;
      if (sortedArray.length === 1) return sortedArray[0];

      const index = percentile * (sortedArray.length - 1);
      const lower = Math.floor(index);
      const upper = Math.ceil(index);
      const weight = index - lower;

      if (upper >= sortedArray.length) return sortedArray[sortedArray.length - 1];
      if (lower === upper) return sortedArray[lower];

      return sortedArray[lower] * (1 - weight) + sortedArray[upper] * weight;
    }

    // Calculate linear regression slope
    function calculateLinearRegressionSlope(xValues, yValues) {
      const n = xValues.length;
      if (n < 2) return 0;

      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      for (let i = 0; i < n; i++) {
        sumX += xValues[i];
        sumY += yValues[i];
        sumXY += xValues[i] * yValues[i];
        sumX2 += xValues[i] * xValues[i];
      }

      const denominator = n * sumX2 - sumX * sumX;
      if (denominator === 0) return 0;

      return (n * sumXY - sumX * sumY) / denominator;
    }

    // Format rate with color indication
    function formatRateWithColor(rate) {
      const numRate = parseFloat(rate);
      if (isNaN(numRate) || rate === "-") return `<span class="stat-neutral">-</span>`;

      if (numRate > 0.01) {
        return `<span class="stat-positive">+${rate}</span>`;
      } else if (numRate < -0.01) {
        return `<span class="stat-negative">${rate}</span>`;
      }
      return `<span class="stat-neutral">${rate}</span>`;
    }

    // Update stats meta information
    let lastUpdateTime = null;
    function updateStatsMeta(totalPoints, filteredPoints, elapsedTimes) {
      document.getElementById('statsTotalPoints').textContent = totalPoints;
      document.getElementById('statsFilteredPoints').textContent = filteredPoints;

      // Calculate sample rate
      if (elapsedTimes && elapsedTimes.length >= 2) {
        const timeSpan = elapsedTimes[elapsedTimes.length - 1] - elapsedTimes[0];
        const sampleRate = timeSpan > 0 ? ((elapsedTimes.length - 1) / timeSpan).toFixed(2) : 0;
        document.getElementById('statsSampleRate').textContent = `${sampleRate} Hz`;
        document.getElementById('statsTimeSpan').textContent = `${timeSpan.toFixed(1)} s`;
      } else {
        document.getElementById('statsSampleRate').textContent = '-- Hz';
        document.getElementById('statsTimeSpan').textContent = '-- s';
      }

      // Update last update time
      lastUpdateTime = new Date();
      document.getElementById('statsLastUpdate').textContent = lastUpdateTime.toLocaleTimeString();
    }

    // ==========================================
    // Multi-Metric Correlation Chart
    // ==========================================

    // Color palette for correlation chart
    const correlationColors = [
      '#00aaff', // cyan
      '#ff6b6b', // red
      '#4ecdc4', // teal
      '#ffe66d', // yellow
      '#95e1d3', // mint
      '#f38181', // coral
      '#aa96da', // purple
      '#fcbad3', // pink
      '#a8d8ea', // light blue
      '#ff9a8b', // peach
      '#88d8b0', // green
    ];

    // Correlation state
    let correlationChart = null;
    let leftAxisSelections = [];
    let rightAxisSelections = [];

    // Initialize correlation dropdowns
    function initCorrelationDropdowns() {
      const leftDropdown = document.getElementById('leftAxisDropdown');
      const rightDropdown = document.getElementById('rightAxisDropdown');

      const metricList = Object.keys(fields);

      // Populate left dropdown
      leftDropdown.innerHTML = metricList.map((metric, idx) => `
        <div class="multi-select-option" data-metric="${metric}" onclick="toggleMetricSelection('left', '${metric}')">
          <div class="multi-select-checkbox"></div>
          <span class="multi-select-option-label">${metric}</span>
          <div class="multi-select-option-color" style="background: ${correlationColors[idx % correlationColors.length]}"></div>
        </div>
      `).join('');

      // Populate right dropdown
      rightDropdown.innerHTML = metricList.map((metric, idx) => `
        <div class="multi-select-option" data-metric="${metric}" onclick="toggleMetricSelection('right', '${metric}')">
          <div class="multi-select-checkbox"></div>
          <span class="multi-select-option-label">${metric}</span>
          <div class="multi-select-option-color" style="background: ${correlationColors[idx % correlationColors.length]}"></div>
        </div>
      `).join('');
    }

    // Toggle multi-select dropdown
    function toggleMultiSelect(side) {
      const container = document.getElementById(`${side}AxisContainer`);
      const otherSide = side === 'left' ? 'right' : 'left';
      const otherContainer = document.getElementById(`${otherSide}AxisContainer`);

      // Close the other dropdown
      otherContainer.classList.remove('open');

      // Toggle this dropdown
      container.classList.toggle('open');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.multi-select-container')) {
        document.querySelectorAll('.multi-select-container').forEach(c => c.classList.remove('open'));
      }
    });

    // Toggle metric selection
    function toggleMetricSelection(side, metric) {
      const selections = side === 'left' ? leftAxisSelections : rightAxisSelections;
      const otherSelections = side === 'left' ? rightAxisSelections : leftAxisSelections;

      // Remove from other side if selected there
      const otherIdx = otherSelections.indexOf(metric);
      if (otherIdx > -1) {
        otherSelections.splice(otherIdx, 1);
        updateDropdownUI(side === 'left' ? 'right' : 'left');
      }

      // Toggle in current side
      const idx = selections.indexOf(metric);
      if (idx > -1) {
        selections.splice(idx, 1);
      } else {
        selections.push(metric);
      }

      updateDropdownUI(side);
      updateSelectionCount(side);
    }

    // Update dropdown UI to reflect selections
    function updateDropdownUI(side) {
      const dropdown = document.getElementById(`${side}AxisDropdown`);
      const selections = side === 'left' ? leftAxisSelections : rightAxisSelections;

      dropdown.querySelectorAll('.multi-select-option').forEach(option => {
        const metric = option.dataset.metric;
        if (selections.includes(metric)) {
          option.classList.add('selected');
        } else {
          option.classList.remove('selected');
        }
      });
    }

    // Update selection count display
    function updateSelectionCount(side) {
      const countSpan = document.getElementById(`${side}SelectedCount`);
      const selections = side === 'left' ? leftAxisSelections : rightAxisSelections;

      if (selections.length === 0) {
        countSpan.textContent = 'Select metrics...';
      } else if (selections.length === 1) {
        countSpan.textContent = selections[0];
      } else {
        countSpan.textContent = `${selections.length} metrics selected`;
      }
    }

    // Clear all selections
    function clearCorrelationSelections() {
      leftAxisSelections = [];
      rightAxisSelections = [];
      updateDropdownUI('left');
      updateDropdownUI('right');
      updateSelectionCount('left');
      updateSelectionCount('right');

      // Clear chart
      if (correlationChart) {
        correlationChart.data.datasets = [];
        correlationChart.update();
      }

      // Clear legend
      document.getElementById('correlationLegend').innerHTML = '';
    }

    // Create or update correlation chart
    function updateCorrelationChart() {
      const filteredHistory = filterDataByTimeRange(fullHistory, currentTimeFilter);
      const elapsed = filteredHistory["Elapsed [s]"] || [];

      if (elapsed.length === 0) {
        alert('No data available. Please generate some test data first.');
        return;
      }

      if (leftAxisSelections.length === 0 && rightAxisSelections.length === 0) {
        alert('Please select at least one metric for either axis.');
        return;
      }

      const datasets = [];
      const legendItems = [];

      // Get theme colors
      const computedStyle = getComputedStyle(document.documentElement);

      // Add left axis datasets (solid lines)
      leftAxisSelections.forEach((metric, idx) => {
        const colorIdx = Object.keys(fields).indexOf(metric);
        const color = correlationColors[colorIdx % correlationColors.length];
        const values = filteredHistory[metric] || [];

        datasets.push({
          label: metric,
          data: values,
          borderColor: color,
          backgroundColor: color + '20',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          tension: 0.3,
          yAxisID: 'yLeft',
          borderDash: [], // Solid line
        });

        legendItems.push({
          metric,
          color,
          axis: 'left',
          dashed: false
        });
      });

      // Add right axis datasets (dashed lines)
      rightAxisSelections.forEach((metric, idx) => {
        const colorIdx = Object.keys(fields).indexOf(metric);
        const color = correlationColors[colorIdx % correlationColors.length];
        const values = filteredHistory[metric] || [];

        datasets.push({
          label: metric + ' (R)',
          data: values,
          borderColor: color,
          backgroundColor: color + '20',
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 5,
          tension: 0.3,
          yAxisID: 'yRight',
          borderDash: [8, 4], // Dashed line
        });

        legendItems.push({
          metric,
          color,
          axis: 'right',
          dashed: true
        });
      });

      // Determine Y-axis titles
      const leftTitle = leftAxisSelections.length === 1 ? leftAxisSelections[0] : 'Left Axis';
      const rightTitle = rightAxisSelections.length === 1 ? rightAxisSelections[0] : 'Right Axis';

      // Create or update chart
      if (correlationChart) {
        correlationChart.data.labels = elapsed;
        correlationChart.data.datasets = datasets;
        correlationChart.options.scales.yLeft.display = leftAxisSelections.length > 0;
        correlationChart.options.scales.yRight.display = rightAxisSelections.length > 0;
        correlationChart.options.scales.yLeft.title.text = leftTitle;
        correlationChart.options.scales.yRight.title.text = rightTitle;
        correlationChart.update();
      } else {
        const ctx = document.getElementById('correlationChart').getContext('2d');
        correlationChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: elapsed,
            datasets: datasets
          },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                type: 'linear',
                title: {
                  display: true,
                  text: 'Elapsed [s]',
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
              },
              yLeft: {
                type: 'linear',
                position: 'left',
                display: leftAxisSelections.length > 0,
                title: {
                  display: true,
                  text: leftTitle,
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
              },
              yRight: {
                type: 'linear',
                position: 'right',
                display: rightAxisSelections.length > 0,
                title: {
                  display: true,
                  text: rightTitle,
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: {
                  drawOnChartArea: false,
                  color: computedStyle.getPropertyValue('--color-border').trim()
                }
              }
            },
            plugins: {
              legend: {
                display: false // Use custom legend
              },
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: computedStyle.getPropertyValue('--color-primary').trim(),
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                displayColors: true,
                callbacks: {
                  title: function(context) {
                    return `Time: ${parseFloat(context[0].label).toFixed(2)}s`;
                  },
                  label: function(context) {
                    return ` ${context.dataset.label}: ${parseFloat(context.raw).toFixed(3)}`;
                  }
                }
              },
              zoom: {
                pan: {
                  enabled: true,
                  mode: 'x',
                  modifierKey: 'ctrl',
                },
                zoom: {
                  wheel: { enabled: false },
                  pinch: { enabled: true },
                  drag: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 170, 255, 0.15)',
                    borderColor: 'rgba(0, 170, 255, 0.8)',
                    borderWidth: 1,
                  },
                  mode: 'x',
                }
              }
            }
          }
        });
      }

      // Update custom legend
      updateCorrelationLegend(legendItems);
    }

    // Update custom legend
    function updateCorrelationLegend(items) {
      const legendContainer = document.getElementById('correlationLegend');

      if (items.length === 0) {
        legendContainer.innerHTML = '<span style="color: var(--color-text-muted); font-size: 0.85em;">Select metrics and click "Update Chart" to view correlation</span>';
        return;
      }

      legendContainer.innerHTML = items.map(item => `
        <div class="legend-item">
          <div class="legend-line ${item.dashed ? 'dashed' : ''}" style="background: ${item.dashed ? 'none' : item.color}; color: ${item.color};"></div>
          <span>${item.metric}</span>
          <span class="legend-axis-label">${item.axis === 'left' ? 'L' : 'R'}</span>
        </div>
      `).join('');
    }

    // Correlation chart zoom controls
    function resetCorrelationZoom() {
      if (correlationChart && correlationChart.resetZoom) {
        correlationChart.resetZoom();
      }
    }

    function zoomCorrelationChart(direction) {
      if (!correlationChart) return;
      const zoomFactor = direction === 'in' ? 1.2 : 0.8;
      correlationChart.zoom(zoomFactor);
    }

    function panCorrelationChart(direction) {
      if (!correlationChart) return;
      const panAmount = 50;
      let deltaX = 0;
      if (direction === 'left') deltaX = panAmount;
      else if (direction === 'right') deltaX = -panAmount;
      correlationChart.pan({x: deltaX, y: 0}, undefined, 'default');
    }

    // ==========================================
    // Chart Export Functions
    // ==========================================

    // Get list of charts to export based on selections
    function getChartsToExport() {
      const charts = [];
      const exportBME280 = document.getElementById('exportBME280').checked;
      const exportMPU6050 = document.getElementById('exportMPU6050').checked;
      const exportCorrelation = document.getElementById('exportCorrelation').checked;

      // BME280 charts
      if (exportBME280) {
        const bmeCharts = ['Temp_BME280 [°C]', 'Hum [%]', 'Press [hPa]', 'Alt [m]'];
        bmeCharts.forEach(id => {
          if (chartRefs[id]) {
            charts.push({ id, name: id.replace(/[\[\]°\/]/g, '').replace(/\s+/g, '_'), chart: chartRefs[id] });
          }
        });
      }

      // MPU6050 charts
      if (exportMPU6050) {
        const mpuCharts = ['Acc x [m/s²]', 'Acc y [m/s²]', 'Acc z [m/s²]', 'Gyro x [°/s]', 'Gyro y [°/s]', 'Gyro z [°/s]', 'Temp_MPU [°C]'];
        mpuCharts.forEach(id => {
          if (chartRefs[id]) {
            charts.push({ id, name: id.replace(/[\[\]°\/²]/g, '').replace(/\s+/g, '_'), chart: chartRefs[id] });
          }
        });
      }

      // Correlation chart
      if (exportCorrelation && correlationChart) {
        charts.push({ id: 'correlationChart', name: 'Correlation_Chart', chart: correlationChart });
      }

      return charts;
    }

    // Convert chart to image data URL
    function chartToImage(chart, format) {
      const canvas = chart.canvas;
      const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png';
      const quality = format === 'jpeg' ? 0.92 : undefined;

      // Create a temporary canvas with white background for JPEG
      if (format === 'jpeg') {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');

        // Fill with theme background color
        const computedStyle = getComputedStyle(document.documentElement);
        tempCtx.fillStyle = computedStyle.getPropertyValue('--bg-card').trim() || '#1f3545';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

        // Draw chart on top
        tempCtx.drawImage(canvas, 0, 0);
        return tempCanvas.toDataURL(mimeType, quality);
      }

      return canvas.toDataURL(mimeType, quality);
    }

    // Download single file
    function downloadFile(dataUrl, filename) {
      const link = document.createElement('a');
      link.href = dataUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Convert data URL to blob
    function dataURLtoBlob(dataURL) {
      const parts = dataURL.split(',');
      const mime = parts[0].match(/:(.*?);/)[1];
      const bstr = atob(parts[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }

    // Select/deselect all chart export checkboxes
    function selectAllChartExports(select) {
      document.getElementById('exportBME280').checked = select;
      document.getElementById('exportMPU6050').checked = select;
      document.getElementById('exportCorrelation').checked = select;
    }

    // Update export status message
    function setExportStatus(message, type = '') {
      const statusEl = document.getElementById('chartExportStatus');
      statusEl.textContent = message;
      statusEl.className = 'export-status ' + type;
    }

    // Main export function
    async function exportSelectedCharts() {
      const charts = getChartsToExport();

      if (charts.length === 0) {
        setExportStatus('Please select at least one chart category to export.', 'error');
        return;
      }

      const format = document.getElementById('chartExportFormat').value;
      const mode = document.getElementById('chartExportMode').value;
      const extension = format === 'jpeg' ? 'jpg' : 'png';
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');

      setExportStatus(`Exporting ${charts.length} chart(s)...`, 'progress');

      try {
        if (mode === 'zip') {
          // Export as ZIP
          const zip = new JSZip();
          const imgFolder = zip.folder("charts");

          for (const { name, chart } of charts) {
            const imageData = chartToImage(chart, format);
            // Extract base64 data (remove the data:image/xxx;base64, prefix)
            const base64Data = imageData.split(',')[1];
            imgFolder.file(`${name}.${extension}`, base64Data, { base64: true });
          }

          const zipBlob = await zip.generateAsync({
            type: 'blob',
            compression: 'DEFLATE',
            compressionOptions: { level: 6 }
          });

          // Create download link
          const zipUrl = URL.createObjectURL(zipBlob);
          const link = document.createElement('a');
          link.href = zipUrl;
          link.download = `TRITON_Charts_${timestamp}.zip`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          // Cleanup after a delay
          setTimeout(() => URL.revokeObjectURL(zipUrl), 1000);

          setExportStatus(`Successfully exported ${charts.length} chart(s) as ZIP!`, 'success');
        } else {
          // Export individual files
          let exported = 0;
          for (const { name, chart } of charts) {
            const imageData = chartToImage(chart, format);
            downloadFile(imageData, `TRITON_${name}_${timestamp}.${extension}`);
            exported++;

            // Small delay between downloads to prevent browser blocking
            if (exported < charts.length) {
              await new Promise(resolve => setTimeout(resolve, 200));
            }
          }

          setExportStatus(`Successfully exported ${charts.length} chart(s)!`, 'success');
        }
      } catch (error) {
        console.error('Export error:', error);
        setExportStatus(`Export failed: ${error.message}`, 'error');
      }

      // Clear status after 5 seconds
      setTimeout(() => setExportStatus(''), 5000);
    }

    // ==========================================
    // Mission Comparison Functions
    // ==========================================

    let comparisonChart = null;
    let mission1Data = null;
    let mission2Data = null;
    let missionList = [];

    // Load mission list from server
    async function refreshMissionList() {
      const status = document.getElementById('comparisonStatus');
      status.textContent = 'Loading mission list...';
      status.className = 'comparison-status loading';

      try {
        const response = await fetch('/api/missions/list');
        if (!response.ok) throw new Error('Failed to fetch mission list');

        missionList = await response.json();

        // Populate both dropdowns
        const select1 = document.getElementById('mission1Select');
        const select2 = document.getElementById('mission2Select');

        // Clear existing options (except first)
        select1.innerHTML = '<option value="">Select a mission...</option>';
        select2.innerHTML = '<option value="">Select a mission...</option>';

        missionList.forEach(mission => {
          const optionText = `${mission.filename} (${mission.modified})`;
          const optionValue = `${mission.path}/${mission.filename}`;

          select1.innerHTML += `<option value="${optionValue}">${optionText}</option>`;
          select2.innerHTML += `<option value="${optionValue}">${optionText}</option>`;
        });

        status.textContent = `Found ${missionList.length} mission(s)`;
        status.className = 'comparison-status success';
        setTimeout(() => { status.textContent = ''; status.className = 'comparison-status'; }, 3000);

      } catch (error) {
        console.error('Error loading missions:', error);
        status.textContent = `Error: ${error.message}`;
        status.className = 'comparison-status error';
      }
    }

    // Load a specific mission
    async function loadMission(missionNum, filepath) {
      const infoEl = document.getElementById(`mission${missionNum}Info`);
      const status = document.getElementById('comparisonStatus');

      console.log('loadMission called - missionNum:', missionNum, 'filepath:', filepath);

      if (!filepath) {
        if (missionNum == 1) mission1Data = null;
        else mission2Data = null;
        infoEl.textContent = '';
        infoEl.className = 'mission-info';
        updateComparisonChart();
        return;
      }

      infoEl.textContent = 'Loading...';
      status.textContent = `Loading mission ${missionNum}...`;
      status.className = 'comparison-status loading';

      try {
        const response = await fetch(`/api/missions/load/${filepath}`);
        if (!response.ok) throw new Error('Failed to load mission');

        const data = await response.json();

        console.log('Mission data loaded - missionNum:', missionNum, 'rowCount:', data.rowCount);

        if (missionNum == 1) mission1Data = data;
        else mission2Data = data;

        console.log('After assignment - mission1Data:', mission1Data ? 'set' : 'null', 'mission2Data:', mission2Data ? 'set' : 'null');

        infoEl.textContent = `${data.rowCount} data points`;
        infoEl.className = 'mission-info loaded';
        status.textContent = `Mission ${missionNum} loaded successfully`;
        status.className = 'comparison-status success';
        setTimeout(() => { status.textContent = ''; status.className = 'comparison-status'; }, 2000);

        updateComparisonChart();

      } catch (error) {
        console.error('Error loading mission:', error);
        infoEl.textContent = 'Error loading';
        infoEl.className = 'mission-info';
        status.textContent = `Error: ${error.message}`;
        status.className = 'comparison-status error';
      }
    }

    // Handle mission selection
    function onMissionSelect(missionNum) {
      const select = document.getElementById(`mission${missionNum}Select`);
      loadMission(missionNum, select.value);
    }

    // Clear comparison
    function clearComparison() {
      mission1Data = null;
      mission2Data = null;

      document.getElementById('mission1Select').value = '';
      document.getElementById('mission2Select').value = '';
      document.getElementById('mission1Info').textContent = '';
      document.getElementById('mission2Info').textContent = '';
      document.getElementById('mission1Info').className = 'mission-info';
      document.getElementById('mission2Info').className = 'mission-info';
      document.getElementById('includeCurrentData').checked = false;

      updateComparisonChart();
      updateComparisonStats();
    }

    // Helper function to find metric data with flexible key matching
    function getMissionMetric(data, metricKey) {
      if (!data) return [];
      // Direct match
      if (data[metricKey]) return data[metricKey];
      // Try to find matching key (handles encoding differences)
      const normalizedKey = metricKey.toLowerCase().replace(/[^a-z0-9]/g, '');
      for (const key of Object.keys(data)) {
        const normalizedDataKey = key.toLowerCase().replace(/[^a-z0-9]/g, '');
        if (normalizedDataKey === normalizedKey) {
          return data[key];
        }
      }
      return [];
    }

    // Update comparison chart
    function updateComparisonChart() {
      const metric = document.getElementById('compareMetricSelect').value;
      const includeCurrent = document.getElementById('includeCurrentData').checked;

      const datasets = [];
      const computedStyle = getComputedStyle(document.documentElement);

      console.log('updateComparisonChart called');
      console.log('metric:', metric);
      console.log('mission1Data:', mission1Data ? mission1Data.filename : 'null');
      console.log('mission2Data:', mission2Data ? mission2Data.filename : 'null');

      // Mission 1 data (blue, solid)
      if (mission1Data && mission1Data.data) {
        const elapsed = getMissionMetric(mission1Data.data, 'Elapsed [s]') || getMissionMetric(mission1Data.data, 'MET [s]') || [];
        const values = getMissionMetric(mission1Data.data, metric);
        console.log('Mission 1 - elapsed length:', elapsed.length, 'values length:', values.length);

        if (elapsed.length > 0 && values.length > 0) {
          datasets.push({
            label: `Mission 1: ${mission1Data.filename}`,
            data: values.map((v, i) => ({ x: elapsed[i], y: v })),
            borderColor: '#3b82f6',
            backgroundColor: '#3b82f620',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 5,
            tension: 0.3,
            borderDash: [],
          });
        }
      }

      // Mission 2 data (orange, dashed)
      if (mission2Data && mission2Data.data) {
        const elapsed = getMissionMetric(mission2Data.data, 'Elapsed [s]') || getMissionMetric(mission2Data.data, 'MET [s]') || [];
        const values = getMissionMetric(mission2Data.data, metric);
        console.log('Mission 2 - elapsed length:', elapsed.length, 'values length:', values.length);

        if (elapsed.length > 0 && values.length > 0) {
          datasets.push({
            label: `Mission 2: ${mission2Data.filename}`,
            data: values.map((v, i) => ({ x: elapsed[i], y: v })),
            borderColor: '#f97316',
            backgroundColor: '#f9731620',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 5,
            tension: 0.3,
            borderDash: [8, 4],
          });
        }
      }

      console.log('Total datasets:', datasets.length);

      // Current live data (green, dotted)
      if (includeCurrent && fullHistory && fullHistory['Elapsed [s]']) {
        const elapsed = fullHistory['Elapsed [s]'] || [];
        const values = fullHistory[metric] || [];

        if (elapsed.length > 0 && values.length > 0) {
          datasets.push({
            label: 'Current (Live)',
            data: values.map((v, i) => ({ x: elapsed[i], y: v })),
            borderColor: '#22c55e',
            backgroundColor: '#22c55e20',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 5,
            tension: 0.3,
            borderDash: [3, 3],
          });
        }
      }

      // Create or update chart
      if (comparisonChart) {
        comparisonChart.data.datasets = datasets;
        comparisonChart.options.scales.y.title.text = metric;
        comparisonChart.update();
      } else {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        comparisonChart = new Chart(ctx, {
          type: 'line',
          data: { datasets },
          options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              x: {
                type: 'linear',
                title: {
                  display: true,
                  text: 'Elapsed [s]',
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
              },
              y: {
                type: 'linear',
                title: {
                  display: true,
                  text: metric,
                  color: computedStyle.getPropertyValue('--color-text-muted').trim()
                },
                ticks: { color: computedStyle.getPropertyValue('--color-text-secondary').trim() },
                grid: { color: computedStyle.getPropertyValue('--color-border').trim() }
              }
            },
            plugins: {
              legend: {
                labels: { color: computedStyle.getPropertyValue('--color-text-primary').trim() }
              },
              tooltip: {
                enabled: true,
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: computedStyle.getPropertyValue('--color-primary').trim(),
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                displayColors: true,
                callbacks: {
                  title: function(context) {
                    return `Time: ${parseFloat(context[0].parsed.x).toFixed(2)}s`;
                  },
                  label: function(context) {
                    return ` ${context.dataset.label}: ${parseFloat(context.parsed.y).toFixed(3)}`;
                  }
                }
              },
              zoom: {
                pan: {
                  enabled: true,
                  mode: 'x',
                  modifierKey: 'ctrl',
                },
                zoom: {
                  wheel: { enabled: false },
                  pinch: { enabled: true },
                  drag: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 170, 255, 0.15)',
                    borderColor: 'rgba(0, 170, 255, 0.8)',
                    borderWidth: 1,
                  },
                  mode: 'x',
                }
              }
            }
          }
        });
      }

      // Update statistics table
      updateComparisonStats();
    }

    // Update comparison statistics table
    function updateComparisonStats() {
      const metric = document.getElementById('compareMetricSelect').value;
      const includeCurrent = document.getElementById('includeCurrentData').checked;
      const tbody = document.getElementById('comparisonStatsBody');

      // Calculate stats for each mission
      const stats1 = mission1Data ? calculateMissionStats(mission1Data.data, metric) : null;
      const stats2 = mission2Data ? calculateMissionStats(mission2Data.data, metric) : null;
      const statsCurrent = (includeCurrent && fullHistory) ? calculateMissionStats(fullHistory, metric) : null;

      if (!stats1 && !stats2 && !statsCurrent) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--color-text-muted);">Select missions to compare</td></tr>';
        return;
      }

      const statNames = ['Min', 'Max', 'Average', 'Median', 'Std Dev', 'Data Points'];
      const statKeys = ['min', 'max', 'avg', 'median', 'stdDev', 'count'];

      let html = '';
      statKeys.forEach((key, i) => {
        const v1 = stats1 ? stats1[key] : '-';
        const v2 = stats2 ? stats2[key] : '-';
        const vCurrent = statsCurrent ? statsCurrent[key] : '-';

        // Calculate difference
        let diff = '-';
        let diffClass = 'neutral';
        if (stats1 && stats2 && key !== 'count') {
          const d = stats1[key] - stats2[key];
          diff = d > 0 ? `+${d.toFixed(3)}` : d.toFixed(3);
          diffClass = d > 0 ? 'positive' : (d < 0 ? 'negative' : 'neutral');
        }

        html += `<tr>
          <td>${statNames[i]}</td>
          <td>${typeof v1 === 'number' ? v1.toFixed(3) : v1}</td>
          <td>${typeof v2 === 'number' ? v2.toFixed(3) : v2}</td>
          <td class="${diffClass}">${diff}</td>
          <td>${typeof vCurrent === 'number' ? vCurrent.toFixed(3) : vCurrent}</td>
        </tr>`;
      });

      tbody.innerHTML = html;
    }

    // Calculate statistics for a mission
    function calculateMissionStats(data, metric) {
      const values = getMissionMetric(data, metric);
      if (!values || values.length === 0) return null;

      const numericValues = values.filter(v => typeof v === 'number' && !isNaN(v));
      if (numericValues.length === 0) return null;

      const n = numericValues.length;
      const sorted = [...numericValues].sort((a, b) => a - b);

      const min = sorted[0];
      const max = sorted[n - 1];
      const sum = numericValues.reduce((a, b) => a + b, 0);
      const avg = sum / n;

      const median = n % 2 === 0
        ? (sorted[n / 2 - 1] + sorted[n / 2]) / 2
        : sorted[Math.floor(n / 2)];

      const variance = numericValues.reduce((acc, v) => acc + Math.pow(v - avg, 2), 0) / n;
      const stdDev = Math.sqrt(variance);

      return { min, max, avg, median, stdDev, count: n };
    }

    // Comparison chart controls
    function resetComparisonZoom() {
      if (comparisonChart && comparisonChart.resetZoom) {
        comparisonChart.resetZoom();
      }
    }

    function zoomComparisonChart(direction) {
      if (!comparisonChart) return;
      const zoomFactor = direction === 'in' ? 1.2 : 0.8;
      comparisonChart.zoom(zoomFactor);
    }

    function panComparisonChart(direction) {
      if (!comparisonChart) return;
      const panAmount = 50;
      let deltaX = 0;
      if (direction === 'left') deltaX = panAmount;
      else if (direction === 'right') deltaX = -panAmount;
      comparisonChart.pan({x: deltaX, y: 0}, undefined, 'default');
    }

    // Time Range Filter Functions
    function filterDataByTimeRange(history, filter) {
      const elapsed = history["Elapsed [s]"] || [];
      if (!elapsed.length) return history;

      let startIdx = 0;
      let endIdx = elapsed.length - 1;

      if (filter.type === 'all') {
        // Return all data
        return history;
      } else if (filter.type === 'preset') {
        // Filter to last N seconds
        const maxTime = elapsed[elapsed.length - 1];
        const minTime = maxTime - filter.value;
        startIdx = elapsed.findIndex(t => t >= minTime);
        if (startIdx === -1) startIdx = 0;
      } else if (filter.type === 'custom') {
        // Filter to custom range
        const { from, to } = filter.value;
        startIdx = elapsed.findIndex(t => t >= from);
        if (startIdx === -1) startIdx = 0;
        endIdx = elapsed.findIndex(t => t > to);
        if (endIdx === -1) endIdx = elapsed.length;
        else endIdx = endIdx - 1;
      }

      // Create filtered history
      const filteredHistory = {};
      for (const key in history) {
        if (Array.isArray(history[key])) {
          filteredHistory[key] = history[key].slice(startIdx, endIdx + 1);
        } else {
          filteredHistory[key] = history[key];
        }
      }

      return filteredHistory;
    }

    function setTimeFilter(preset) {
      // Update active button
      document.querySelectorAll('.time-preset-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.preset === String(preset)) {
          btn.classList.add('active');
        }
      });

      // Update custom range container
      const customContainer = document.getElementById('customRangeContainer');
      customContainer.classList.remove('active');

      // Clear custom inputs
      document.getElementById('customFromTime').value = '';
      document.getElementById('customToTime').value = '';

      // Set filter
      if (preset === 'all') {
        currentTimeFilter = { type: 'all', value: null };
        updateTimeRangeDisplay('All');
      } else {
        currentTimeFilter = { type: 'preset', value: preset };
        updateTimeRangeDisplay(`Last ${formatDuration(preset)}`);
      }

      // Refresh display with new filter
      updateFilteredDisplay();
    }

    function applyCustomRange() {
      const fromInput = document.getElementById('customFromTime');
      const toInput = document.getElementById('customToTime');

      const from = parseFloat(fromInput.value);
      const to = parseFloat(toInput.value);

      // Validation
      if (isNaN(from) && isNaN(to)) {
        // If both empty, show all
        setTimeFilter('all');
        return;
      }

      const elapsed = fullHistory["Elapsed [s]"] || [];
      const maxTime = elapsed.length ? elapsed[elapsed.length - 1] : 0;
      const minTime = elapsed.length ? elapsed[0] : 0;

      // Default values if only one is provided
      const validFrom = isNaN(from) ? minTime : Math.max(from, minTime);
      const validTo = isNaN(to) ? maxTime : Math.min(to, maxTime);

      if (validFrom > validTo) {
        alert('Invalid range: "From" must be less than "To"');
        return;
      }

      // Update UI
      document.querySelectorAll('.time-preset-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('customRangeContainer').classList.add('active');

      // Set filter
      currentTimeFilter = {
        type: 'custom',
        value: { from: validFrom, to: validTo }
      };

      updateTimeRangeDisplay(`${validFrom.toFixed(1)}s - ${validTo.toFixed(1)}s`);
      updateFilteredDisplay();
    }

    function formatDuration(seconds) {
      if (seconds < 60) return `${seconds}s`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}min`;
      return `${Math.floor(seconds / 3600)}h`;
    }

    function updateTimeRangeDisplay(text) {
      document.getElementById('currentTimeRange').textContent = text;
    }

    function updateFilterInfo(totalPoints, filteredPoints) {
      document.getElementById('totalPointsCount').textContent = totalPoints;
      document.getElementById('filteredPointsCount').textContent = filteredPoints;
    }

    function updateFilteredDisplay() {
      // Apply filter to full history
      const filteredHistory = filterDataByTimeRange(fullHistory, currentTimeFilter);
      const elapsed = filteredHistory["Elapsed [s]"] || [];
      const bmeRows = [], mpuRows = [];

      // Update charts and statistics with filtered data
      for (const [id, group] of Object.entries(fields)) {
        const values = filteredHistory[id] || [];
        if (chartRefs[id]) {
          chartRefs[id].data.labels = elapsed;
          chartRefs[id].data.datasets[0].data = values;
          chartRefs[id].update('none');
        }

        // Use extended statistics
        const stats = computeExtendedStats(values, elapsed);
        const row = `<tr>
          <td>${id}</td>
          <td>${stats.min}</td>
          <td>${stats.max}</td>
          <td>${stats.avg}</td>
          <td>${stats.median}</td>
          <td>${stats.stdDev}</td>
          <td>${stats.p25}</td>
          <td>${stats.p75}</td>
          <td>${stats.p95}</td>
          <td>${formatRateWithColor(stats.ratePerSec)}</td>
        </tr>`;
        (group === "bme" ? bmeRows : mpuRows).push(row);
      }

      document.getElementById("bmeSummary").innerHTML = bmeRows.join("");
      document.getElementById("mpuSummary").innerHTML = mpuRows.join("");

      // Update filter info
      const totalPoints = (fullHistory["Elapsed [s]"] || []).length;
      const filteredPoints = elapsed.length;
      updateFilterInfo(totalPoints, filteredPoints);

      // Update stats meta information
      updateStatsMeta(totalPoints, filteredPoints, elapsed);
    }

    // Export Filter Functions (separate from display filter)
    function setExportFilter(preset) {
      // Update active button (only export preset buttons)
      document.querySelectorAll('[data-export-preset]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.exportPreset === String(preset)) {
          btn.classList.add('active');
        }
      });

      // Update custom range container
      const customContainer = document.getElementById('exportCustomRangeContainer');
      customContainer.classList.remove('active');

      // Clear custom inputs
      document.getElementById('exportFromTime').value = '';
      document.getElementById('exportToTime').value = '';

      // Set filter
      if (preset === 'all') {
        exportTimeFilter = { type: 'all', value: null };
        updateExportRangeDisplay('All');
      } else {
        exportTimeFilter = { type: 'preset', value: preset };
        updateExportRangeDisplay(`Last ${formatDuration(preset)}`);
      }

      // Update export info
      updateExportFilterInfo();
    }

    function applyExportCustomRange() {
      const fromInput = document.getElementById('exportFromTime');
      const toInput = document.getElementById('exportToTime');

      const from = parseFloat(fromInput.value);
      const to = parseFloat(toInput.value);

      // Validation
      if (isNaN(from) && isNaN(to)) {
        setExportFilter('all');
        return;
      }

      const elapsed = fullHistory["Elapsed [s]"] || [];
      const maxTime = elapsed.length ? elapsed[elapsed.length - 1] : 0;
      const minTime = elapsed.length ? elapsed[0] : 0;

      const validFrom = isNaN(from) ? minTime : Math.max(from, minTime);
      const validTo = isNaN(to) ? maxTime : Math.min(to, maxTime);

      if (validFrom > validTo) {
        alert('Invalid range: "From" must be less than "To"');
        return;
      }

      // Update UI
      document.querySelectorAll('[data-export-preset]').forEach(btn => btn.classList.remove('active'));
      document.getElementById('exportCustomRangeContainer').classList.add('active');

      // Set filter
      exportTimeFilter = {
        type: 'custom',
        value: { from: validFrom, to: validTo }
      };

      updateExportRangeDisplay(`${validFrom.toFixed(1)}s - ${validTo.toFixed(1)}s`);
      updateExportFilterInfo();
    }

    function updateExportRangeDisplay(text) {
      document.getElementById('exportTimeRange').textContent = text;
    }

    function updateExportFilterInfo() {
      const filteredHistory = filterDataByTimeRange(fullHistory, exportTimeFilter);
      const exportPoints = (filteredHistory["Elapsed [s]"] || []).length;
      document.getElementById('exportPointsCount').textContent = exportPoints;

      // Disable export button if no data
      const exportBtn = document.getElementById('exportFilteredBtn');
      exportBtn.disabled = exportPoints === 0;
    }

    function exportFilteredData() {
      const filteredHistory = filterDataByTimeRange(fullHistory, exportTimeFilter);
      const elapsed = filteredHistory["Elapsed [s]"] || [];

      if (elapsed.length === 0) {
        alert('No data to export');
        return;
      }

      // Build CSV content
      const headers = ["Elapsed [s]", ...Object.keys(fields)];
      let csv = headers.join(",") + "\n";

      for (let i = 0; i < elapsed.length; i++) {
        const row = [elapsed[i].toFixed(3)];
        for (const field of Object.keys(fields)) {
          const values = filteredHistory[field] || [];
          row.push(values[i] !== undefined ? values[i].toFixed(3) : '');
        }
        csv += row.join(",") + "\n";
      }

      // Create download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;

      // Generate filename with filter info
      let filename = 'triton_filtered_';
      if (exportTimeFilter.type === 'all') {
        filename += 'all';
      } else if (exportTimeFilter.type === 'preset') {
        filename += `last_${exportTimeFilter.value}s`;
      } else {
        filename += `${exportTimeFilter.value.from.toFixed(0)}-${exportTimeFilter.value.to.toFixed(0)}s`;
      }
      filename += `_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.csv`;

      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function fetchData() {
      const res = await fetch("/data");
      const json = await res.json();

      // Store full history
      fullHistory = json.history;

      // Initialize charts if not already created
      for (const [id, group] of Object.entries(fields)) {
        if (!chartRefs[id]) {
          chartRefs[id] = createChart(id, id);
        }
      }

      // Apply time filter and update display
      updateFilteredDisplay();

      // Update export filter info as well
      updateExportFilterInfo();
    }

    async function loadArchivedLogs() {
      const res = await fetch("/download/list");
      const logs = await res.json();
      const select = document.getElementById("logSelect");
      logs.forEach(filename => {
        const opt = document.createElement("option");
        opt.value = filename;
        opt.textContent = filename;
        select.appendChild(opt);
      });
    }

    function downloadLatest() {
      window.location.href = "/download/latest";
    }

    function downloadSelected() {
      const file = document.getElementById("logSelect").value;
      if (file) window.location.href = `/download/archive/${encodeURIComponent(file)}`;
    }

    async function openLogsFolder() {
      const folderStatus = document.getElementById("folderStatus");
      
      try {
        folderStatus.textContent = "Opening logs folder...";
        folderStatus.style.color = "#fbbf24";
        
        const response = await fetch("/open_logs_folder", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
          folderStatus.textContent = "Logs folder opened successfully!";
          folderStatus.style.color = "#22c55e";
        } else {
          throw new Error(result.message || "Unknown error");
        }
      } catch (error) {
        folderStatus.textContent = `Error opening folder: ${error.message}`;
        folderStatus.style.color = "#ef4444";
        console.error("Error opening logs folder:", error);
      }
      
      // Clear status message after 3 seconds
      setTimeout(() => {
        folderStatus.textContent = "";
      }, 3000);
    }

    let dataGenerationInterval = null;
    let isGenerating = false;
    let currentSpeed = 10; // Default 10x speed
    const baseInterval = 2000; // Base interval in milliseconds (2 seconds)

    async function generateSingleDataPoint() {
      try {
        const response = await fetch("/generate_random_data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        const result = await response.json();
        if (result.status !== "success") {
          throw new Error(result.message || "Unknown error");
        }
      } catch (error) {
        console.error("Error generating random data:", error);
        // Stop generation on error
        stopDataGeneration();
      }
    }

    function startDataGeneration() {
      if (isGenerating) return;
      
      isGenerating = true;
      const startStopBtn = document.getElementById("startStopBtn");
      const statusSpan = document.getElementById("generateStatus");
      const currentInterval = Math.round(baseInterval / currentSpeed);
      
      startStopBtn.textContent = "⏸️ Stop Test Data";
      startStopBtn.style.backgroundColor = "#ef4444";
      statusSpan.textContent = `🟢 Generating test data at ${currentSpeed}x speed (${currentInterval}ms intervals)`;
      statusSpan.style.color = "#22c55e";
      
      // Generate data at variable speed based on currentSpeed
      dataGenerationInterval = setInterval(generateSingleDataPoint, currentInterval);
      
      // Generate first data point immediately
      generateSingleDataPoint();
    }

    function stopDataGeneration() {
      if (!isGenerating) return;
      
      isGenerating = false;
      const startStopBtn = document.getElementById("startStopBtn");
      const statusSpan = document.getElementById("generateStatus");
      
      if (dataGenerationInterval) {
        clearInterval(dataGenerationInterval);
        dataGenerationInterval = null;
      }
      
      startStopBtn.textContent = "Start Test Data";
      startStopBtn.style.backgroundColor = "#38bdf8";
      statusSpan.textContent = "⏸️ Test data generation stopped";
      statusSpan.style.color = "#fbbf24";
      
      // Clear status message after 3 seconds
      setTimeout(() => {
        if (!isGenerating) statusSpan.textContent = "";
      }, 3000);
    }

    function toggleDataGeneration() {
      if (isGenerating) {
        stopDataGeneration();
      } else {
        startDataGeneration();
      }
    }

    function updateSpeed() {
      const speedSelect = document.getElementById("speedSelect");
      currentSpeed = parseFloat(speedSelect.value);
      
      // If data generation is running, restart with new speed
      if (isGenerating) {
        stopDataGeneration();
        startDataGeneration();
      }
    }

    async function clearTestData() {
      const clearBtn = document.getElementById("clearBtn");
      const statusSpan = document.getElementById("generateStatus");
      
      // Stop data generation first
      if (isGenerating) {
        stopDataGeneration();
      }
      
      clearBtn.disabled = true;
      clearBtn.textContent = "Clearing...";
      
      try {
        const response = await fetch("/clear_test_data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
          statusSpan.textContent = "All test data cleared!";
          statusSpan.style.color = "#22c55e";
          // Clear status message after 3 seconds
          setTimeout(() => {
            statusSpan.textContent = "";
          }, 3000);
        } else {
          throw new Error(result.message || "Unknown error");
        }
      } catch (error) {
        statusSpan.textContent = "Error clearing data";
        statusSpan.style.color = "#ef4444";
        console.error("Error clearing test data:", error);
      } finally {
        clearBtn.disabled = false;
        clearBtn.textContent = "Clear Data";
      }
    }

    // Theme Management System
    class ThemeManager {
      constructor() {
        this.currentTheme = localStorage.getItem('triton-theme') || 'dark-ocean';
        this.dropdown = null;
        this.dropdownBtn = null;
        this.currentSpan = null;
        this.init();
      }
      
      init() {
        this.dropdown = document.querySelector('.theme-dropdown');
        this.dropdownBtn = document.querySelector('.theme-dropdown-btn');
        this.currentSpan = document.querySelector('.theme-current');
        
        this.applyTheme(this.currentTheme);
        this.setupEventListeners();
        this.updateActiveButton();
        this.updateChartColors();
      }
      
      applyTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        this.currentTheme = themeName;
        localStorage.setItem('triton-theme', themeName);
        
        // Update dropdown button text
        if (this.currentSpan) {
          const themeNames = {
            'dark-ocean': 'Dark Ocean',
            'night': 'Night',
            'light-ocean': 'Light Ocean'
          };
          this.currentSpan.textContent = themeNames[themeName] || themeName;
        }
        
        // Update chart colors when theme changes
        setTimeout(() => this.updateChartColors(), 100);
      }
      
      updateChartColors() {
        // Get current theme colors
        const computedStyle = getComputedStyle(document.documentElement);
        const primaryColor = computedStyle.getPropertyValue('--color-primary').trim();
        const accentColor = computedStyle.getPropertyValue('--color-accent').trim();
        
        // Update all existing charts
        Object.values(chartRefs).forEach(chart => {
          if (chart && chart.data && chart.data.datasets && chart.data.datasets[0]) {
            chart.data.datasets[0].borderColor = primaryColor;
            chart.data.datasets[0].backgroundColor = primaryColor + '20';
            chart.update('none');
          }
        });
      }
      
      setupEventListeners() {
        // Dropdown toggle
        if (this.dropdownBtn) {
          this.dropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.dropdown.classList.toggle('open');
          });
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          if (this.dropdown) {
            this.dropdown.classList.remove('open');
          }
        });
        
        // Theme option clicks
        const themeOptions = document.querySelectorAll('.theme-button');
        themeOptions.forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const theme = option.getAttribute('data-theme');
            this.applyTheme(theme);
            this.updateActiveButton();
            this.dropdown.classList.remove('open');
            
            // Add visual feedback
            option.style.transform = 'scale(0.95)';
            setTimeout(() => {
              option.style.transform = '';
            }, 150);
          });
        });
      }
      
      updateActiveButton() {
        const themeOptions = document.querySelectorAll('.theme-button');
        themeOptions.forEach(option => {
          option.classList.remove('active');
          if (option.getAttribute('data-theme') === this.currentTheme) {
            option.classList.add('active');
          }
        });
      }
    }

    // Sticky Navigation Handler
    class StickyNavHandler {
      constructor() {
        this.headerNav = document.querySelector('.header-nav');
        this.init();
      }
      
      init() {
        if (this.headerNav) {
          window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
              this.headerNav.classList.add('scrolled');
            } else {
              this.headerNav.classList.remove('scrolled');
            }
          });
        }
      }
    }

    window.onload = () => {
      // Initialize theme management
      new ThemeManager();
      // Initialize sticky navigation
      new StickyNavHandler();
      // Initialize correlation dropdowns
      initCorrelationDropdowns();
      // Initialize mission comparison
      refreshMissionList();
      loadArchivedLogs();
      setInterval(fetchData, 1000);
      
      // Smooth scrolling for anchor links with offset for fixed header
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            const headerHeight = 70; // Account for fixed header
            const targetPosition = target.offsetTop - headerHeight;
            
            window.scrollTo({
              top: targetPosition,
              behavior: 'smooth'
            });
          }
        });
      });
    };
  </script>
</body>
</html>