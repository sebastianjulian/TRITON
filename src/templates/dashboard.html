<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mission Control TRITON</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0f1115;
      color: #f0f0f0;
      font-family: "Segoe UI", sans-serif;
    }

    header {
      background-color: #1e1f26;
      padding: 20px;
      text-align: center;
      border-bottom: 2px solid #2d2f36;
    }

    header h1 {
      margin: 0;
      font-size: 1.8em;
      color: #ffffff;
    }

    section {
      padding: 20px 40px;
    }

    h2 {
      color: #e2e2e2;
      margin-top: 40px;
      font-size: 1.4em;
      border-left: 4px solid #0061a8;
      padding-left: 12px;
    }

    .grid-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 20px;
    }

    .chart-box {
      background-color: #1c1d22;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 0 10px #00000044;
      display: flex;
      flex-direction: column;
    }

    .chart-box h3 {
      margin: 0 0 10px;
      text-align: center;
      font-size: 1.1em;
      color: #ddd;
    }

    canvas {
      width: 100% !important;
      aspect-ratio: 1.6;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #333;
      padding: 8px 12px;
      text-align: center;
      color: #ccc;
    }

    th {
      background-color: #222;
      color: #fff;
    }

    .download-controls {
      margin-top: 40px;
    }

    .download-controls button,
    .download-controls select {
      margin: 10px 10px 0 0;
      padding: 8px 12px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
    }

    .download-controls button {
      background-color: #38bdf8;
      color: #000;
      cursor: pointer;
    }

    .download-controls select {
      background-color: #1c1d22;
      color: #f0f0f0;
    }

    .back-btn {
      background-color: #38bdf8;
      color: #000;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background-color: #0ea5e9;
      transform: translateY(-1px);
      box-shadow: 0 2px 10px rgba(56, 189, 248, 0.3);
    }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
      <a href="/" class="back-btn">‚Üê Back to Homepage</a>
      <h1 style="margin: 0;">Mission Control TRITON</h1>
      <div style="width: 140px;"></div> <!-- Spacer for centering -->
    </div>
  </header>

  <!-- Mission Control Section -->
  <section class="download-controls">
    <h2>Mission Control</h2>
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <button id="startStopBtn" onclick="toggleDataGeneration()">‚ñ∂Ô∏è Start Test Data</button>
      <select id="speedSelect" onchange="updateSpeed()" style="background-color: #1c1d22; color: #f0f0f0; border: 1px solid #333; padding: 8px 12px; border-radius: 6px;">
        <option value="0.5">0.5x Speed (4s)</option>
        <option value="1" selected>1x Speed (2s)</option>
        <option value="2">2x Speed (1s)</option>
        <option value="5">5x Speed (0.4s)</option>
        <option value="10">10x Speed (0.2s)</option>
      </select>
      <button id="clearBtn" onclick="clearTestData()" style="background-color: #ef4444;">üóëÔ∏è Clear Data</button>
    </div>
    <div style="margin-top: 10px;">
      <span id="generateStatus" style="color: #38bdf8;"></span>
    </div>
  </section>

  <!-- BME280 Section -->
  <section>
    <h2>BME280 Sensor</h2>
    <div class="grid-2col">
      <div class="chart-box"><h3>Temperature [¬∞C]</h3><canvas id="Temp_BME280 [¬∞C]"></canvas></div>
      <div class="chart-box"><h3>Humidity [%]</h3><canvas id="Hum [%]"></canvas></div>
      <div class="chart-box"><h3>Pressure [hPa]</h3><canvas id="Press [hPa]"></canvas></div>
      <div class="chart-box"><h3>Altitude [m]</h3><canvas id="Alt [m]"></canvas></div>
    </div>
  </section>

  <!-- MPU6050 Section -->
  <section>
    <h2>MPU6050 Sensor</h2>
    <div class="grid-2col">
      <div class="chart-box"><h3>Acc X [m/s¬≤]</h3><canvas id="Acc x [m/s¬≤]"></canvas></div>
      <div class="chart-box"><h3>Gyro X [¬∞/s]</h3><canvas id="Gyro x [¬∞/s]"></canvas></div>
      <div class="chart-box"><h3>Acc Y [m/s¬≤]</h3><canvas id="Acc y [m/s¬≤]"></canvas></div>
      <div class="chart-box"><h3>Gyro Y [¬∞/s]</h3><canvas id="Gyro y [¬∞/s]"></canvas></div>
      <div class="chart-box"><h3>Acc Z [m/s¬≤]</h3><canvas id="Acc z [m/s¬≤]"></canvas></div>
      <div class="chart-box"><h3>Gyro Z [¬∞/s]</h3><canvas id="Gyro z [¬∞/s]"></canvas></div>
      <div class="chart-box"><h3>Temperature [¬∞C]</h3><canvas id="Temp_MPU [¬∞C]"></canvas></div>
      <div class="chart-box"><h3></h3></div> <!-- Empty to keep 2-column symmetry -->
    </div>
  </section>

  <!-- Statistics Section -->
  <section>
    <h2>Statistics: BME280</h2>
    <table>
      <thead><tr><th>Metric</th><th>Min</th><th>Max</th><th>Avg</th></tr></thead>
      <tbody id="bmeSummary"></tbody>
    </table>

    <h2 style="margin-top: 50px;">Statistics: MPU6050</h2>
    <table>
      <thead><tr><th>Metric</th><th>Min</th><th>Max</th><th>Avg</th></tr></thead>
      <tbody id="mpuSummary"></tbody>
    </table>
  </section>


  <!-- Download Section -->
  <section class="download-controls">
    <h2>Download Logs</h2>
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <button onclick="downloadLatest()">‚¨áÔ∏è Download Latest Log</button>
      <select id="logSelect" onchange="downloadSelected()">
        <option value="">-- Select archived log --</option>
      </select>
      <button onclick="openLogsFolder()" style="background-color: #6366f1;">üìÅ Open Logs Folder</button>
    </div>
    <div style="margin-top: 10px;">
      <span id="folderStatus" style="color: #38bdf8;"></span>
    </div>
  </section>

  <!-- Chart and Data Script -->
  <script>
    const chartRefs = {};
    const fields = {
      "Temp_BME280 [¬∞C]": "bme",
      "Hum [%]": "bme",
      "Press [hPa]": "bme",
      "Alt [m]": "bme",
      "Acc x [m/s¬≤]": "mpu",
      "Acc y [m/s¬≤]": "mpu",
      "Acc z [m/s¬≤]": "mpu",
      "Gyro x [¬∞/s]": "mpu",
      "Gyro y [¬∞/s]": "mpu",
      "Gyro z [¬∞/s]": "mpu",
      "Temp_MPU [¬∞C]": "mpu"
    };

    function createChart(id, label) {
      const ctx = document.getElementById(id).getContext("2d");
      return new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: label,
            data: [],
            borderColor: "#38bdf8",
            backgroundColor: "rgba(56,189,248,0.1)",
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.3
          }]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            x: {
              type: "linear",
              title: { display: true, text: "Elapsed [s]", color: "#aaa" },
              ticks: { color: "#ccc" },
              grid: { color: "#333" }
            },
            y: {
              title: { display: true, text: label, color: "#aaa" },
              ticks: { color: "#ccc" },
              grid: { color: "#333" }
            }
          },
          plugins: {
            legend: { labels: { color: "#eee" } }
          }
        }
      });
    }

    function computeStats(values) {
      if (!values.length) return ["-", "-", "-"];
      let min = values[0], max = values[0], sum = 0;
      for (let v of values) {
        min = Math.min(min, v);
        max = Math.max(max, v);
        sum += v;
      }
      return [min.toFixed(2), max.toFixed(2), (sum / values.length).toFixed(2)];
    }

    async function fetchData() {
      const res = await fetch("/data");
      const json = await res.json();
      const elapsed = json.history["Elapsed [s]"];
      const bmeRows = [], mpuRows = [];

      for (const [id, group] of Object.entries(fields)) {
        const values = json.history[id] || [];
        if (!chartRefs[id]) {
          chartRefs[id] = createChart(id, id);
        }
        chartRefs[id].data.labels = elapsed;
        chartRefs[id].data.datasets[0].data = values;
        chartRefs[id].update();

        const [min, max, avg] = computeStats(values);
        const row = `<tr><td>${id}</td><td>${min}</td><td>${max}</td><td>${avg}</td></tr>`;
        (group === "bme" ? bmeRows : mpuRows).push(row);
      }

      document.getElementById("bmeSummary").innerHTML = bmeRows.join("");
      document.getElementById("mpuSummary").innerHTML = mpuRows.join("");
    }

    async function loadArchivedLogs() {
      const res = await fetch("/download/list");
      const logs = await res.json();
      const select = document.getElementById("logSelect");
      logs.forEach(filename => {
        const opt = document.createElement("option");
        opt.value = filename;
        opt.textContent = filename;
        select.appendChild(opt);
      });
    }

    function downloadLatest() {
      window.location.href = "/download/latest";
    }

    function downloadSelected() {
      const file = document.getElementById("logSelect").value;
      if (file) window.location.href = `/download/archive/${encodeURIComponent(file)}`;
    }

    async function openLogsFolder() {
      const folderStatus = document.getElementById("folderStatus");
      
      try {
        folderStatus.textContent = "üìÅ Opening logs folder...";
        folderStatus.style.color = "#fbbf24";
        
        const response = await fetch("/open_logs_folder", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
          folderStatus.textContent = "‚úÖ Logs folder opened successfully!";
          folderStatus.style.color = "#22c55e";
        } else {
          throw new Error(result.message || "Unknown error");
        }
      } catch (error) {
        folderStatus.textContent = `‚ùå Error opening folder: ${error.message}`;
        folderStatus.style.color = "#ef4444";
        console.error("Error opening logs folder:", error);
      }
      
      // Clear status message after 3 seconds
      setTimeout(() => {
        folderStatus.textContent = "";
      }, 3000);
    }

    let dataGenerationInterval = null;
    let isGenerating = false;
    let currentSpeed = 1; // Default 1x speed
    const baseInterval = 2000; // Base interval in milliseconds (2 seconds)

    async function generateSingleDataPoint() {
      try {
        const response = await fetch("/generate_random_data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        const result = await response.json();
        if (result.status !== "success") {
          throw new Error(result.message || "Unknown error");
        }
      } catch (error) {
        console.error("Error generating random data:", error);
        // Stop generation on error
        stopDataGeneration();
      }
    }

    function startDataGeneration() {
      if (isGenerating) return;
      
      isGenerating = true;
      const startStopBtn = document.getElementById("startStopBtn");
      const statusSpan = document.getElementById("generateStatus");
      const currentInterval = Math.round(baseInterval / currentSpeed);
      
      startStopBtn.textContent = "‚è∏Ô∏è Stop Test Data";
      startStopBtn.style.backgroundColor = "#ef4444";
      statusSpan.textContent = `üü¢ Generating test data at ${currentSpeed}x speed (${currentInterval}ms intervals)`;
      statusSpan.style.color = "#22c55e";
      
      // Generate data at variable speed based on currentSpeed
      dataGenerationInterval = setInterval(generateSingleDataPoint, currentInterval);
      
      // Generate first data point immediately
      generateSingleDataPoint();
    }

    function stopDataGeneration() {
      if (!isGenerating) return;
      
      isGenerating = false;
      const startStopBtn = document.getElementById("startStopBtn");
      const statusSpan = document.getElementById("generateStatus");
      
      if (dataGenerationInterval) {
        clearInterval(dataGenerationInterval);
        dataGenerationInterval = null;
      }
      
      startStopBtn.textContent = "‚ñ∂Ô∏è Start Test Data";
      startStopBtn.style.backgroundColor = "#38bdf8";
      statusSpan.textContent = "‚è∏Ô∏è Test data generation stopped";
      statusSpan.style.color = "#fbbf24";
      
      // Clear status message after 3 seconds
      setTimeout(() => {
        if (!isGenerating) statusSpan.textContent = "";
      }, 3000);
    }

    function toggleDataGeneration() {
      if (isGenerating) {
        stopDataGeneration();
      } else {
        startDataGeneration();
      }
    }

    function updateSpeed() {
      const speedSelect = document.getElementById("speedSelect");
      currentSpeed = parseFloat(speedSelect.value);
      
      // If data generation is running, restart with new speed
      if (isGenerating) {
        stopDataGeneration();
        startDataGeneration();
      }
    }

    async function clearTestData() {
      const clearBtn = document.getElementById("clearBtn");
      const statusSpan = document.getElementById("generateStatus");
      
      // Stop data generation first
      if (isGenerating) {
        stopDataGeneration();
      }
      
      clearBtn.disabled = true;
      clearBtn.textContent = "üóëÔ∏è Clearing...";
      
      try {
        const response = await fetch("/clear_test_data", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }
        });
        
        const result = await response.json();
        
        if (result.status === "success") {
          statusSpan.textContent = "‚úÖ All test data cleared!";
          statusSpan.style.color = "#22c55e";
          // Clear status message after 3 seconds
          setTimeout(() => {
            statusSpan.textContent = "";
          }, 3000);
        } else {
          throw new Error(result.message || "Unknown error");
        }
      } catch (error) {
        statusSpan.textContent = "‚ùå Error clearing data";
        statusSpan.style.color = "#ef4444";
        console.error("Error clearing test data:", error);
      } finally {
        clearBtn.disabled = false;
        clearBtn.textContent = "üóëÔ∏è Clear Data";
      }
    }

    window.onload = () => {
      loadArchivedLogs();
      setInterval(fetchData, 1000);
    };
  </script>
</body>
</html>